<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>7th XCTF Final - Super Flagio | in1t's blog</title><meta name="keywords" content="逆向,Writeup"><meta name="author" content="in1t"><meta name="copyright" content="in1t"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="第七届 XCTF Final 逆向赛题 Super Flagio 出题人题解">
<meta property="og:type" content="article">
<meta property="og:title" content="7th XCTF Final - Super Flagio">
<meta property="og:url" content="https://in1t.top/2023/04/02/7th-XCTF-Final-Super-Flagio/index.html">
<meta property="og:site_name" content="in1t&#39;s blog">
<meta property="og:description" content="第七届 XCTF Final 逆向赛题 Super Flagio 出题人题解">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://in1t.top/img/cover/xctf2022.png">
<meta property="article:published_time" content="2023-04-02T13:25:43.000Z">
<meta property="article:modified_time" content="2023-04-02T13:35:38.017Z">
<meta property="article:author" content="in1t">
<meta property="article:tag" content="逆向">
<meta property="article:tag" content="Writeup">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://in1t.top/img/cover/xctf2022.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://in1t.top/2023/04/02/7th-XCTF-Final-Super-Flagio/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '7th XCTF Final - Super Flagio',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-04-02 21:35:38'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">45</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fas fa-play-circle"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cover/xctf2022.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">in1t's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fas fa-play-circle"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">7th XCTF Final - Super Flagio</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-04-02T13:25:43.000Z" title="发表于 2023-04-02 21:25:43">2023-04-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-02T13:35:38.017Z" title="更新于 2023-04-02 21:35:38">2023-04-02</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>55分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>本题基于 <a target="_blank" rel="noopener" href="https://github.com/xiedantibu/MarioKing.git">MarioKing</a> 仓库构建了一个单机马里奥手游，以顶计数砖块的形式接收玩家输入：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/get_input.jpg" alt="get_input"></p>
<p>以顶问号块的形式进行输入校验：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/start_check.jpg" alt="start_check"></p>
<p>如果输入正确，玩家可以获得一个增强力量的蘑菇，从而击败守护 flag 的板栗仔。本题的 flag 即为玩家的正确输入（上下两行的拼接）。</p>
<h2 id="出题视角"><a href="#出题视角" class="headerlink" title="出题视角"></a>出题视角</h2><p>游戏采用 cocos2d-x 引擎与 lua 语言开发，其中大部分的加密和混淆方式均取材自我不久前研究的一款国产手游。因为这些逆向对抗手段都比较有意思，也较为经典，所以就拿过来出题了。</p>
<h3 id="环境检测"><a href="#环境检测" class="headerlink" title="环境检测"></a>环境检测</h3><p>相信这个部分大家都见怪不怪了，加不加影响不大，所以不如加上（</p>
<p>首先是 Java 层，在 <code>org.cocos2dx.lua.AppActivity</code> <em>onCreate</em> 函数中调用的 <em>Cocos2dxUtil.lowEngineVersion</em> 用于检测设备是否被 root。</p>
<p>其次是 Native 层，<em>JNI_OnLoad</em> 中通过 <em>pthread_create</em> 创建环境监测线程，检查进程是否被调试、是否存在 IDA server 和 frida server。</p>
<h3 id="lua-脚本加密"><a href="#lua-脚本加密" class="headerlink" title="lua 脚本加密"></a>lua 脚本加密</h3><p>采用 cocos2d-x 引擎 lua-binding 开发的游戏逻辑代码并不直接存在于 Java 层或 Native 层中，而是作为资源文件存放在 apk 的 <code>assets</code> 目录下，因此有必要对明文的 lua 脚本进行加密处理。</p>
<h4 id="脚本编译"><a href="#脚本编译" class="headerlink" title="脚本编译"></a>脚本编译</h4><p>本题使用的 cocos2d-x 引擎版本为 3.17.2，该版本的 lua 引擎为 LuaJIT。将 lua 脚本预编译为 LuaJIT 可解释的 luac 字节码文件以防止源码泄露，是一种对抗逆向工程的经典策略。</p>
<p>本题也采用了这种策略，但是为了防止 luac 能被现有工具直接反编译，我还修改了 LuaJIT 解释器的 opcode 顺序。</p>
<h4 id="内容加密"><a href="#内容加密" class="headerlink" title="内容加密"></a>内容加密</h4><p>传统的 cocos2d-x luac 加密是通过游戏引擎自带的 xxtea 算法完成的，因为密钥找起来太容易，所以这种方式自然被舍弃。</p>
<p>在实现时，我定义了一种以 <code>FF FF DB EE</code> 为文件头的加密文件结构，并修改 cocos2d-x 引擎源码的<em>FileUtilsAndroid::getContents</em>，加入了相应的解密函数。</p>
<h4 id="名称混淆"><a href="#名称混淆" class="headerlink" title="名称混淆"></a>名称混淆</h4><p>cocos2d-x 的游戏脚本一般存放在 apk 的 <code>assets/src</code> 目录下，为了防止有意义的符号泄露信息，我将该目录下的所有文件名、目录名修改为它们原本名字的 xxhash 结果，并修改 cocos2d-x 引擎源码的 <em>FileUtils::fullPathForFilename</em>，加入了相应的字符串映射函数。</p>
<h3 id="其他处理"><a href="#其他处理" class="headerlink" title="其他处理"></a>其他处理</h3><ul>
<li>输入校验逻辑虚拟化（小型虚拟机）</li>
<li>Native 层去符号</li>
</ul>
<h2 id="获取明文-luac64-文件"><a href="#获取明文-luac64-文件" class="headerlink" title="获取明文 luac64 文件"></a>获取明文 luac64 文件</h2><p>在 IDA 字符串窗口搜索 <code>cocos2d-x-</code> 可以发现程序使用的 cocos2d-x 版本为 <strong>3.17.2</strong>：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/cocos2d_version.png" alt="cocos2d_version"></p>
<p>搜索 <code>LuaJIT</code> 可以发现程序使用的 LuaJIT 版本为 <strong>2.1.0-beta3</strong>：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/luajit_version.png" alt="luajit_version"></p>
<p>从 <a target="_blank" rel="noopener" href="https://github.com/LuaJIT/LuaJIT/tree/v2.1.0-beta3">LuaJIT-v2.1.0-beta3</a> 仓库下载源码，参考 <a target="_blank" rel="noopener" href="http://luajit.org/install.html">LuaJIT 官方文档</a> 的 <strong>Cross-compiling LuaJIT</strong> 部分，使用 android-ndk-r20b 编译一份 arm64 架构的 libluajit.so，再借助 IDA bindiff 插件即可还原 LuaJIT 引擎的关键符号。</p>
<p>完成上述操作后，在函数列表中搜索可以发现 <em>luaL_loadbuffer</em> 的地址为 0xAC4E9C，该函数的原型为 <code>LUALIB_API int luaL_loadbuffer(lua_State *L, const char *buf, size_t size, const char *name)</code>，第二个参数指向当前加载字节码文件的二进制内容，第三个参数指明 buf 的大小，第四个参数为模块路径名。</p>
<p>hook 该函数入口，打印第四个参数 name：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> lib_base = Module.findBaseAddress(<span class="string">&quot;libgame.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">Interceptor.attach(lib_base.add(<span class="number">0xAC4E9C</span>), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> chunk_name = args[<span class="number">3</span>].readCString();</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Load: &quot;</span> + chunk_name);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>程序打开后（游戏主菜单处）注入上方 js 脚本，并点击开始游戏，frida 端的输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Load: scene/GameScene.pyc</span><br><span class="line">Load: core/GameMap.pyc</span><br><span class="line">Load: entity/Enemy.pyc</span><br><span class="line">Load: entity/Mario.pyc</span><br></pre></td></tr></table></figure>

<p>当<strong>顶问号方块</strong>时，还会输出 <code>Load: core/Util.pyc</code>，因此输入校验逻辑应该与其相关。这里可以看到，所有的脚本后缀都是 <code>.pyc</code>，但其实通过搜索文件头前四个字节，可以发现其为 LuaJIT 字节码文件。</p>
<p>先将所有加载了的脚本 dump 出来，在 dump 的过程中，手动将文件后缀改为 <code>.luac64</code>（指代 LuaJIT 64 位字节码）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> base_dir = <span class="string">&quot;/data/data/cn.org.xctf.flagio/&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> lib_base = Module.findBaseAddress(<span class="string">&quot;libgame.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">Interceptor.attach(lib_base.add(<span class="number">0xAC4E9C</span>), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> chunk = args[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">var</span> chunk_size = args[<span class="number">2</span>].toInt32();</span><br><span class="line">        <span class="keyword">var</span> chunk_name = args[<span class="number">3</span>].readCString();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> new_name = chunk_name.slice(chunk_name.lastIndexOf(<span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>, -<span class="number">3</span>) + <span class="string">&quot;luac64&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> file = <span class="keyword">new</span> File(base_dir + new_name, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">        file.write(chunk.readByteArray(chunk_size));</span><br><span class="line">        file.close();</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>将文件移动到 /data/local/tmp 并赋予 777 权限后拉到本地即可获得明文的 luac64 文件：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/dump_bytecodes.png" alt="dump_bytecodes"></p>
<p>为什么说这些文件是 64 位而不是 32 位的呢？我们用 16 进制编辑器随便打开一个文件，它的前五个字节都是 <code>1B 4C 4A 02 0A</code>。而第五个字节的 0x0A 是 LuaJIT 文件结构中的 <code>GlobalHeader.flags</code> 字段，其二进制形式为 <code>1010</code>， 置位的两个比特位分别表示<strong>文件被去掉了符号</strong>（FLAG_IS_STRIPPED = 0b00000010）和<strong>采用</strong> <code>2-slot frame info</code> <strong>模式</strong>（FLAG_FR2 = 0b00001000），后者是 64 位引入的新特性，详情请参考 <a target="_blank" rel="noopener" href="https://github.com/LuaJIT/LuaJIT/issues/25">Finish LJ_GC64 mode</a>。</p>
<p>当然，你可以通过打印  <em>luaL_loadbuffer</em> 的调用栈往上追溯到关键解密函数 <em>sub_5035CC</em>，分析它的实现再写脚本解密 apk 的 <code>assets/src</code> 目录下的所有加密文件（或用其他方法主动调用）。不过这样做就复杂了，所以这里不作展开，仅给出 python 版的解密脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">block_size = <span class="number">4</span></span><br><span class="line">file_magic = <span class="string">b&quot;\xFF\xFF\xDB\xEE&quot;</span></span><br><span class="line"></span><br><span class="line">enc_tbl = [</span><br><span class="line">    <span class="number">0xc6bfb437</span>, <span class="number">0x8601dd6b</span>, <span class="number">0x9f6bdbea</span>, <span class="number">0xe3ec6fea</span>, <span class="number">0x9f6283a8</span>, <span class="number">0xd21da726</span>, <span class="number">0xc15ff083</span>, <span class="number">0x3dec6868</span>, <span class="number">0x53f4c551</span>, <span class="number">0x8cddfaeb</span>, <span class="number">0xf3c858de</span>, <span class="number">0xa5a3995d</span>, <span class="number">0x8ced646b</span>, <span class="number">0xde783524</span>, <span class="number">0x5f83b518</span>, <span class="number">0x20b1a8dc</span>, <span class="number">0x0095b96a</span>, <span class="number">0x1a7d641c</span>, <span class="number">0xf0b529e1</span>, <span class="number">0x17abf4ef</span>,</span><br><span class="line">    <span class="number">0x4ba44454</span>, <span class="number">0x24477765</span>, <span class="number">0x4f477d43</span>, <span class="number">0x13163da6</span>, <span class="number">0x1cfdc4b9</span>, <span class="number">0xc98feb0c</span>, <span class="number">0x1263e38c</span>, <span class="number">0x9214113b</span>, <span class="number">0x5530b57b</span>, <span class="number">0x97c9c907</span>, <span class="number">0x59c62012</span>, <span class="number">0x8ef987d2</span>, <span class="number">0xe9bc51c2</span>, <span class="number">0xde70b2f2</span>, <span class="number">0x3118de7a</span>, <span class="number">0x66dda446</span>, <span class="number">0xbabd9012</span>, <span class="number">0x881f794f</span>, <span class="number">0x52741f20</span>, <span class="number">0xdfc43ad9</span>,</span><br><span class="line">    <span class="number">0x16aff5ff</span>, <span class="number">0x4c133c12</span>, <span class="number">0x8594ac3e</span>, <span class="number">0xbf95602c</span>, <span class="number">0xd00badc9</span>, <span class="number">0x608c398d</span>, <span class="number">0x46ff9161</span>, <span class="number">0x3f00ecbd</span>, <span class="number">0xed3c0bdf</span>, <span class="number">0x77e37cc9</span>, <span class="number">0xe3c35119</span>, <span class="number">0x66d486fc</span>, <span class="number">0x3ee1a90d</span>, <span class="number">0x7ee04048</span>, <span class="number">0xbe254e4e</span>, <span class="number">0x9b7c0584</span>, <span class="number">0xe8b5d0f1</span>, <span class="number">0x168f6f7d</span>, <span class="number">0x8fa08863</span>, <span class="number">0xf734d73e</span>,</span><br><span class="line">    <span class="number">0x58e56b08</span>, <span class="number">0x6f179538</span>, <span class="number">0x47e0c609</span>, <span class="number">0x522e3e48</span>, <span class="number">0xb71b908f</span>, <span class="number">0x1db04b1a</span>, <span class="number">0x0dfb2e29</span>, <span class="number">0x9df3f71e</span>, <span class="number">0x73072a55</span>, <span class="number">0xe9d6d17c</span>, <span class="number">0xef17f00a</span>, <span class="number">0x4ff4a7ed</span>, <span class="number">0x6f11d3dd</span>, <span class="number">0xe57d4240</span>, <span class="number">0x730bdaf2</span>, <span class="number">0xbeb18cb2</span>, <span class="number">0x23f2a7b9</span>, <span class="number">0x88edc6e6</span>, <span class="number">0x7219fb97</span>, <span class="number">0x41152194</span>,</span><br><span class="line">    <span class="number">0x76cc5eb1</span>, <span class="number">0x22c7de91</span>, <span class="number">0x4186e4b3</span>, <span class="number">0x87efa1ae</span>, <span class="number">0x173a54e0</span>, <span class="number">0x8e49b7b4</span>, <span class="number">0xa3390d88</span>, <span class="number">0x9499f12e</span>, <span class="number">0x1e2f362a</span>, <span class="number">0xf92bda22</span>, <span class="number">0x133dcd2f</span>, <span class="number">0xb5bf7704</span>, <span class="number">0x133007a4</span>, <span class="number">0x677ea91c</span>, <span class="number">0x7ca51393</span>, <span class="number">0xb271661b</span>, <span class="number">0xb961496b</span>, <span class="number">0x7d37c903</span>, <span class="number">0x8f1baf38</span>, <span class="number">0x69a2ca9f</span>,</span><br><span class="line">    <span class="number">0xdeebcb61</span>, <span class="number">0x596bce09</span>, <span class="number">0x0a610760</span>, <span class="number">0x410896ce</span>, <span class="number">0x803f612a</span>, <span class="number">0xe17166f7</span>, <span class="number">0x6329e37e</span>, <span class="number">0x69676067</span>, <span class="number">0xcd15b586</span>, <span class="number">0x28a8262d</span>, <span class="number">0xe55f85c8</span>, <span class="number">0xe9b68a7e</span>, <span class="number">0xfe84fccf</span>, <span class="number">0xa568180b</span>, <span class="number">0x0a776072</span>, <span class="number">0x1fcc5ea0</span>, <span class="number">0x5237f259</span>, <span class="number">0x655cb945</span>, <span class="number">0x0ed0a769</span>, <span class="number">0x2ddfb75f</span>,</span><br><span class="line">    <span class="number">0x02ab9014</span>, <span class="number">0x60829de3</span>, <span class="number">0xce7d8582</span>, <span class="number">0xc7a0840e</span>, <span class="number">0x2db226de</span>, <span class="number">0x2f4d65b1</span>, <span class="number">0x3562407e</span>, <span class="number">0x6f60bb04</span>, <span class="number">0xd5bf4fac</span>, <span class="number">0x5c1b419a</span>, <span class="number">0x2e2aed20</span>, <span class="number">0x4ba278be</span>, <span class="number">0xe5826e22</span>, <span class="number">0xf1719ad8</span>, <span class="number">0x8355c16a</span>, <span class="number">0x7f9c5099</span>, <span class="number">0xf81d43e8</span>, <span class="number">0x96d68a16</span>, <span class="number">0x51b4fbd6</span>, <span class="number">0xc5aba1a9</span>,</span><br><span class="line">    <span class="number">0x2906faaf</span>, <span class="number">0x08df650b</span>, <span class="number">0x8c2cf238</span>, <span class="number">0x47660236</span>, <span class="number">0x21284442</span>, <span class="number">0x1be465d3</span>, <span class="number">0x7b2f6118</span>, <span class="number">0xdd2c089d</span>, <span class="number">0xc70ab20d</span>, <span class="number">0x2164a83a</span>, <span class="number">0x6e718555</span>, <span class="number">0xc75ddbf1</span>, <span class="number">0x89fd68c1</span>, <span class="number">0xe4b4911e</span>, <span class="number">0x80d2f2b8</span>, <span class="number">0xd7e03857</span>, <span class="number">0xc40fc98c</span>, <span class="number">0x47a30b80</span>, <span class="number">0x94589a48</span>, <span class="number">0x3a55dd73</span>,</span><br><span class="line">    <span class="number">0xf935cd28</span>, <span class="number">0xa9ba2903</span>, <span class="number">0x078f8563</span>, <span class="number">0x3151d61b</span>, <span class="number">0xacde3d3e</span>, <span class="number">0xb8ecd154</span>, <span class="number">0x87c24b49</span>, <span class="number">0xb10a0678</span>, <span class="number">0x35cf9006</span>, <span class="number">0x2ae5a60b</span>, <span class="number">0xd7b0ef0e</span>, <span class="number">0xdab27594</span>, <span class="number">0x5407ef84</span>, <span class="number">0xe12ade07</span>, <span class="number">0xc3bb788b</span>, <span class="number">0x193e6187</span>, <span class="number">0xbe2d59b0</span>, <span class="number">0xf5f845eb</span>, <span class="number">0x52366e4f</span>, <span class="number">0x5135869b</span>,</span><br><span class="line">    <span class="number">0x343869c2</span>, <span class="number">0xec048a46</span>, <span class="number">0x0a0440c8</span>, <span class="number">0xafb3a1cc</span>, <span class="number">0x04db06f7</span>, <span class="number">0x1455dde2</span>, <span class="number">0x8b42b7a5</span>, <span class="number">0x33e04cba</span>, <span class="number">0xb6412b66</span>, <span class="number">0x729ee85c</span>, <span class="number">0xfadf7cde</span>, <span class="number">0xa14fcaf4</span>, <span class="number">0xa7b3121e</span>, <span class="number">0x2b01d813</span>, <span class="number">0x1be0c240</span>, <span class="number">0xc0a73eb8</span>, <span class="number">0xcc90e00f</span>, <span class="number">0x014b45c9</span>, <span class="number">0x86cbc26c</span>, <span class="number">0xb91f7d5e</span>,</span><br><span class="line">    <span class="number">0xb5172fd6</span>, <span class="number">0x9fe38ef7</span>, <span class="number">0x9b7f0bff</span>, <span class="number">0x6ae221c4</span>, <span class="number">0x69846e79</span>, <span class="number">0x8090ea82</span>, <span class="number">0x31e71cb4</span>, <span class="number">0x83e8e898</span>, <span class="number">0xab099975</span>, <span class="number">0x389f7b0c</span>, <span class="number">0xf0235da1</span>, <span class="number">0xa69496fa</span>, <span class="number">0xd19e910f</span>, <span class="number">0x1a44d0de</span>, <span class="number">0x163d1c84</span>, <span class="number">0x071de1bf</span>, <span class="number">0x9f827f9f</span>, <span class="number">0x13dcb3bc</span>, <span class="number">0x32f65cf8</span>, <span class="number">0x09082987</span>,</span><br><span class="line">    <span class="number">0xb6e29776</span>, <span class="number">0xb3d15d21</span>, <span class="number">0x02669d17</span>, <span class="number">0x4bd68fb6</span>, <span class="number">0xbe618152</span>, <span class="number">0x4cdbf269</span>, <span class="number">0x0e5e5c74</span>, <span class="number">0x6b505a5a</span>, <span class="number">0x31cf50fd</span>, <span class="number">0xa9cce485</span>, <span class="number">0x14518715</span>, <span class="number">0xc920e57c</span>, <span class="number">0xca7f0f8b</span>, <span class="number">0x7ab47b24</span>, <span class="number">0x2502b1bd</span>, <span class="number">0xcbe725d7</span>, <span class="number">0x1686ae0b</span>, <span class="number">0x76e8d3cc</span>, <span class="number">0x03e562cd</span>, <span class="number">0x47c27f90</span>,</span><br><span class="line">    <span class="number">0x0bf1ac9f</span>, <span class="number">0x7203e668</span>, <span class="number">0x12660dbe</span>, <span class="number">0xfa1754a0</span>, <span class="number">0x955de065</span>, <span class="number">0x1c5fcd6b</span>, <span class="number">0xeb5a16ac</span>, <span class="number">0x93a8f58a</span>, <span class="number">0x757c8449</span>, <span class="number">0x086943af</span>, <span class="number">0x9e099367</span>, <span class="number">0x04d88f41</span>, <span class="number">0xf14da8c6</span>, <span class="number">0x5b014a71</span>, <span class="number">0x9f08ab6f</span>, <span class="number">0x546e02c5</span>, <span class="number">0xaa839216</span>, <span class="number">0x163623d3</span>, <span class="number">0xb77e2262</span>, <span class="number">0x1ec0d6af</span>,</span><br><span class="line">    <span class="number">0x322e2556</span>, <span class="number">0xd8efe2a8</span>, <span class="number">0xa84791fb</span>, <span class="number">0x6579b782</span>, <span class="number">0x76ec0831</span>, <span class="number">0x563924e4</span>, <span class="number">0x52a367d9</span>, <span class="number">0x8e4f672f</span>, <span class="number">0xe7f0190a</span>, <span class="number">0xca685659</span>, <span class="number">0x5c558d20</span>, <span class="number">0xc6609bf8</span>, <span class="number">0xa2fe64eb</span>, <span class="number">0xcc6c308c</span>, <span class="number">0x3b5f7fb3</span>, <span class="number">0x6f113528</span>, <span class="number">0xd150f04c</span>, <span class="number">0x1db84f0d</span>, <span class="number">0x9f0c40d0</span>, <span class="number">0xff9dda06</span>,</span><br><span class="line">    <span class="number">0x40b986f7</span>, <span class="number">0x652f5c98</span>, <span class="number">0x2d5d424f</span>, <span class="number">0xd508779c</span>, <span class="number">0xce2cefea</span>, <span class="number">0x408c40c1</span>, <span class="number">0xac2add9b</span>, <span class="number">0x401bf9e5</span>, <span class="number">0x4ec635fa</span>, <span class="number">0xbe2039a7</span>, <span class="number">0x2fa7b7c3</span>, <span class="number">0xe8d5e764</span>, <span class="number">0x94685963</span>, <span class="number">0x287d0a85</span>, <span class="number">0xd37e1c7e</span>, <span class="number">0xc50e60ce</span>, <span class="number">0xd936baa0</span>, <span class="number">0x60d2f38b</span>, <span class="number">0x0a631af7</span>, <span class="number">0xe6098986</span>,</span><br><span class="line">    <span class="number">0x736621df</span>, <span class="number">0x5ab72072</span>, <span class="number">0x1b3ccc30</span>, <span class="number">0xece32f2d</span>, <span class="number">0xcb7e8e6a</span>, <span class="number">0x46accdc1</span>, <span class="number">0xb3ee9a55</span>, <span class="number">0x651b7664</span>, <span class="number">0xb8dc21a3</span>, <span class="number">0x59eb5f92</span>, <span class="number">0x0d719c43</span>, <span class="number">0x0177bbbc</span>, <span class="number">0xd8b65e50</span>, <span class="number">0xe49e3639</span>, <span class="number">0x8f43577a</span>, <span class="number">0xbf5fbaa2</span>, <span class="number">0x40529e13</span>, <span class="number">0x9ab9bc17</span>, <span class="number">0xe737dcac</span>, <span class="number">0xd0ffebba</span>,</span><br><span class="line">    <span class="number">0x1bd139b0</span>, <span class="number">0xbfb6b530</span>, <span class="number">0x7f119a22</span>, <span class="number">0x77b6ac03</span>, <span class="number">0x3da04c35</span>, <span class="number">0x3e5a8446</span>, <span class="number">0x4e1c5123</span>, <span class="number">0x14dba10e</span>, <span class="number">0xae8227a4</span>, <span class="number">0x7b7d1c1f</span>, <span class="number">0xd28cb72a</span>, <span class="number">0xfae9dabe</span>, <span class="number">0x8eeaec66</span>, <span class="number">0xadea7dad</span>, <span class="number">0x5ba21551</span>, <span class="number">0x15f1e4bb</span>, <span class="number">0x6cdc9cbc</span>, <span class="number">0xd1b50569</span>, <span class="number">0xa9fda62c</span>, <span class="number">0xb4a69d8e</span>,</span><br><span class="line">    <span class="number">0x8552f7b0</span>, <span class="number">0x0e5ab05d</span>, <span class="number">0x7afda900</span>, <span class="number">0x7160f49a</span>, <span class="number">0x9cd74a63</span>, <span class="number">0x6c8bd299</span>, <span class="number">0xaf11f097</span>, <span class="number">0x69baa295</span>, <span class="number">0xdcd99b1d</span>, <span class="number">0x36467f3a</span>, <span class="number">0xbb8a82a6</span>, <span class="number">0x300ccd43</span>, <span class="number">0x78961a0c</span>, <span class="number">0xef6d7ab8</span>, <span class="number">0x20477213</span>, <span class="number">0x15b36dfb</span>, <span class="number">0x878d11e7</span>, <span class="number">0x7c026830</span>, <span class="number">0x923400a6</span>, <span class="number">0x68f97cfc</span>,</span><br><span class="line">    <span class="number">0xcc8492f8</span>, <span class="number">0x21c02cb1</span>, <span class="number">0xe6190991</span>, <span class="number">0xf0a15763</span>, <span class="number">0xb789f74b</span>, <span class="number">0x7cdef308</span>, <span class="number">0xd8452eef</span>, <span class="number">0x8f700ba2</span>, <span class="number">0x1f34c45e</span>, <span class="number">0xaeb19b7f</span>, <span class="number">0x6e4b1460</span>, <span class="number">0x6a77b90b</span>, <span class="number">0x168067b2</span>, <span class="number">0x739f3d63</span>, <span class="number">0x164a0031</span>, <span class="number">0xe5d9af44</span>, <span class="number">0x9fe6950f</span>, <span class="number">0xb3877e24</span>, <span class="number">0x787893b5</span>, <span class="number">0x52eeebbf</span>,</span><br><span class="line">    <span class="number">0x8119aab3</span>, <span class="number">0x9d71c82e</span>, <span class="number">0xaeddb512</span>, <span class="number">0xb2739605</span>, <span class="number">0x6de257c9</span>, <span class="number">0x2583e4ca</span>, <span class="number">0xae3efb2a</span>, <span class="number">0xcf70e8d8</span>, <span class="number">0x5f3bf373</span>, <span class="number">0x93720ba0</span>, <span class="number">0x3d7356f4</span>, <span class="number">0x074a5bfa</span>, <span class="number">0x86705c32</span>, <span class="number">0xc750b7e7</span>, <span class="number">0x1172dded</span>, <span class="number">0xf3691a33</span>, <span class="number">0x2ead9e77</span>, <span class="number">0x99c6d776</span>, <span class="number">0x971b630d</span>, <span class="number">0x3119628c</span>,</span><br><span class="line">    <span class="number">0x71b7175b</span>, <span class="number">0x3c7fc6b5</span>, <span class="number">0x7176c0bc</span>, <span class="number">0xfdfa123c</span>, <span class="number">0x6869b5e1</span>, <span class="number">0x567d3e0a</span>, <span class="number">0xb63f1c8e</span>, <span class="number">0x86a509fb</span>, <span class="number">0x0350e36a</span>, <span class="number">0xe683b1ba</span>, <span class="number">0xc8573667</span>, <span class="number">0xb5d68412</span>, <span class="number">0x0f0ca321</span>, <span class="number">0x1b2f93c4</span>, <span class="number">0xc366d743</span>, <span class="number">0xa75f5f1f</span>, <span class="number">0x6bd30415</span>, <span class="number">0x578e1228</span>, <span class="number">0x9ad7e1de</span>, <span class="number">0xdd923625</span>,</span><br><span class="line">    <span class="number">0xb5c6960d</span>, <span class="number">0x839e8c6b</span>, <span class="number">0xb79da6a8</span>, <span class="number">0x5d516c96</span>, <span class="number">0x3e031138</span>, <span class="number">0xc26a69b5</span>, <span class="number">0x71e02b2a</span>, <span class="number">0x83d5badf</span>, <span class="number">0x3f10bcda</span>, <span class="number">0x5cd27b7b</span>, <span class="number">0xc1b7327b</span>, <span class="number">0xb2b1fc19</span>, <span class="number">0xb5da9c7c</span>, <span class="number">0x9e6c6788</span>, <span class="number">0x2c48de6c</span>, <span class="number">0x0acbf365</span>, <span class="number">0x901e38fe</span>, <span class="number">0x76301365</span>, <span class="number">0x22ee70e6</span>, <span class="number">0x76b31faf</span>,</span><br><span class="line">    <span class="number">0x86c404b6</span>, <span class="number">0xb233216d</span>, <span class="number">0x3031b902</span>, <span class="number">0x61cce2a6</span>, <span class="number">0xebaa334b</span>, <span class="number">0x7ca20c9c</span>, <span class="number">0x0925a9cf</span>, <span class="number">0xc6ba2e40</span>, <span class="number">0xa39f3b34</span>, <span class="number">0x7da5c1a1</span>, <span class="number">0xa6e137ae</span>, <span class="number">0xdc517135</span>, <span class="number">0x29e9606b</span>, <span class="number">0x7ba0e387</span>, <span class="number">0x30511df0</span>, <span class="number">0xa1c85fc9</span>, <span class="number">0xdf3a9378</span>, <span class="number">0x60cd580c</span>, <span class="number">0x375adb50</span>, <span class="number">0x6ddc4bc0</span>,</span><br><span class="line">    <span class="number">0x2cd369d4</span>, <span class="number">0x8c6af18d</span>, <span class="number">0x65849d8a</span>, <span class="number">0x1badd1c3</span>, <span class="number">0x5318ad5c</span>, <span class="number">0xefcf5a8c</span>, <span class="number">0x353c1838</span>, <span class="number">0xa1ee6742</span>, <span class="number">0xff578c6d</span>, <span class="number">0x6feed6cc</span>, <span class="number">0x916cdd96</span>, <span class="number">0x2207e0d3</span>, <span class="number">0xb509a85c</span>, <span class="number">0xac18ddf6</span>, <span class="number">0xe6035b44</span>, <span class="number">0x58f262b5</span>, <span class="number">0x255ee071</span>, <span class="number">0x7e4fbd36</span>, <span class="number">0x5701bb1c</span>, <span class="number">0x70d05c02</span>,</span><br><span class="line">    <span class="number">0x6b04c60a</span>, <span class="number">0x119ff091</span>, <span class="number">0x7de77c28</span>, <span class="number">0x01ea0beb</span>, <span class="number">0xffa2012e</span>, <span class="number">0xcd289b5f</span>, <span class="number">0x8cb81969</span>, <span class="number">0x38ae5b48</span>, <span class="number">0x2de87535</span>, <span class="number">0x2c5f4e7a</span>, <span class="number">0xdd37d2e0</span>, <span class="number">0x7b321056</span>, <span class="number">0x073afded</span>, <span class="number">0xddba0425</span>, <span class="number">0x103f5785</span>, <span class="number">0x9c7751dd</span>, <span class="number">0x5b2f0227</span>, <span class="number">0x96d6a165</span>, <span class="number">0x8aa4f0c1</span>, <span class="number">0x4a9c9e92</span>,</span><br><span class="line">    <span class="number">0x8a09df65</span>, <span class="number">0x706839b6</span>, <span class="number">0x7e148267</span>, <span class="number">0x07c2b26f</span>, <span class="number">0x50573df4</span>, <span class="number">0x27ec1fe2</span>, <span class="number">0xddbed1b6</span>, <span class="number">0x3025b059</span>, <span class="number">0x5ea770b6</span>, <span class="number">0x6f36fccb</span>, <span class="number">0xfaca270c</span>, <span class="number">0x8aa5738f</span>, <span class="number">0xb43322a9</span>, <span class="number">0xeb081caa</span>, <span class="number">0x4ec2902a</span>, <span class="number">0x25cd3eea</span>, <span class="number">0xf7fbc7c8</span>, <span class="number">0x7df412f0</span>, <span class="number">0x65bbff82</span>, <span class="number">0x3df15d68</span>,</span><br><span class="line">    <span class="number">0xa2952aed</span>, <span class="number">0x385845c4</span>, <span class="number">0xcd00c3b2</span>, <span class="number">0xcb041ee3</span>, <span class="number">0xc067ba13</span>, <span class="number">0xc1a00e99</span>, <span class="number">0x18b3ecfa</span>, <span class="number">0xe05be99e</span>, <span class="number">0x2b5793b7</span>, <span class="number">0xf8c1e25b</span>, <span class="number">0xff4d0214</span>, <span class="number">0x184f1919</span>, <span class="number">0x48c62d8a</span>, <span class="number">0x54696b77</span>, <span class="number">0xeb358643</span>, <span class="number">0x7b26489e</span>, <span class="number">0x74f64703</span>, <span class="number">0x20581ac2</span>, <span class="number">0x86a3a152</span>, <span class="number">0xd91e6385</span>,</span><br><span class="line">    <span class="number">0x0ddf82cf</span>, <span class="number">0x1b2b8787</span>, <span class="number">0x9d656c97</span>, <span class="number">0x2b35f5a4</span>, <span class="number">0x8009457c</span>, <span class="number">0x34b5625b</span>, <span class="number">0x91f6bf53</span>, <span class="number">0x092c2469</span>, <span class="number">0x49bb878c</span>, <span class="number">0x67bddbdd</span>, <span class="number">0x7808a8f4</span>, <span class="number">0x06bab5d8</span>, <span class="number">0xf1052269</span>, <span class="number">0x1c4dc31c</span>, <span class="number">0x41f4cd77</span>, <span class="number">0x7428fdef</span>, <span class="number">0x35ddabda</span>, <span class="number">0xae48e659</span>, <span class="number">0xde331397</span>, <span class="number">0xa75ef097</span>,</span><br><span class="line">    <span class="number">0x8ee510a2</span>, <span class="number">0x3f1a42e3</span>, <span class="number">0x36411ad6</span>, <span class="number">0x5c3bb01d</span>, <span class="number">0xb64090a1</span>, <span class="number">0x89e36f7b</span>, <span class="number">0x623708aa</span>, <span class="number">0xfdf4ed1c</span>, <span class="number">0xf714506f</span>, <span class="number">0x2a582445</span>, <span class="number">0x2fcf3401</span>, <span class="number">0x5d6ab83f</span>, <span class="number">0xa685d2af</span>, <span class="number">0xd59b0022</span>, <span class="number">0x158f52da</span>, <span class="number">0x8795a624</span>, <span class="number">0x0f069f3d</span>, <span class="number">0x01ea335b</span>, <span class="number">0x9fa22d71</span>, <span class="number">0x486a4e95</span>,</span><br><span class="line">    <span class="number">0x256ca29a</span>, <span class="number">0x84e10604</span>, <span class="number">0x3c60c902</span>, <span class="number">0xc6b2092c</span>, <span class="number">0xb684090e</span>, <span class="number">0x4989b96a</span>, <span class="number">0x96bce509</span>, <span class="number">0xfaa0f229</span>, <span class="number">0x3220aae8</span>, <span class="number">0x5cb9ced1</span>, <span class="number">0x75e864b0</span>, <span class="number">0xdd116efd</span>, <span class="number">0xa608ec2d</span>, <span class="number">0xf51d3e1c</span>, <span class="number">0xfc548a6e</span>, <span class="number">0x08175bd2</span>, <span class="number">0x044729d5</span>, <span class="number">0x4d1bed73</span>, <span class="number">0xd8b9c5e3</span>, <span class="number">0x52ae7c1b</span>,</span><br><span class="line">    <span class="number">0x946622c5</span>, <span class="number">0x512bb583</span>, <span class="number">0xd3c1d5f5</span>, <span class="number">0x412c4de0</span>, <span class="number">0xdb6a7e5e</span>, <span class="number">0xfbe6fee0</span>, <span class="number">0x59fcd7c7</span>, <span class="number">0x59132cc9</span>, <span class="number">0xf38ea2df</span>, <span class="number">0xf114c426</span>, <span class="number">0x8e686f80</span>, <span class="number">0x1b8c0c33</span>, <span class="number">0x2e954e26</span>, <span class="number">0xfeac08ad</span>, <span class="number">0x70c35e70</span>, <span class="number">0x52442023</span>, <span class="number">0xed58707c</span>, <span class="number">0x7839e1b8</span>, <span class="number">0xf7944491</span>, <span class="number">0xbdbf75dc</span>,</span><br><span class="line">    <span class="number">0x6b68cb1b</span>, <span class="number">0xde45390b</span>, <span class="number">0x9b4b98ed</span>, <span class="number">0x10f33556</span>, <span class="number">0xdb7ec13f</span>, <span class="number">0xbd359844</span>, <span class="number">0x35c36bdb</span>, <span class="number">0x1e6a6a68</span>, <span class="number">0xeedc3b19</span>, <span class="number">0xc0ce9ebd</span>, <span class="number">0xda077d0c</span>, <span class="number">0x97513627</span>, <span class="number">0xbe2ab4a8</span>, <span class="number">0x82416ff9</span>, <span class="number">0x0cd5bd78</span>, <span class="number">0xad41b27f</span>, <span class="number">0xa3b4c5e8</span>, <span class="number">0x4dd1e832</span>, <span class="number">0x53c6bdbe</span>, <span class="number">0xcc6ab880</span>,</span><br><span class="line">    <span class="number">0xce947057</span>, <span class="number">0xb8f9161a</span>, <span class="number">0x668eda53</span>, <span class="number">0xa85834eb</span>, <span class="number">0xa6df8924</span>, <span class="number">0x1da9e9ae</span>, <span class="number">0x052a3c9d</span>, <span class="number">0x65aad5f4</span>, <span class="number">0xacdcf2cf</span>, <span class="number">0x98974b21</span>, <span class="number">0xee583d8b</span>, <span class="number">0xd7686039</span>, <span class="number">0x69c32a05</span>, <span class="number">0x807ef23a</span>, <span class="number">0x22d9756b</span>, <span class="number">0x4854feaf</span>, <span class="number">0x720e05e0</span>, <span class="number">0xe6175b72</span>, <span class="number">0x9149f2bd</span>, <span class="number">0xa4482834</span>,</span><br><span class="line">    <span class="number">0xe2fe8618</span>, <span class="number">0x4ca97bdc</span>, <span class="number">0x3a609ceb</span>, <span class="number">0xa2c60972</span>, <span class="number">0x2fc23750</span>, <span class="number">0x5ba701d5</span>, <span class="number">0x4c86d7b7</span>, <span class="number">0x19b87d79</span>, <span class="number">0xc92ca13b</span>, <span class="number">0x334795a8</span>, <span class="number">0x64b38fd4</span>, <span class="number">0x97273086</span>, <span class="number">0x34bdfed6</span>, <span class="number">0x88f62637</span>, <span class="number">0x46914256</span>, <span class="number">0x2f04690b</span>, <span class="number">0xa5a3edaa</span>, <span class="number">0x3185b7ab</span>, <span class="number">0x35790aad</span>, <span class="number">0xda58400d</span>,</span><br><span class="line">    <span class="number">0xd54655e4</span>, <span class="number">0x4a4ac79c</span>, <span class="number">0x139d026e</span>, <span class="number">0xce9b6d44</span>, <span class="number">0x8651fa21</span>, <span class="number">0xb8000ecf</span>, <span class="number">0x87988316</span>, <span class="number">0x1541eec9</span>, <span class="number">0xb5fb5189</span>, <span class="number">0x689af174</span>, <span class="number">0xbd2eeb22</span>, <span class="number">0x72051645</span>, <span class="number">0xaed24488</span>, <span class="number">0xc6794fbb</span>, <span class="number">0x00f2e376</span>, <span class="number">0x54f9e4ec</span>, <span class="number">0xede0cba2</span>, <span class="number">0xea613503</span>, <span class="number">0xcb433dc0</span>, <span class="number">0xc58bda4f</span>,</span><br><span class="line">    <span class="number">0x365b983e</span>, <span class="number">0x1451bc20</span>, <span class="number">0xc2b18a7d</span>, <span class="number">0xc65ed5bd</span>, <span class="number">0x33374784</span>, <span class="number">0xfdf37490</span>, <span class="number">0x07bff8d0</span>, <span class="number">0x5e118f5c</span>, <span class="number">0xfb18b6fb</span>, <span class="number">0xe09af302</span>, <span class="number">0x496b0dc1</span>, <span class="number">0x5235e5d7</span>, <span class="number">0x6ecb2112</span>, <span class="number">0xd0183177</span>, <span class="number">0x783720c3</span>, <span class="number">0xa185067c</span>, <span class="number">0xdc9b4381</span>, <span class="number">0x4ad1cf10</span>, <span class="number">0x433ad32c</span>, <span class="number">0x1aa35a53</span>,</span><br><span class="line">    <span class="number">0xb3460aac</span>, <span class="number">0xd12b6892</span>, <span class="number">0x44349f2d</span>, <span class="number">0x1f3ffb7a</span>, <span class="number">0x2924f758</span>, <span class="number">0x1883702e</span>, <span class="number">0x6df6ca0e</span>, <span class="number">0x4e82e9bd</span>, <span class="number">0x037b0c08</span>, <span class="number">0xb4c0afdd</span>, <span class="number">0x5edf7c3f</span>, <span class="number">0xf70b8df5</span>, <span class="number">0xb494c0a7</span>, <span class="number">0x47319505</span>, <span class="number">0xac6b8125</span>, <span class="number">0x57d78aa9</span>, <span class="number">0x4a1f64fc</span>, <span class="number">0x944be247</span>, <span class="number">0xae158c49</span>, <span class="number">0x10b405ef</span>,</span><br><span class="line">    <span class="number">0x0ca7f623</span>, <span class="number">0x6c00241a</span>, <span class="number">0x1c0bbaa3</span>, <span class="number">0xb846b675</span>, <span class="number">0x1b89d58d</span>, <span class="number">0x77e4d271</span>, <span class="number">0x7c96f2d5</span>, <span class="number">0x13f8280b</span>, <span class="number">0x5cf84d45</span>, <span class="number">0x16b51699</span>, <span class="number">0xacb454c9</span>, <span class="number">0x8b27dbd2</span>, <span class="number">0xd5c82535</span>, <span class="number">0xd51d9d1a</span>, <span class="number">0x54b628d2</span>, <span class="number">0xa132316a</span>, <span class="number">0xa55a3586</span>, <span class="number">0x6f948e0f</span>, <span class="number">0x4df05295</span>, <span class="number">0xbf64f4b9</span>,</span><br><span class="line">    <span class="number">0x58689f93</span>, <span class="number">0x39a85648</span>, <span class="number">0xa3dedaec</span>, <span class="number">0x911158c4</span>, <span class="number">0x3c92bf0d</span>, <span class="number">0x9e348fe6</span>, <span class="number">0xd9cb180d</span>, <span class="number">0x97ebec50</span>, <span class="number">0x78b83de9</span>, <span class="number">0x73ec6c48</span>, <span class="number">0x6b7b4b63</span>, <span class="number">0x16aa6ba8</span>, <span class="number">0xa2039a01</span>, <span class="number">0x804b4464</span>, <span class="number">0x68942114</span>, <span class="number">0xa8dd6a02</span>, <span class="number">0x0d80029f</span>, <span class="number">0x374c2cbf</span>, <span class="number">0xfb353d8c</span>, <span class="number">0x3324161b</span>,</span><br><span class="line">    <span class="number">0x0d2757de</span>, <span class="number">0x7f491efb</span>, <span class="number">0xb4456140</span>, <span class="number">0x3ffe2164</span>, <span class="number">0x9c967463</span>, <span class="number">0x27f7b5b8</span>, <span class="number">0xca0cd170</span>, <span class="number">0x044f53a4</span>, <span class="number">0x893563e7</span>, <span class="number">0xedbce4d8</span>, <span class="number">0x021b5414</span>, <span class="number">0x4a46b308</span>, <span class="number">0x5ab79e4a</span>, <span class="number">0x554f4a3f</span>, <span class="number">0xe4db258e</span>, <span class="number">0x7af947a4</span>, <span class="number">0x079e4882</span>, <span class="number">0x7ca6cf87</span>, <span class="number">0x8039be38</span>, <span class="number">0xdf33dc9a</span>,</span><br><span class="line">    <span class="number">0xeea9b4e7</span>, <span class="number">0x0910e3b0</span>, <span class="number">0x579762f8</span>, <span class="number">0x7cafa12c</span>, <span class="number">0x2bafb910</span>, <span class="number">0x355e70bf</span>, <span class="number">0x95982c0e</span>, <span class="number">0xb5fa17b3</span>, <span class="number">0xcddbbfff</span>, <span class="number">0xbe459e56</span>, <span class="number">0xb10af261</span>, <span class="number">0x5c2a2af1</span>, <span class="number">0x4eee8c3a</span>, <span class="number">0x65d14d8a</span>, <span class="number">0x95897345</span>, <span class="number">0x7a4a7fd8</span>, <span class="number">0x6cc41bec</span>, <span class="number">0x7dec212c</span>, <span class="number">0xc0ea7b93</span>, <span class="number">0x6b57d950</span>,</span><br><span class="line">    <span class="number">0xf16b98fd</span>, <span class="number">0xcdbc3491</span>, <span class="number">0x02d35ee0</span>, <span class="number">0xb1aba563</span>, <span class="number">0x2ad6fa58</span>, <span class="number">0x194b1e34</span>, <span class="number">0x89087286</span>, <span class="number">0x3d3ccca1</span>, <span class="number">0xb9fdf788</span>, <span class="number">0xf1e30c50</span>, <span class="number">0x5729a64b</span>, <span class="number">0x0a5befc6</span>, <span class="number">0x1f76c0b2</span>, <span class="number">0x3e77ea9d</span>, <span class="number">0x8a355c32</span>, <span class="number">0xdf45cd17</span>, <span class="number">0x985e31a6</span>, <span class="number">0xd29a51ca</span>, <span class="number">0x56f0b429</span>, <span class="number">0x042d4a8c</span>,</span><br><span class="line">    <span class="number">0xdd765852</span>, <span class="number">0x63715628</span>, <span class="number">0x738cebe6</span>, <span class="number">0xfc2df4b1</span>, <span class="number">0x9b5ba9d6</span>, <span class="number">0x96f78f67</span>, <span class="number">0xcc2e210f</span>, <span class="number">0x9c6d611a</span>, <span class="number">0x366d6791</span>, <span class="number">0x9a43361c</span>, <span class="number">0x5fb81ec9</span>, <span class="number">0xb9fe6794</span>, <span class="number">0x7375d302</span>, <span class="number">0xc62fa818</span>, <span class="number">0xcc6e19ae</span>, <span class="number">0x2f4d38de</span>, <span class="number">0xd0010ed6</span>, <span class="number">0xae25aae8</span>, <span class="number">0xca30036e</span>, <span class="number">0xd615450a</span>,</span><br><span class="line">    <span class="number">0xf244f954</span>, <span class="number">0x82959369</span>, <span class="number">0x7031c12f</span>, <span class="number">0x5933a6dd</span>, <span class="number">0x1169558f</span>, <span class="number">0x2b2ee00b</span>, <span class="number">0x6f89f242</span>, <span class="number">0x14149c3e</span>, <span class="number">0xee2fa1b1</span>, <span class="number">0xaa020888</span>, <span class="number">0x5285bcbe</span>, <span class="number">0x6b1a451d</span>, <span class="number">0x17c862ac</span>, <span class="number">0x677a7201</span>, <span class="number">0xaae07dfa</span>, <span class="number">0x61daeaa5</span>, <span class="number">0x0d4fb80e</span>, <span class="number">0x7d74345f</span>, <span class="number">0xc512b3bb</span>, <span class="number">0x566bb4d0</span>,</span><br><span class="line">    <span class="number">0x06c69771</span>, <span class="number">0xe4955e92</span>, <span class="number">0xe2b5d04d</span>, <span class="number">0x5df4ee34</span>, <span class="number">0x3928168a</span>, <span class="number">0x48ed0c2a</span>, <span class="number">0xd7d95fe1</span>, <span class="number">0xf01c3264</span>, <span class="number">0x86cdc089</span>, <span class="number">0xa46b7cfb</span>, <span class="number">0x2fede941</span>, <span class="number">0x74ec18e2</span>, <span class="number">0x9d56e1cc</span>, <span class="number">0xcce5dc4c</span>, <span class="number">0xdbeabd6d</span>, <span class="number">0x9480971f</span>, <span class="number">0x786dcaa1</span>, <span class="number">0xad272375</span>, <span class="number">0x20003617</span>, <span class="number">0xe13ad0f6</span>,</span><br><span class="line">    <span class="number">0xf0d86596</span>, <span class="number">0xf61b898b</span>, <span class="number">0x2aac895a</span>, <span class="number">0x241aad94</span>, <span class="number">0x3da6a9a8</span>, <span class="number">0x6d0bc797</span>, <span class="number">0xa92e8a90</span>, <span class="number">0x6e737090</span>, <span class="number">0x82c35afa</span>, <span class="number">0xdea3a945</span>, <span class="number">0x2fd754bd</span>, <span class="number">0x7a23f110</span>, <span class="number">0xf0f1a2f0</span>, <span class="number">0xf17280a2</span>, <span class="number">0x3f1eda1c</span>, <span class="number">0x0f03ed4e</span>, <span class="number">0x3e02d44a</span>, <span class="number">0x6073f404</span>, <span class="number">0x026302c6</span>, <span class="number">0xf9aa2e7d</span>,</span><br><span class="line">    <span class="number">0x191eeded</span>, <span class="number">0x5857dfca</span>, <span class="number">0x4bd140d3</span>, <span class="number">0xe04e4969</span>, <span class="number">0xad0c6975</span>, <span class="number">0xdabc6526</span>, <span class="number">0x40db87f6</span>, <span class="number">0xd3fcb14d</span>, <span class="number">0x5f6733a7</span>, <span class="number">0xbdced7fd</span>, <span class="number">0x7fdf2471</span>, <span class="number">0x983bea50</span>, <span class="number">0x15ab4e1a</span>, <span class="number">0x408265c6</span>, <span class="number">0xb33b1df3</span>, <span class="number">0xfec4aae0</span>, <span class="number">0x299e846a</span>, <span class="number">0xd1a8f4aa</span>, <span class="number">0xbe72d405</span>, <span class="number">0x1ab0b5d1</span>,</span><br><span class="line">    <span class="number">0x5fb1b52d</span>, <span class="number">0x9232ccdb</span>, <span class="number">0xbbfd8112</span>, <span class="number">0xf7198310</span>, <span class="number">0xeab71190</span>, <span class="number">0x135fe561</span>, <span class="number">0xbe0dcc84</span>, <span class="number">0x17601c74</span>, <span class="number">0x31ac3a98</span>, <span class="number">0xd67ca4b6</span>, <span class="number">0x99f14711</span>, <span class="number">0x5475ba0b</span>, <span class="number">0xbc011f67</span>, <span class="number">0x7f84e0d5</span>, <span class="number">0x506acdb6</span>, <span class="number">0x47bc32d1</span>, <span class="number">0x807de61d</span>, <span class="number">0x889f6834</span>, <span class="number">0x13be14a7</span>, <span class="number">0xe55f0f4c</span>,</span><br><span class="line">    <span class="number">0x3289738b</span>, <span class="number">0xea35b862</span>, <span class="number">0x8a2cab9f</span>, <span class="number">0xf64f4dfc</span>, <span class="number">0x6e255608</span>, <span class="number">0x718a29c1</span>, <span class="number">0xe36ada40</span>, <span class="number">0x570d6a97</span>, <span class="number">0x661e616d</span>, <span class="number">0x68b69cd3</span>, <span class="number">0xd075c3f4</span>, <span class="number">0x71e9cfbd</span>, <span class="number">0x4ab3086b</span>, <span class="number">0xd8e2d945</span>, <span class="number">0x632a0c6e</span>, <span class="number">0xbe0e6145</span>, <span class="number">0xe60a45c9</span>, <span class="number">0x5467aa5a</span>, <span class="number">0x812dc36e</span>, <span class="number">0xc8ed5ed9</span>,</span><br><span class="line">    <span class="number">0xc2aa5ac8</span>, <span class="number">0xb7bee330</span>, <span class="number">0x2a0b5456</span>, <span class="number">0xf4246482</span>, <span class="number">0x0ceaf7d9</span>, <span class="number">0xcba5b9b5</span>, <span class="number">0x1edb9f9b</span>, <span class="number">0xff7feefd</span>, <span class="number">0x36599e26</span>, <span class="number">0x350db259</span>, <span class="number">0x3d16422e</span>, <span class="number">0xff94c0a0</span>, <span class="number">0x15a7185c</span>, <span class="number">0x333b4cef</span>, <span class="number">0x91481df8</span>, <span class="number">0x882c24b8</span>, <span class="number">0x9ffc1ff5</span>, <span class="number">0xdc64b9ba</span>, <span class="number">0x0cb8510c</span>, <span class="number">0xfb68492d</span>,</span><br><span class="line">    <span class="number">0x41d8f2a2</span>, <span class="number">0xeebe9afd</span>, <span class="number">0x7d1de998</span>, <span class="number">0xd0a8aaf0</span>, <span class="number">0x1df9329a</span>, <span class="number">0xaf2cc29a</span>, <span class="number">0x07635562</span>, <span class="number">0xae187f03</span>, <span class="number">0x858d40da</span>, <span class="number">0x996462dd</span>, <span class="number">0x196b8b75</span>, <span class="number">0xbed95cda</span>, <span class="number">0xabe4ab1c</span>, <span class="number">0xd9fc2e50</span>, <span class="number">0xd59f74c8</span>, <span class="number">0x174bf4bc</span>, <span class="number">0xf8a5bd8a</span>, <span class="number">0x9b1b0756</span>, <span class="number">0x2747c3b8</span>, <span class="number">0x3145d4e1</span>,</span><br><span class="line">    <span class="number">0x3145d42a</span>, <span class="number">0xccfa3831</span>, <span class="number">0xc98fce4a</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_xor</span>(<span class="params">array: <span class="built_in">list</span>, nblocks: <span class="built_in">int</span></span>):</span></span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    idx2 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> idx &lt; nblocks <span class="keyword">and</span> idx &lt; <span class="number">0x200</span>:</span><br><span class="line">        array[idx] ^= enc_tbl[idx2]</span><br><span class="line">        idx2 = (idx2 + <span class="number">1</span>) % <span class="built_in">len</span>(enc_tbl)</span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> idx &lt; nblocks <span class="keyword">and</span> idx &lt; nblocks - <span class="number">0x200</span>:</span><br><span class="line">        array[idx] ^= enc_tbl[idx2]</span><br><span class="line">        idx2 = (idx2 + <span class="number">1</span>) % <span class="built_in">len</span>(enc_tbl)</span><br><span class="line">        idx += <span class="number">4</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> idx &lt; nblocks:</span><br><span class="line">        array[idx] ^= enc_tbl[idx2]</span><br><span class="line">        idx2 = (idx2 + <span class="number">1</span>) % <span class="built_in">len</span>(enc_tbl)</span><br><span class="line">        idx += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt_file</span>(<span class="params">if_path: <span class="built_in">str</span>, of_path: <span class="built_in">str</span></span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(if_path, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data =  f.read()</span><br><span class="line">    <span class="keyword">assert</span> data[:<span class="number">4</span>] == file_magic</span><br><span class="line"></span><br><span class="line">    cipher = data[<span class="number">20</span>:]</span><br><span class="line">    compressed_size = <span class="built_in">len</span>(cipher)</span><br><span class="line">    nblocks = compressed_size // block_size</span><br><span class="line">    plain = [<span class="number">0</span>] * nblocks </span><br><span class="line">    target_crc, _, origin_size = struct.unpack(<span class="string">&quot;3I&quot;</span>, data[<span class="number">8</span>:<span class="number">20</span>])</span><br><span class="line">    <span class="keyword">assert</span> nblocks &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nblocks):</span><br><span class="line">        plain[i], = struct.unpack(<span class="string">&#x27;I&#x27;</span>, cipher[i*<span class="number">4</span>:(i+<span class="number">1</span>)*<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">    do_xor(plain, nblocks)</span><br><span class="line"></span><br><span class="line">    compressed = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nblocks):</span><br><span class="line">        compressed += struct.pack(<span class="string">&#x27;I&#x27;</span>, plain[i])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> compressed_size % block_size:</span><br><span class="line">        compressed += cipher[-(compressed_size % block_size):]</span><br><span class="line"></span><br><span class="line">    plain = zlib.decompress(compressed)</span><br><span class="line">    <span class="keyword">assert</span> zlib.crc32(plain) &amp; <span class="number">0xFFFFFFFF</span> == target_crc</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(of_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> g:</span><br><span class="line">        g.write(plain)</span><br><span class="line"></span><br><span class="line">decrypt_file(<span class="string">&quot;526018661&quot;</span>, <span class="string">&quot;Util.luac64&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="识别乱序-opcode"><a href="#识别乱序-opcode" class="headerlink" title="识别乱序 opcode"></a>识别乱序 opcode</h2><p>如果用现有反编译工具直接反编译得到的 luac64 文件，结果一定是不正确的，因为 LuaJIT 引擎的 opcode 顺序被修改了。这一板块主要介绍如何在 Native 层中识别并还原出引擎的 opcode 顺序。</p>
<p>在 <code>lj_obj.h</code> 文件中，我们可以找到 <strong>lua_State</strong> 结构体的定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Per-thread state object. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lua_State</span> &#123;</span></span><br><span class="line">  GCHeader;</span><br><span class="line">  <span class="keyword">uint8_t</span> dummy_ffid;	<span class="comment">/* Fake FF_C for curr_funcisL() on dummy frames. */</span></span><br><span class="line">  <span class="keyword">uint8_t</span> status;	<span class="comment">/* Thread status. */</span></span><br><span class="line">  MRef glref;		<span class="comment">/* Link to global state. */</span></span><br><span class="line">  GCRef gclist;		<span class="comment">/* GC chain. */</span></span><br><span class="line">  TValue *base;		<span class="comment">/* Base of currently executing function. */</span></span><br><span class="line">  TValue *top;		<span class="comment">/* First free slot in the stack. */</span></span><br><span class="line">  MRef maxstack;	<span class="comment">/* Last free slot in the stack. */</span></span><br><span class="line">  MRef <span class="built_in">stack</span>;		<span class="comment">/* Stack base. */</span></span><br><span class="line">  GCRef openupval;	<span class="comment">/* List of open upvalues in the stack. */</span></span><br><span class="line">  GCRef env;		<span class="comment">/* Thread environment (table of globals). */</span></span><br><span class="line">  <span class="keyword">void</span> *cframe;		<span class="comment">/* End of C stack frame chain. */</span></span><br><span class="line">  MSize stacksize;	<span class="comment">/* True stack size (incl. LJ_STACK_EXTRA). */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中 <code>glref</code> 字段指向了 <strong>global_State</strong> 结构体，顾名思义，其保存着 LuaJIT 的一些全局信息，由所有线程共享。但是我们无需去关心它的定义，因为我们感兴趣的字段不在这个结构体中，只是借助它来找到一个名为 <strong>GG_State</strong> 的结构体，后者保存着更为顶层的全局信息，其定义在 <code>lj_dispatch.h</code> 文件中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Global state, main thread and extra fields are allocated together. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">GG_State</span> &#123;</span></span><br><span class="line">  lua_State L;				<span class="comment">/* Main thread. */</span></span><br><span class="line">  global_State g;			<span class="comment">/* Global state. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LJ_TARGET_MIPS</span></span><br><span class="line">  ASMFunction got[LJ_GOT__MAX];		<span class="comment">/* Global offset table. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LJ_HASJIT</span></span><br><span class="line">  jit_State J;				<span class="comment">/* JIT state. */</span></span><br><span class="line">  HotCount hotcount[HOTCOUNT_SIZE];	<span class="comment">/* Hot counters. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  ASMFunction dispatch[GG_LEN_DISP];	<span class="comment">/* Instruction dispatch tables. */</span></span><br><span class="line">  BCIns bcff[GG_NUM_ASMFF];		<span class="comment">/* Bytecode for ASM fast functions. */</span></span><br><span class="line">&#125; GG_State;</span><br></pre></td></tr></table></figure>

<p>这里可以发现一个非常有意思的的字段 <code>dispatch</code>，后方的注释也告诉我们该数组是 LuaJIT 内部维护的一张指令跳转表，每条 LuaJIT 虚拟机指令都能在这个数组中找到对应的处理例程。</p>
<p>现在我们来研究一下 LuaJIT 是怎么取指令和译码分发的，搞清楚这个流程才能找到跳转表的位置，进而才能找到各指令的具体实现及它们的先后顺序。</p>
<p>不妨在 LuaJIT 源码中跟一下 <em>luaL_loadbuffer</em> 函数的实现，看看它到底是如何加载运行 LuaJIT 字节码的，该函数定义在 <code>lj_load.c</code> 文件中，下面一并列出相关函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LUALIB_API <span class="keyword">int</span> <span class="title">luaL_loadbuffer</span><span class="params">(lua_State *L, <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> luaL_loadbufferx(L, buf, size, name, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LUALIB_API <span class="keyword">int</span> <span class="title">luaL_loadbufferx</span><span class="params">(lua_State *L, <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  StringReaderCtx ctx;</span><br><span class="line">  ctx.str = buf;</span><br><span class="line">  ctx.size = size;</span><br><span class="line">  <span class="keyword">return</span> lua_loadx(L, reader_string, &amp;ctx, name, mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LUA_API <span class="keyword">int</span> <span class="title">lua_loadx</span><span class="params">(lua_State *L, lua_Reader reader, <span class="keyword">void</span> *data,</span></span></span><br><span class="line"><span class="params"><span class="function">		      <span class="keyword">const</span> <span class="keyword">char</span> *chunkname, <span class="keyword">const</span> <span class="keyword">char</span> *mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  LexState ls;</span><br><span class="line">  <span class="keyword">int</span> status;</span><br><span class="line">  ls.rfunc = reader;</span><br><span class="line">  ls.rdata = data;</span><br><span class="line">  ls.chunkarg = chunkname ? chunkname : <span class="string">&quot;?&quot;</span>;</span><br><span class="line">  ls.mode = mode;</span><br><span class="line">  lj_buf_init(L, &amp;ls.sb);</span><br><span class="line">  status = lj_vm_cpcall(L, <span class="literal">NULL</span>, &amp;ls, cpparser);</span><br><span class="line">  lj_lex_cleanup(L, &amp;ls);</span><br><span class="line">  lj_gc_check(L);</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不难发现，<em>luaL_loadbuffer</em> 内部在完成一些结构体的初始化工作后，实际通过 <em>lj_vm_cpcall</em> 函数来启动 LuaJIT 虚拟机，并且当前脚本运行结束后，会将状态码存放到局部变量 status 中。因此我们应该着重分析 <em>lj_vm_cpcall</em>。</p>
<p>这里插一句题外话，LuaJIT 为了追求虚拟机性能，特意使用汇编来书写 vm 的核心功能，其中包括取指令、译码执行等部分，并针对不同的架构定制了对应的 dasc 文件。本题的 so 是 arm64 架构，因此接下来的分析将基于 <code>vm_arm64.dasc</code> 文件。</p>
<p>在 <code>vm_arm64.dasc</code> 第 526 行可以找到 <em>lj_vm_cpcall</em> 的实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">|-&gt;vm_cpcall:				// Setup protected C frame, call C.</span><br><span class="line">|  // (lua_State *L, lua_CFunction func, void *ud, lua_CPFunction cp)</span><br><span class="line">|  saveregs</span><br><span class="line">|  mov L, CARG1</span><br><span class="line">|   ldr RA, L:CARG1-&gt;stack</span><br><span class="line">|  str CARG1, SAVE_L</span><br><span class="line">|    ldr GL, L-&gt;glref			// Setup pointer to global state.</span><br><span class="line">|   ldr RB, L-&gt;top</span><br><span class="line">|  str CARG1, SAVE_PC			// Any value outside of bytecode is ok.</span><br><span class="line">|  ldr RC, L-&gt;cframe</span><br><span class="line">|   sub RA, RA, RB			// Compute -savestack(L, L-&gt;top).</span><br><span class="line">|   str RAw, SAVE_NRES		// Neg. delta means cframe w/o frame.</span><br><span class="line">|  str wzr, SAVE_ERRF			// No error function.</span><br><span class="line">|  str RC, SAVE_CFRAME</span><br><span class="line">|  str fp, L-&gt;cframe			// Add our C frame to cframe chain.</span><br><span class="line">|    str L, GL-&gt;cur_L</span><br><span class="line">|  blr CARG4			// (lua_State *L, lua_CFunction func, void *ud)</span><br><span class="line">|  mov BASE, CRET1</span><br><span class="line">|   mov PC, #FRAME_CP</span><br><span class="line">|  cbnz BASE, &lt;3			// Else continue with the call.</span><br><span class="line">|  b -&gt;vm_leave_cp			// No base? Just remove C frame.</span><br></pre></td></tr></table></figure>

<p>其中有一句 <code>ldr GL, L-&gt;glref</code> 将 <strong>global_State</strong> 结构体地址赋值给 GL，GL 的定义如下，其实就是 x22 寄存器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|.define GLREG,		x22	// Global state.</span><br><span class="line">...</span><br><span class="line">|.type GL,		global_State,	GLREG</span><br></pre></td></tr></table></figure>

<p>接着程序正常执行，会通过 <code>cbnz BASE, &lt;3</code> 跳转到前面的 <code>标签 3</code> 处：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">|3:  // Entry point for vm_cpcall/vm_resume (BASE = base, PC = ftype).</span><br><span class="line">|  str L, GL-&gt;cur_L</span><br><span class="line">|  ldp RB, CARG1, L-&gt;base		// RB = old base (for vmeta_call).</span><br><span class="line">|    movz TISNUM, #(LJ_TISNUM&gt;&gt;1)&amp;0xffff, lsl #48</span><br><span class="line">|    movz TISNUMhi, #(LJ_TISNUM&gt;&gt;1)&amp;0xffff, lsl #16</span><br><span class="line">|  add PC, PC, BASE</span><br><span class="line">|    movn TISNIL, #0</span><br><span class="line">|  sub PC, PC, RB			// PC = frame delta + frame type</span><br><span class="line">|   sub NARGS8:RC, CARG1, BASE</span><br><span class="line">|    st_vmstate ST_INTERP</span><br><span class="line">|</span><br><span class="line">|-&gt;vm_call_dispatch:</span><br><span class="line">|  // RB = old base, BASE = new base, RC = nargs*8, PC = caller PC</span><br><span class="line">|  ldr CARG3, [BASE, FRAME_FUNC]</span><br><span class="line">|  checkfunc CARG3, -&gt;vmeta_call</span><br><span class="line">|</span><br><span class="line">|-&gt;vm_call_dispatch_f:</span><br><span class="line">|  ins_call</span><br></pre></td></tr></table></figure>

<p>在设置好一些虚拟机将用到的寄存器初值后（PC 等），通过 <em>ins_call</em> 宏正式开始第一条指令的解释执行。该宏被声明在 214 行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|.macro ins_call</span><br><span class="line">|  // BASE = new base, CARG3 = LFUNC/CFUNC, RC = nargs*8, PC = caller PC</span><br><span class="line">|  str PC, [BASE, FRAME_PC]</span><br><span class="line">|  ins_callt</span><br><span class="line">|.endmacro</span><br></pre></td></tr></table></figure>

<p>其中 <em>ins_callt</em> 也是一个宏定义，将其展开得到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">|.macro ins_call</span><br><span class="line">|  // BASE = new base, CARG3 = LFUNC/CFUNC, RC = nargs*8, PC = caller PC</span><br><span class="line">|  str PC, [BASE, FRAME_PC]</span><br><span class="line">|  ldr PC, LFUNC:CARG3-&gt;pc</span><br><span class="line">|  ldr INSw, [PC], #4</span><br><span class="line">|  add TMP1, GL, INS, uxtb #3</span><br><span class="line">|   decode_RA RA, INS</span><br><span class="line">|  ldr TMP0, [TMP1, #GG_G2DISP]</span><br><span class="line">|   add RA, BASE, RA, lsl #3</span><br><span class="line">|  br TMP0</span><br><span class="line">|.endmacro</span><br></pre></td></tr></table></figure>

<p><strong>取指令</strong>部分主要通过 <code>ldr INSw, [PC], #4</code> 实现，PC 和 INSw 都定义在了文件头，分别是 x21 和 w16 寄存器。这句汇编的意思就是从 x21 指向的空间里取来 32 bits 存放到 x16 的低四字节，然后 x21 自增 4（指向下一条指令），由此也可以得知 LuaJIT 采用定长指令集，每条指令长度为 4 字节。</p>
<p><strong>译码</strong>部分主要通过 <code>decode_RA RA, INS</code> 宏和 <code>add RA, BASE, RA, lsl #3</code> 来解析操作数（这个我们不关心），计算目标跳转地址的方式也终于在此处呈现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add TMP1, GL, INS, uxtb #3</span><br><span class="line">ldr TMP0, [TMP1, #GG_G2DISP]</span><br><span class="line">br TMP0</span><br></pre></td></tr></table></figure>

<p>这里的 TMP0 和 TMP1 分别是 x8 和 x9 寄存器，INS 就是 x16 寄存器。以上三条汇编可解释为：</p>
<ul>
<li><code>add TMP1, GL, INS, uxtb #3</code>：将 x16 的最低字节（opcode）无符号扩展到 32 位（uxtb）后，左移 3 位（乘 8），再加上 x22 （GL）赋值给 x9，即 <code>x9 = x22 + (((unsigned int)(x16 &amp; 0xFF)) &lt;&lt; 3) </code></li>
<li><code>ldr TMP0, [TMP1, #GG_G2DISP]</code>：从 x9 加上常数 #GG_G2DISP 后指向的地址空间里取出 8 字节放到 x8，此时的 x8 即为当前虚拟机指令的 opcode 所对应的处理例程地址</li>
<li><code>br TMP0</code> 跳转到处理例程去执行</li>
</ul>
<p>其中 <em>GG_G2DISP</em> 定义在 <code>lj_dispatch.h</code> 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">GG_State</span> &#123;</span></span><br><span class="line">  ...</span><br><span class="line">  global_State g;			<span class="comment">/* Global state. */</span></span><br><span class="line">  ...</span><br><span class="line">  ASMFunction dispatch[GG_LEN_DISP];	<span class="comment">/* Instruction dispatch tables. */</span></span><br><span class="line">  ...</span><br><span class="line">&#125; GG_State;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GG_OFS(field)	((int)offsetof(GG_State, field))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GG_G2DISP	(GG_OFS(dispatch) - GG_OFS(g))</span></span><br></pre></td></tr></table></figure>

<p>即 <strong>GG_State</strong> 结构体的 g 字段与 dispatch 字段的地址差值，该值可在 IDA 中查看，为 0xF30：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/GG_G2DISP.png" alt="GG_G2DISP"></p>
<p>因此，我们可以换一种顺序来理解上面的三条汇编。首先通过 GL 寄存器（x22）加上 0xF30 找到 dispatch 数组，该数组中每一项都是一个处理例程的指针（8 字节），元素的下标即为该处理例程对应的 opcode，在此基础上加上 <code>opcode * 8</code> 就能找到当前 opcode 的处理例程了。</p>
<p>另外，从 <code>lj_bc.h</code> 的 71 ~ 197 行我们可以得知 2.1.0-beta3 版的 LuaJIT 具有 97 种 opcode：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BCDEF(_) \</span></span><br><span class="line"><span class="meta">  <span class="comment">/* Comparison ops. ORDER OPR. */</span> \</span></span><br><span class="line"><span class="meta">  _(ISLT,	var,	___,	var,	lt) \</span></span><br><span class="line"><span class="meta">  _(ISGE,	var,	___,	var,	lt) \</span></span><br><span class="line"><span class="meta">  _(ISLE,	var,	___,	var,	le) \</span></span><br><span class="line"><span class="meta">  _(ISGT,	var,	___,	var,	le) \</span></span><br><span class="line"><span class="meta">  \</span></span><br><span class="line"><span class="meta">  _(ISEQV,	var,	___,	var,	eq) \</span></span><br><span class="line"><span class="meta">  _(ISNEV,	var,	___,	var,	eq) \</span></span><br><span class="line"><span class="meta">  ...  <span class="comment">// 篇幅原因，此处省略</span></span></span><br></pre></td></tr></table></figure>

<p>根据上述分析，我们可以编写 hook 脚本来读取这些处理例程在 so 中的地址：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> output = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> lib_base = Module.findBaseAddress(<span class="string">&quot;libgame.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">Interceptor.attach(lib_base.add(<span class="number">0xACFEF0</span>), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!output) &#123;</span><br><span class="line">            <span class="keyword">var</span> GL = <span class="built_in">this</span>.context.x22;</span><br><span class="line">            <span class="keyword">var</span> dispatch = GL.add(<span class="number">0xF30</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">97</span>; ++i) &#123;</span><br><span class="line">                <span class="keyword">var</span> prog_ptr = dispatch.add(i * <span class="number">8</span>).readPointer();</span><br><span class="line">                <span class="built_in">console</span>.log(prog_ptr.sub(lib_base));</span><br><span class="line">            &#125;</span><br><span class="line">            output = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>得到全部 97 种 opcode 的处理例程地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">0xacdaf0</span><br><span class="line">0xacdb70</span><br><span class="line">0xacdbf0</span><br><span class="line">0xacdc70</span><br><span class="line">0xacdcf0</span><br><span class="line">0xacdd74</span><br><span class="line">0xacddf4</span><br><span class="line">0xacde44</span><br><span class="line">0xacde94</span><br><span class="line">0xacdf20</span><br><span class="line">0xacdfac</span><br><span class="line">0xacdff0</span><br><span class="line">0xace034</span><br><span class="line">0xace060</span><br><span class="line">0xace08c</span><br><span class="line">0xace0b0</span><br><span class="line">0xace0d0</span><br><span class="line">0xace0f0</span><br><span class="line">0xace120</span><br><span class="line">0xace160</span><br><span class="line">0xace1a0</span><br><span class="line">0xace1d8</span><br><span class="line">0xace210</span><br><span class="line">0xace234</span><br><span class="line">0xace258</span><br><span class="line">0xace278</span><br><span class="line">0xace2a8</span><br><span class="line">0xace2ec</span><br><span class="line">0xace334</span><br><span class="line">0xace348</span><br><span class="line">0xace3f0</span><br><span class="line">0xace458</span><br><span class="line">0xace4c8</span><br><span class="line">0xace534</span><br><span class="line">0xace5a0</span><br><span class="line">0xace614</span><br><span class="line">0xace65c</span><br><span class="line">0xace6d0</span><br><span class="line">0xace73c</span><br><span class="line">0xace7a8</span><br><span class="line">0xace81c</span><br><span class="line">0xace864</span><br><span class="line">0xace8d8</span><br><span class="line">0xace944</span><br><span class="line">0xace9b0</span><br><span class="line">0xacea24</span><br><span class="line">0xacea6c</span><br><span class="line">0xaceae0</span><br><span class="line">0xaceb28</span><br><span class="line">0xaceb74</span><br><span class="line">0xaceba8</span><br><span class="line">0xacec18</span><br><span class="line">0xacec80</span><br><span class="line">0xacecb4</span><br><span class="line">0xacece8</span><br><span class="line">0xaced24</span><br><span class="line">0xaced6c</span><br><span class="line">0xacedcc</span><br><span class="line">0xacee20</span><br><span class="line">0xacee38</span><br><span class="line">0xacee50</span><br><span class="line">0xaceedc</span><br><span class="line">0xacef70</span><br><span class="line">0xacefdc</span><br><span class="line">0xacf024</span><br><span class="line">0xacf0d4</span><br><span class="line">0xacf1d0</span><br><span class="line">0xacf260</span><br><span class="line">0xacf2f4</span><br><span class="line">0xacf35c</span><br><span class="line">0xacf36c</span><br><span class="line">0xacf3b4</span><br><span class="line">0xacf3c0</span><br><span class="line">0xacf47c</span><br><span class="line">0xacf4cc</span><br><span class="line">0xacf570</span><br><span class="line">0xacf62c</span><br><span class="line">0xacf6a4</span><br><span class="line">0xacf734</span><br><span class="line">0xacf7d0</span><br><span class="line">0xacf7ec</span><br><span class="line">0xacf878</span><br><span class="line">0xacf8fc</span><br><span class="line">0xacf918</span><br><span class="line">0xacf94c</span><br><span class="line">0xacf97c</span><br><span class="line">0xacf998</span><br><span class="line">0xacf9b0</span><br><span class="line">0xacf9d4</span><br><span class="line">0xacf9f4</span><br><span class="line">0xacfa10</span><br><span class="line">0xacfa50</span><br><span class="line">0xacfa80</span><br><span class="line">0xacfa80</span><br><span class="line">0xacfb04</span><br><span class="line">0xacfb08</span><br><span class="line">0xacfb50</span><br></pre></td></tr></table></figure>

<p>接下来就是一个比较枯燥的过程了，我们需要对照源码 <code>vm_arm64.dasc</code> 在 IDA 中手动标识出上方 97 个地址所对应的 opcode（暂时没有想到自动化的标注方法，如果你有想法，欢迎交流）。具体的做法是从第一个地址开始，在源码的 <em>build_ins</em> 函数里找到汇编代码一致的 case，而后修改函数名为 opcode 名称。</p>
<p>这里以第二个地址为例，在 IDA 中可以看到一条 CSEL 汇编指令：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/BC_ISGE_ida.png" alt="BC_ISGE_ida"></p>
<p>对应到源码：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/BC_ISGE_src.png" alt="BC_ISGE_ida"></p>
<p>所以该函数为 <em>BC_ISGE</em> 的处理例程，同时在 IDA 中修改函数名为 <strong>BC_ISGE</strong>。以此类推，手动修改其余 96 个函数的名称。此过程中应注意源码各个 case 的判断条件并主动展开部分宏定义，IDA 没有识别出来的例程应自行新建函数。最终的部分修改结果展示如下：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/func_name_modified.png" alt="func_name_modified"></p>
<p>这样我们就将 opcode 的顺序找到了，下一步就该对之前 dump 下来的 luac64 文件进行反编译了。</p>
<h2 id="反编译-luac64-文件"><a href="#反编译-luac64-文件" class="headerlink" title="反编译 luac64 文件"></a>反编译 luac64 文件</h2><p>在 Github 上可以找到很多用于反编译 LuaJIT 字节码的工具，但是它们中的大多数对于 64 位 LuaJIT 的支持不是很好，普遍缺乏对于 <code>2-slot frame info</code> 模式的适配，在解析函数调用语句时会发生参数错位等的情况。</p>
<p>经过一系列尝试之后，我发现 <a target="_blank" rel="noopener" href="https://github.com/Dr-MTN/luajit-decompiler">luajit-decompiler</a> 项目的反编译效果较为优秀，我们只需要在其基础上修改部分代码使其适配新 opcode 顺序即可。</p>
<p>首先将项目代码 clone 下来，修改 <code>ljd/rawdump/luajit/v2_1/luajit_opcode.py</code> 中对于 <strong>_OPCODES</strong> 变量的赋值。借助上一个板块的分析结果和 IDAPython 脚本进行格式化输出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># run in IDA</span></span><br><span class="line">addrs = [</span><br><span class="line">    <span class="number">0xacdaf0</span>, <span class="number">0xacdb70</span>, <span class="number">0xacdbf0</span>, <span class="number">0xacdc70</span>, <span class="number">0xacdcf0</span>,</span><br><span class="line">    <span class="number">0xacdd74</span>, <span class="number">0xacddf4</span>, <span class="number">0xacde44</span>, <span class="number">0xacde94</span>, <span class="number">0xacdf20</span>,</span><br><span class="line">    <span class="number">0xacdfac</span>, <span class="number">0xacdff0</span>, <span class="number">0xace034</span>, <span class="number">0xace060</span>, <span class="number">0xace08c</span>,</span><br><span class="line">    <span class="number">0xace0b0</span>, <span class="number">0xace0d0</span>, <span class="number">0xace0f0</span>, <span class="number">0xace120</span>, <span class="number">0xace160</span>,</span><br><span class="line">    <span class="number">0xace1a0</span>, <span class="number">0xace1d8</span>, <span class="number">0xace210</span>, <span class="number">0xace234</span>, <span class="number">0xace258</span>,</span><br><span class="line">    <span class="number">0xace278</span>, <span class="number">0xace2a8</span>, <span class="number">0xace2ec</span>, <span class="number">0xace334</span>, <span class="number">0xace348</span>,</span><br><span class="line">    <span class="number">0xace3f0</span>, <span class="number">0xace458</span>, <span class="number">0xace4c8</span>, <span class="number">0xace534</span>, <span class="number">0xace5a0</span>,</span><br><span class="line">    <span class="number">0xace614</span>, <span class="number">0xace65c</span>, <span class="number">0xace6d0</span>, <span class="number">0xace73c</span>, <span class="number">0xace7a8</span>,</span><br><span class="line">    <span class="number">0xace81c</span>, <span class="number">0xace864</span>, <span class="number">0xace8d8</span>, <span class="number">0xace944</span>, <span class="number">0xace9b0</span>,</span><br><span class="line">    <span class="number">0xacea24</span>, <span class="number">0xacea6c</span>, <span class="number">0xaceae0</span>, <span class="number">0xaceb28</span>, <span class="number">0xaceb74</span>,</span><br><span class="line">    <span class="number">0xaceba8</span>, <span class="number">0xacec18</span>, <span class="number">0xacec80</span>, <span class="number">0xacecb4</span>, <span class="number">0xacece8</span>,</span><br><span class="line">    <span class="number">0xaced24</span>, <span class="number">0xaced6c</span>, <span class="number">0xacedcc</span>, <span class="number">0xacee20</span>, <span class="number">0xacee38</span>,</span><br><span class="line">    <span class="number">0xacee50</span>, <span class="number">0xaceedc</span>, <span class="number">0xacef70</span>, <span class="number">0xacefdc</span>, <span class="number">0xacf024</span>,</span><br><span class="line">    <span class="number">0xacf0d4</span>, <span class="number">0xacf1d0</span>, <span class="number">0xacf260</span>, <span class="number">0xacf2f4</span>, <span class="number">0xacf35c</span>,</span><br><span class="line">    <span class="number">0xacf36c</span>, <span class="number">0xacf3b4</span>, <span class="number">0xacf3c0</span>, <span class="number">0xacf47c</span>, <span class="number">0xacf4cc</span>,</span><br><span class="line">    <span class="number">0xacf570</span>, <span class="number">0xacf62c</span>, <span class="number">0xacf6a4</span>, <span class="number">0xacf734</span>, <span class="number">0xacf7d0</span>,</span><br><span class="line">    <span class="number">0xacf7ec</span>, <span class="number">0xacf878</span>, <span class="number">0xacf8fc</span>, <span class="number">0xacf918</span>, <span class="number">0xacf94c</span>,</span><br><span class="line">    <span class="number">0xacf97c</span>, <span class="number">0xacf998</span>, <span class="number">0xacf9b0</span>, <span class="number">0xacf9d4</span>, <span class="number">0xacf9f4</span>,</span><br><span class="line">    <span class="number">0xacfa10</span>, <span class="number">0xacfa50</span>, <span class="number">0xacfa80</span>, <span class="number">0xacfa80</span>, <span class="number">0xacfb04</span>,</span><br><span class="line">    <span class="number">0xacfb08</span>, <span class="number">0xacfb50</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> opcode <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">97</span>):</span><br><span class="line">    <span class="keyword">if</span> opcode == <span class="number">0x5C</span>:</span><br><span class="line">        bc_name = <span class="string">&quot;FUNCV&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        bc_name = get_name(addrs[opcode])[<span class="number">3</span>:]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\t(<span class="subst">&#123;<span class="built_in">hex</span>(opcode)&#125;</span>, instructions.<span class="subst">&#123;bc_name&#125;</span>)<span class="subst">&#123;<span class="string">&#x27;,&#x27;</span> <span class="keyword">if</span> opcode &lt; <span class="number">96</span> <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这里需要注意，从 addrs 数组中我们也可以发现，opcode 为 0x5C 和 0x5D 的处理例程地址相同。通过排除法，可以确定这两项只能是 BC_FUNCV 和 BC_IFUNCV，我们这里就暂时规定 0x5C 为 BC_FUNCV，0x5D 为 BC_IFUNCV。如果后续反编译过程出错，再调换二者的顺序。</p>
<p>运行后得到如下输出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0x0</span>, instructions.ISLT),</span><br><span class="line">(<span class="number">0x1</span>, instructions.ISGE),</span><br><span class="line">(<span class="number">0x2</span>, instructions.ISLE),</span><br><span class="line">(<span class="number">0x3</span>, instructions.ISGT),</span><br><span class="line">(<span class="number">0x4</span>, instructions.ISEQV),</span><br><span class="line">(<span class="number">0x5</span>, instructions.ISNEV),</span><br><span class="line">(<span class="number">0x6</span>, instructions.ISEQS),</span><br><span class="line">(<span class="number">0x7</span>, instructions.ISNES),</span><br><span class="line">(<span class="number">0x8</span>, instructions.ISEQN),</span><br><span class="line">(<span class="number">0x9</span>, instructions.ISNEN),</span><br><span class="line">(<span class="number">0xa</span>, instructions.ISEQP),</span><br><span class="line">(<span class="number">0xb</span>, instructions.ISNEP),</span><br><span class="line">(<span class="number">0xc</span>, instructions.KSTR),</span><br><span class="line">(<span class="number">0xd</span>, instructions.KCDATA),</span><br><span class="line">(<span class="number">0xe</span>, instructions.KSHORT),</span><br><span class="line">(<span class="number">0xf</span>, instructions.KNUM),</span><br><span class="line">(<span class="number">0x10</span>, instructions.KPRI),</span><br><span class="line">(<span class="number">0x11</span>, instructions.KNIL),</span><br><span class="line">(<span class="number">0x12</span>, instructions.ISTC),</span><br><span class="line">(<span class="number">0x13</span>, instructions.ISFC),</span><br><span class="line">(<span class="number">0x14</span>, instructions.IST),</span><br><span class="line">(<span class="number">0x15</span>, instructions.ISF),</span><br><span class="line">(<span class="number">0x16</span>, instructions.ISTYPE),</span><br><span class="line">(<span class="number">0x17</span>, instructions.ISNUM),</span><br><span class="line">(<span class="number">0x18</span>, instructions.MOV),</span><br><span class="line">(<span class="number">0x19</span>, instructions.NOT),</span><br><span class="line">(<span class="number">0x1a</span>, instructions.UNM),</span><br><span class="line">(<span class="number">0x1b</span>, instructions.LEN),</span><br><span class="line">(<span class="number">0x1c</span>, instructions.RETM),</span><br><span class="line">(<span class="number">0x1d</span>, instructions.RET),</span><br><span class="line">(<span class="number">0x1e</span>, instructions.RET0),</span><br><span class="line">(<span class="number">0x1f</span>, instructions.RET1),</span><br><span class="line">(<span class="number">0x20</span>, instructions.ADDVN),</span><br><span class="line">(<span class="number">0x21</span>, instructions.SUBVN),</span><br><span class="line">(<span class="number">0x22</span>, instructions.MULVN),</span><br><span class="line">(<span class="number">0x23</span>, instructions.DIVVN),</span><br><span class="line">(<span class="number">0x24</span>, instructions.MODVN),</span><br><span class="line">(<span class="number">0x25</span>, instructions.ADDNV),</span><br><span class="line">(<span class="number">0x26</span>, instructions.SUBNV),</span><br><span class="line">(<span class="number">0x27</span>, instructions.MULNV),</span><br><span class="line">(<span class="number">0x28</span>, instructions.DIVNV),</span><br><span class="line">(<span class="number">0x29</span>, instructions.MODNV),</span><br><span class="line">(<span class="number">0x2a</span>, instructions.ADDVV),</span><br><span class="line">(<span class="number">0x2b</span>, instructions.SUBVV),</span><br><span class="line">(<span class="number">0x2c</span>, instructions.MULVV),</span><br><span class="line">(<span class="number">0x2d</span>, instructions.DIVVV),</span><br><span class="line">(<span class="number">0x2e</span>, instructions.MODVV),</span><br><span class="line">(<span class="number">0x2f</span>, instructions.POW),</span><br><span class="line">(<span class="number">0x30</span>, instructions.CAT),</span><br><span class="line">(<span class="number">0x31</span>, instructions.UGET),</span><br><span class="line">(<span class="number">0x32</span>, instructions.USETV),</span><br><span class="line">(<span class="number">0x33</span>, instructions.USETS),</span><br><span class="line">(<span class="number">0x34</span>, instructions.USETN),</span><br><span class="line">(<span class="number">0x35</span>, instructions.USETP),</span><br><span class="line">(<span class="number">0x36</span>, instructions.UCLO),</span><br><span class="line">(<span class="number">0x37</span>, instructions.FNEW),</span><br><span class="line">(<span class="number">0x38</span>, instructions.TNEW),</span><br><span class="line">(<span class="number">0x39</span>, instructions.TDUP),</span><br><span class="line">(<span class="number">0x3a</span>, instructions.GGET),</span><br><span class="line">(<span class="number">0x3b</span>, instructions.GSET),</span><br><span class="line">(<span class="number">0x3c</span>, instructions.TGETV),</span><br><span class="line">(<span class="number">0x3d</span>, instructions.TGETS),</span><br><span class="line">(<span class="number">0x3e</span>, instructions.TGETB),</span><br><span class="line">(<span class="number">0x3f</span>, instructions.TGETR),</span><br><span class="line">(<span class="number">0x40</span>, instructions.TSETV),</span><br><span class="line">(<span class="number">0x41</span>, instructions.TSETS),</span><br><span class="line">(<span class="number">0x42</span>, instructions.TSETB),</span><br><span class="line">(<span class="number">0x43</span>, instructions.TSETM),</span><br><span class="line">(<span class="number">0x44</span>, instructions.TSETR),</span><br><span class="line">(<span class="number">0x45</span>, instructions.CALLM),</span><br><span class="line">(<span class="number">0x46</span>, instructions.CALL),</span><br><span class="line">(<span class="number">0x47</span>, instructions.CALLMT),</span><br><span class="line">(<span class="number">0x48</span>, instructions.CALLT),</span><br><span class="line">(<span class="number">0x49</span>, instructions.ITERC),</span><br><span class="line">(<span class="number">0x4a</span>, instructions.ITERN),</span><br><span class="line">(<span class="number">0x4b</span>, instructions.VARG),</span><br><span class="line">(<span class="number">0x4c</span>, instructions.ISNEXT),</span><br><span class="line">(<span class="number">0x4d</span>, instructions.FORI),</span><br><span class="line">(<span class="number">0x4e</span>, instructions.JFORI),</span><br><span class="line">(<span class="number">0x4f</span>, instructions.FORL),</span><br><span class="line">(<span class="number">0x50</span>, instructions.IFORL),</span><br><span class="line">(<span class="number">0x51</span>, instructions.JFORL),</span><br><span class="line">(<span class="number">0x52</span>, instructions.ITERL),</span><br><span class="line">(<span class="number">0x53</span>, instructions.IITERL),</span><br><span class="line">(<span class="number">0x54</span>, instructions.JITERL),</span><br><span class="line">(<span class="number">0x55</span>, instructions.LOOP),</span><br><span class="line">(<span class="number">0x56</span>, instructions.ILOOP),</span><br><span class="line">(<span class="number">0x57</span>, instructions.JLOOP),</span><br><span class="line">(<span class="number">0x58</span>, instructions.JMP),</span><br><span class="line">(<span class="number">0x59</span>, instructions.FUNCF),</span><br><span class="line">(<span class="number">0x5a</span>, instructions.IFUNCF),</span><br><span class="line">(<span class="number">0x5b</span>, instructions.JFUNCF),</span><br><span class="line">(<span class="number">0x5c</span>, instructions.FUNCV),</span><br><span class="line">(<span class="number">0x5d</span>, instructions.IFUNCV),</span><br><span class="line">(<span class="number">0x5e</span>, instructions.JFUNCV),</span><br><span class="line">(<span class="number">0x5f</span>, instructions.FUNCC),</span><br><span class="line">(<span class="number">0x60</span>, instructions.FUNCCW)</span><br></pre></td></tr></table></figure>

<p>将其覆盖到 <strong>_OPCODES</strong> 元组完成第一处修改。</p>
<p>第二处修改在 <code>ljd/bytecode/instructions.py</code>，我们需要修正从第 97 行开始的对于每条指令的定义顺序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line">ISLT = _IDef(<span class="string">&quot;ISLT&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;if &#123;A&#125; &lt; &#123;D&#125;&quot;</span>)</span><br><span class="line">ISGE = _IDef(<span class="string">&quot;ISGE&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;if &#123;A&#125; &gt;= &#123;D&#125;&quot;</span>)</span><br><span class="line">ISLE = _IDef(<span class="string">&quot;ISLE&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;if &#123;A&#125; &lt;= &#123;D&#125;&quot;</span>)</span><br><span class="line">ISGT = _IDef(<span class="string">&quot;ISGT&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;if &#123;A&#125; &gt; &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ISEQV = _IDef(<span class="string">&quot;ISEQV&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;if &#123;A&#125; == &#123;D&#125;&quot;</span>)</span><br><span class="line">ISNEV = _IDef(<span class="string">&quot;ISNEV&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;if &#123;A&#125; ~= &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ISEQS = _IDef(<span class="string">&quot;ISEQS&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_STR, 	<span class="string">&quot;if &#123;A&#125; == &#123;D&#125;&quot;</span>)</span><br><span class="line">ISNES = _IDef(<span class="string">&quot;ISNES&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_STR, 	<span class="string">&quot;if &#123;A&#125; ~= &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ISEQN = _IDef(<span class="string">&quot;ISEQN&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_NUM, 	<span class="string">&quot;if &#123;A&#125; == &#123;D&#125;&quot;</span>)</span><br><span class="line">ISNEN = _IDef(<span class="string">&quot;ISNEN&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_NUM, 	<span class="string">&quot;if &#123;A&#125; ~= &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ISEQP = _IDef(<span class="string">&quot;ISEQP&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_PRI, 	<span class="string">&quot;if &#123;A&#125; == &#123;D&#125;&quot;</span>)</span><br><span class="line">ISNEP = _IDef(<span class="string">&quot;ISNEP&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_PRI, 	<span class="string">&quot;if &#123;A&#125; ~= &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Constant ops.</span></span><br><span class="line"></span><br><span class="line">KSTR = _IDef(<span class="string">&quot;KSTR&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_STR, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">KCDATA = _IDef(<span class="string">&quot;KCDATA&quot;</span>, 	T_DST, 	<span class="literal">None</span>, 	T_CDT, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">KSHORT = _IDef(<span class="string">&quot;KSHORT&quot;</span>, 	T_DST, 	<span class="literal">None</span>, 	T_SLIT, <span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">KNUM = _IDef(<span class="string">&quot;KNUM&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">KPRI = _IDef(<span class="string">&quot;KPRI&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_PRI, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">KNIL = _IDef(<span class="string">&quot;KNIL&quot;</span>, 		T_BS, 	<span class="literal">None</span>, 	T_BS, 	<span class="string">&quot;&#123;from_A_to_D&#125; = nil&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Unary test and copy ops</span></span><br><span class="line"></span><br><span class="line">ISTC = _IDef(<span class="string">&quot;ISTC&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;; if &#123;D&#125;&quot;</span>)</span><br><span class="line">ISFC = _IDef(<span class="string">&quot;ISFC&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;; if not &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">IST = _IDef(<span class="string">&quot;IST&quot;</span>, 		<span class="literal">None</span>, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;if &#123;D&#125;&quot;</span>)</span><br><span class="line">ISF = _IDef(<span class="string">&quot;ISF&quot;</span>, 		<span class="literal">None</span>, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;if not &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ISTYPE = _IDef(<span class="string">&quot;ISTYPE&quot;</span>, 	T_VAR, 	<span class="literal">None</span>, 	T_LIT, 	<span class="string">&quot;ISTYPE unknow&quot;</span>)</span><br><span class="line">ISNUM = _IDef(<span class="string">&quot;ISNUM&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_LIT, 	<span class="string">&quot;ISNUM unknow&quot;</span>)</span><br><span class="line"><span class="comment"># Unary ops</span></span><br><span class="line"></span><br><span class="line">MOV = _IDef(<span class="string">&quot;MOV&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">NOT = _IDef(<span class="string">&quot;NOT&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = not &#123;D&#125;&quot;</span>)</span><br><span class="line">UNM = _IDef(<span class="string">&quot;UNM&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = -&#123;D&#125;&quot;</span>)</span><br><span class="line">LEN = _IDef(<span class="string">&quot;LEN&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = #&#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Returns.</span></span><br><span class="line"></span><br><span class="line">RETM = _IDef(<span class="string">&quot;RETM&quot;</span>, 		T_BS, 	<span class="literal">None</span>, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;return &#123;from_A_x_D_minus_one&#125;, ...MULTRES&quot;</span>)</span><br><span class="line"></span><br><span class="line">RET = _IDef(<span class="string">&quot;RET&quot;</span>, 	 	T_RBS, 	<span class="literal">None</span>, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;return &#123;from_A_x_D_minus_two&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">RET0 = _IDef(<span class="string">&quot;RET0&quot;</span>, 		T_RBS, 	<span class="literal">None</span>, 	T_LIT, 	<span class="string">&quot;return&quot;</span>)</span><br><span class="line">RET1 = _IDef(<span class="string">&quot;RET1&quot;</span>, 		T_RBS, 	<span class="literal">None</span>, 	T_LIT, 	<span class="string">&quot;return &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Binary ops</span></span><br><span class="line"></span><br><span class="line">ADDVN = _IDef(<span class="string">&quot;ADDVN&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; + &#123;C&#125;&quot;</span>)</span><br><span class="line">SUBVN = _IDef(<span class="string">&quot;SUBVN&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; - &#123;C&#125;&quot;</span>)</span><br><span class="line">MULVN = _IDef(<span class="string">&quot;MULVN&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; * &#123;C&#125;&quot;</span>)</span><br><span class="line">DIVVN = _IDef(<span class="string">&quot;DIVVN&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; / &#123;C&#125;&quot;</span>)</span><br><span class="line">MODVN = _IDef(<span class="string">&quot;MODVN&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; % &#123;C&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ADDNV = _IDef(<span class="string">&quot;ADDNV&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;C&#125; + &#123;B&#125;&quot;</span>)</span><br><span class="line">SUBNV = _IDef(<span class="string">&quot;SUBNV&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;C&#125; - &#123;B&#125;&quot;</span>)</span><br><span class="line">MULNV = _IDef(<span class="string">&quot;MULNV&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;C&#125; * &#123;B&#125;&quot;</span>)</span><br><span class="line">DIVNV = _IDef(<span class="string">&quot;DIVNV&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;C&#125; / &#123;B&#125;&quot;</span>)</span><br><span class="line">MODNV = _IDef(<span class="string">&quot;MODNV&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;C&#125; % &#123;B&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ADDVV = _IDef(<span class="string">&quot;ADDVV&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; + &#123;C&#125;&quot;</span>)</span><br><span class="line">SUBVV = _IDef(<span class="string">&quot;SUBVV&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; - &#123;C&#125;&quot;</span>)</span><br><span class="line">MULVV = _IDef(<span class="string">&quot;MULVV&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; * &#123;C&#125;&quot;</span>)</span><br><span class="line">DIVVV = _IDef(<span class="string">&quot;DIVVV&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; / &#123;C&#125;&quot;</span>)</span><br><span class="line">MODVV = _IDef(<span class="string">&quot;MODVV&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; % &#123;C&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">POW = _IDef(<span class="string">&quot;POW&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; ^ &#123;C&#125; (pow)&quot;</span>)</span><br><span class="line">CAT = _IDef(<span class="string">&quot;CAT&quot;</span>, 		T_DST, 	T_RBS, 	T_RBS,</span><br><span class="line">		<span class="string">&quot;&#123;A&#125; = &#123;concat_from_B_to_C&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Upvalue and function ops.</span></span><br><span class="line"></span><br><span class="line">UGET = _IDef(<span class="string">&quot;UGET&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_UV, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">USETV = _IDef(<span class="string">&quot;USETV&quot;</span>, 		T_UV, 	<span class="literal">None</span>, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">USETS = _IDef(<span class="string">&quot;USETS&quot;</span>, 		T_UV, 	<span class="literal">None</span>, 	T_STR, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">USETN = _IDef(<span class="string">&quot;USETN&quot;</span>, 		T_UV, 	<span class="literal">None</span>, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">USETP = _IDef(<span class="string">&quot;USETP&quot;</span>, 		T_UV, 	<span class="literal">None</span>, 	T_PRI, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">UCLO = _IDef(<span class="string">&quot;UCLO&quot;</span>, 		T_RBS, 	<span class="literal">None</span>, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;nil uvs &gt;= &#123;A&#125;; goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">FNEW = _IDef(<span class="string">&quot;FNEW&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_FUN, 	<span class="string">&quot;&#123;A&#125; = function &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Table ops.</span></span><br><span class="line"></span><br><span class="line">TNEW = _IDef(<span class="string">&quot;TNEW&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_LIT, 	<span class="string">&quot;&#123;A&#125; = new table(&quot;</span></span><br><span class="line">							<span class="string">&quot; array: &#123;D_array&#125;,&quot;</span></span><br><span class="line">							<span class="string">&quot; dict: &#123;D_dict&#125;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">TDUP = _IDef(<span class="string">&quot;TDUP&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_TAB, 	<span class="string">&quot;&#123;A&#125; = copy &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">GGET = _IDef(<span class="string">&quot;GGET&quot;</span>, 		T_DST, 	<span class="literal">None</span>, 	T_STR, 	<span class="string">&quot;&#123;A&#125; = _env[&#123;D&#125;]&quot;</span>)</span><br><span class="line">GSET = _IDef(<span class="string">&quot;GSET&quot;</span>, 		T_VAR, 	<span class="literal">None</span>, 	T_STR, 	<span class="string">&quot;_env[&#123;D&#125;] = &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">TGETV = _IDef(<span class="string">&quot;TGETV&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125;[&#123;C&#125;]&quot;</span>)</span><br><span class="line">TGETS = _IDef(<span class="string">&quot;TGETS&quot;</span>, 		T_DST, 	T_VAR, 	T_STR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125;.&#123;C&#125;&quot;</span>)</span><br><span class="line">TGETB = _IDef(<span class="string">&quot;TGETB&quot;</span>, 		T_DST, 	T_VAR, 	T_LIT, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125;[&#123;C&#125;]&quot;</span>)</span><br><span class="line">TGETR = _IDef(<span class="string">&quot;TGETR&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;unkown TGETR&quot;</span>)</span><br><span class="line"></span><br><span class="line">TSETV = _IDef(<span class="string">&quot;TSETV&quot;</span>, 		T_VAR, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;B&#125;[&#123;C&#125;] = &#123;A&#125;&quot;</span>)</span><br><span class="line">TSETS = _IDef(<span class="string">&quot;TSETS&quot;</span>, 		T_VAR, 	T_VAR, 	T_STR, 	<span class="string">&quot;&#123;B&#125;.&#123;C&#125; = &#123;A&#125;&quot;</span>)</span><br><span class="line">TSETB = _IDef(<span class="string">&quot;TSETB&quot;</span>, 		T_VAR, 	T_VAR, 	T_LIT, 	<span class="string">&quot;&#123;B&#125;[&#123;C&#125;] = &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">TSETM = _IDef(<span class="string">&quot;TSETM&quot;</span>, 	 	T_BS, 	<span class="literal">None</span>, 	T_NUM,</span><br><span class="line">		<span class="string">&quot;for i = 0, MULTRES, 1 do&quot;</span></span><br><span class="line">		<span class="string">&quot; &#123;A_minus_one&#125;[&#123;D_low&#125; + i] = slot(&#123;A&#125; + i)&quot;</span>)</span><br><span class="line"></span><br><span class="line">TSETR = _IDef(<span class="string">&quot;TSETR&quot;</span>, 		T_VAR, 	T_VAR, 	T_VAR, 	<span class="string">&quot;unkow TSETR&quot;</span>)</span><br><span class="line"><span class="comment"># Calls and vararg handling. T = tail call.</span></span><br><span class="line"></span><br><span class="line">CALLM = _IDef(<span class="string">&quot;CALLM&quot;</span>, 		T_BS, 	T_LIT, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;&#123;from_A_x_B_minus_two&#125; = &#123;A&#125;(&#123;from_A_plus_one_x_C&#125;, ...MULTRES)&quot;</span>)</span><br><span class="line"></span><br><span class="line">CALL = _IDef(<span class="string">&quot;CALL&quot;</span>, 		T_BS, 	T_LIT, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;&#123;from_A_x_B_minus_two&#125; = &#123;A&#125;(&#123;from_A_plus_one_x_C_minus_one&#125;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">CALLMT = _IDef(<span class="string">&quot;CALLMT&quot;</span>, 	T_BS, 	<span class="literal">None</span>, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;return &#123;A&#125;(&#123;from_A_plus_one_x_D&#125;, ...MULTRES)&quot;</span>)</span><br><span class="line"></span><br><span class="line">CALLT = _IDef(<span class="string">&quot;CALLT&quot;</span>, 		T_BS, 	<span class="literal">None</span>, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;return &#123;A&#125;(&#123;from_A_plus_one_x_D_minus_one&#125;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">ITERC = _IDef(<span class="string">&quot;ITERC&quot;</span>, 		T_BS, 	T_LIT, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;&#123;A&#125;, &#123;A_plus_one&#125;, &#123;A_plus_two&#125; =&quot;</span></span><br><span class="line">			<span class="string">&quot; &#123;A_minus_three&#125;, &#123;A_minus_two&#125;, &#123;A_minus_one&#125;;&quot;</span></span><br><span class="line">		<span class="string">&quot; &#123;from_A_x_B_minus_two&#125; =&quot;</span></span><br><span class="line">			<span class="string">&quot; &#123;A_minus_three&#125;(&#123;A_minus_two&#125;, &#123;A_minus_one&#125;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">ITERN = _IDef(<span class="string">&quot;ITERN&quot;</span>, 		T_BS, 	T_LIT, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;&#123;A&#125;, &#123;A_plus_one&#125;, &#123;A_plus_two&#125; =&quot;</span></span><br><span class="line">			<span class="string">&quot; &#123;A_minus_three&#125;, &#123;A_minus_two&#125;, &#123;A_minus_one&#125;;&quot;</span></span><br><span class="line">		<span class="string">&quot; &#123;from_A_x_B_minus_two&#125; =&quot;</span></span><br><span class="line">			<span class="string">&quot; &#123;A_minus_three&#125;(&#123;A_minus_two&#125;, &#123;A_minus_one&#125;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">VARG = _IDef(<span class="string">&quot;VARG&quot;</span>, 		T_BS, 	T_LIT, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;&#123;from_A_x_B_minus_two&#125; = ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">ISNEXT = _IDef(<span class="string">&quot;ISNEXT&quot;</span>, 	 T_BS, 	<span class="literal">None</span>, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;Verify ITERN at &#123;D&#125;; goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Loops and branches. I/J = interp/JIT, I/C/L = init/call/loop.</span></span><br><span class="line"></span><br><span class="line">FORI = _IDef(<span class="string">&quot;FORI&quot;</span>, 		T_BS, 	<span class="literal">None</span>, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;for &#123;A_plus_three&#125; = &#123;A&#125;,&#123;A_plus_one&#125;,&#123;A_plus_two&#125;&quot;</span></span><br><span class="line">		<span class="string">&quot; else goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">JFORI = _IDef(<span class="string">&quot;JFORI&quot;</span>, 		T_BS, 	<span class="literal">None</span>, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;for &#123;A_plus_three&#125; = &#123;A&#125;,&#123;A_plus_one&#125;,&#123;A_plus_two&#125;&quot;</span></span><br><span class="line">		<span class="string">&quot; else goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">FORL = _IDef(<span class="string">&quot;FORL&quot;</span>, 		T_BS, 	<span class="literal">None</span>, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;&#123;A&#125; = &#123;A&#125; + &#123;A_plus_two&#125;;&quot;</span></span><br><span class="line">		<span class="string">&quot; if cmp(&#123;A&#125;, sign &#123;A_plus_two&#125;,  &#123;A_plus_one&#125;) goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">IFORL = _IDef(<span class="string">&quot;IFORL&quot;</span>, 	 	T_BS, 	<span class="literal">None</span>, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;&#123;A&#125; = &#123;A&#125; + &#123;A_plus_two&#125;;&quot;</span></span><br><span class="line">		<span class="string">&quot; if cmp(&#123;A&#125;, sign &#123;A_plus_two&#125;, &#123;A_plus_one&#125;) goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">JFORL = _IDef(<span class="string">&quot;JFORL&quot;</span>, 		T_BS, 	<span class="literal">None</span>, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;&#123;A&#125; = &#123;A&#125; + &#123;A_plus_two&#125;;&quot;</span></span><br><span class="line">		<span class="string">&quot; if cmp(&#123;A&#125;, sign &#123;A_plus_two&#125;, &#123;A_plus_one&#125;) goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ITERL = _IDef(<span class="string">&quot;ITERL&quot;</span>, 		T_BS, 	<span class="literal">None</span>, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;&#123;A_minus_one&#125; = &#123;A&#125;; if &#123;A&#125; != nil goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">IITERL = _IDef(<span class="string">&quot;IITERL&quot;</span>, 	T_BS, 	<span class="literal">None</span>, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;&#123;A_minus_one&#125; = &#123;A&#125;; if &#123;A&#125; != nil goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">JITERL = _IDef(<span class="string">&quot;JITERL&quot;</span>, 	T_BS, 	<span class="literal">None</span>, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;&#123;A_minus_one&#125; = &#123;A&#125;; if &#123;A&#125; != nil goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">LOOP = _IDef(<span class="string">&quot;LOOP&quot;</span>, 		T_RBS, 	<span class="literal">None</span>, 	T_JMP, 	<span class="string">&quot;Noop&quot;</span>)</span><br><span class="line">ILOOP = _IDef(<span class="string">&quot;ILOOP&quot;</span>, 		T_RBS, 	<span class="literal">None</span>, 	T_JMP, 	<span class="string">&quot;Noop&quot;</span>)</span><br><span class="line">JLOOP = _IDef(<span class="string">&quot;JLOOP&quot;</span>, 		T_RBS, 	<span class="literal">None</span>, 	T_LIT, 	<span class="string">&quot;Noop&quot;</span>)</span><br><span class="line"></span><br><span class="line">JMP = _IDef(<span class="string">&quot;JMP&quot;</span>, 		T_RBS, 	<span class="literal">None</span>, 	T_JMP, 	<span class="string">&quot;	goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function headers. I/J = interp/JIT, F/V/C = fixarg/vararg/C func.</span></span><br><span class="line"><span class="comment"># Shouldn&#x27;t be ever seen - they are not stored in raw dump?</span></span><br><span class="line"></span><br><span class="line">FUNCF = _IDef(<span class="string">&quot;FUNCF&quot;</span>, 		T_RBS, 	<span class="literal">None</span>, 	<span class="literal">None</span>,</span><br><span class="line">		<span class="string">&quot;Fixed-arg function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">IFUNCF = _IDef(<span class="string">&quot;IFUNCF&quot;</span>, 	T_RBS, 	<span class="literal">None</span>, 	<span class="literal">None</span>,</span><br><span class="line">		<span class="string">&quot;Interpreted fixed-arg function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">JFUNCF = _IDef(<span class="string">&quot;JFUNCF&quot;</span>, 	T_RBS, 	<span class="literal">None</span>, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;JIT compiled fixed-arg function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">FUNCV = _IDef(<span class="string">&quot;FUNCV&quot;</span>, 		T_RBS, 	<span class="literal">None</span>, 	<span class="literal">None</span>,</span><br><span class="line">		<span class="string">&quot;Var-arg function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">IFUNCV = _IDef(<span class="string">&quot;IFUNCV&quot;</span>, 	T_RBS, 	<span class="literal">None</span>, 	<span class="literal">None</span>,</span><br><span class="line">		<span class="string">&quot;Interpreted var-arg function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">JFUNCV = _IDef(<span class="string">&quot;JFUNCV&quot;</span>, 	T_RBS, 	<span class="literal">None</span>, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;JIT compiled var-arg function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">FUNCC = _IDef(<span class="string">&quot;FUNCC&quot;</span>, 		T_RBS, 	<span class="literal">None</span>, 	<span class="literal">None</span>,</span><br><span class="line">		<span class="string">&quot;C function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line">FUNCCW = _IDef(<span class="string">&quot;FUNCCW&quot;</span>, 	T_RBS, 	<span class="literal">None</span>, 	<span class="literal">None</span>,</span><br><span class="line">		<span class="string">&quot;Wrapped C function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">UNKNW = _IDef(<span class="string">&quot;UNKNW&quot;</span>, 		T_LIT, 	T_LIT, 	T_LIT, <span class="string">&quot;Unknown instruction&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>第三处修改在 <code>ljd/ast/builder.py</code>，按照如下方式修改，使得每种指令都落在正确的解析区域中：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">diff -urNa ljd-old/ast/builder.py ljd-new/ast/builder.py</span><br><span class="line"><span class="comment">--- ljd-old/ast/builder.py	2020-05-09 03:43:27.000000000 -0700</span></span><br><span class="line"><span class="comment">+++ ljd-new/ast/builder.py	2022-09-20 02:04:53.955771000 -0700</span></span><br><span class="line"><span class="meta">@@ -276,7 +276,7 @@</span></span><br><span class="line">     last = instructions[-1]</span><br><span class="line">     opcode = 256 if len(instructions) == 1 else instructions[-2].opcode</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-    if opcode &lt;= ins.ISF.opcode:</span></span><br><span class="line"><span class="addition">+    if opcode in (ins.ISLT.opcode, ins.ISGE.opcode, ins.ISLE.opcode, ins.ISGT.opcode, ins.ISEQV.opcode, ins.ISNEV.opcode, ins.ISEQS.opcode, ins.ISNES.opcode, ins.ISEQN.opcode, ins.ISNEN.opcode, ins.ISEQP.opcode, ins.ISNEP.opcode, ins.ISTC.opcode, ins.ISFC.opcode, ins.IST.opcode, ins.ISF.opcode):</span></span><br><span class="line">         assert last.opcode != ins.ISNEXT.opcode</span><br><span class="line">         return _build_conditional_warp(state, last_addr, instructions)</span><br><span class="line">     else:</span><br><span class="line"><span class="meta">@@ -507,7 +507,7 @@</span></span><br><span class="line">         expression = _build_unary_expression(state, addr, instruction)</span><br><span class="line"> </span><br><span class="line">     # Binary assignment operators (A = B op C)</span><br><span class="line"><span class="deletion">-    elif opcode &lt;= ins.POW.opcode:</span></span><br><span class="line"><span class="addition">+    elif ins.ADDVN.opcode &lt;= opcode &lt;= ins.POW.opcode:</span></span><br><span class="line">         expression = _build_binary_expression(state, addr, instruction)</span><br><span class="line"> </span><br><span class="line">     # Concat assignment type (A = B .. B + 1 .. ... .. C - 1 .. C)</span><br><span class="line"><span class="meta">@@ -515,7 +515,7 @@</span></span><br><span class="line">         expression = _build_concat_expression(state, addr, instruction)</span><br><span class="line"> </span><br><span class="line">     # Constant assignment operators except KNIL, which is weird anyway</span><br><span class="line"><span class="deletion">-    elif opcode &lt;= ins.KPRI.opcode:</span></span><br><span class="line"><span class="addition">+    elif ins.KSTR.opcode &lt;= opcode &lt;= ins.KPRI.opcode:</span></span><br><span class="line">         expression = _build_const_expression(state, addr, instruction)</span><br><span class="line"> </span><br><span class="line">     elif opcode == ins.UGET.opcode:</span><br><span class="line"><span class="meta">@@ -524,7 +524,7 @@</span></span><br><span class="line">     elif opcode == ins.USETV.opcode:</span><br><span class="line">         expression = _build_slot(state, addr, instruction.CD)</span><br><span class="line"> </span><br><span class="line"><span class="deletion">-    elif opcode &lt;= ins.USETP.opcode:</span></span><br><span class="line"><span class="addition">+    elif ins.USETS.opcode &lt;= opcode &lt;= ins.USETP.opcode:</span></span><br><span class="line">         expression = _build_const_expression(state, addr, instruction)</span><br><span class="line"> </span><br><span class="line">     elif opcode == ins.FNEW.opcode:</span><br></pre></td></tr></table></figure>

<p>在项目根目录运行 <code>python main.py -f &lt;script_name&gt;.luac64 &gt; &lt;script_name&gt;.lua</code> 可以得到单个文件的反编译结果，也可以通过 <code>-r </code> 选项指定目录批量反编译。另外，<code>-d</code> 选项用于指定输出目录，<code>-e</code> 选项用于指定文件后缀。</p>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>首先通过逆向思维来找到核心验证代码，在 <code>GameScene.lua</code> 的 <em>collisionH</em> 函数中可以找到游戏胜利的判断语句：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/winning_condition.png" alt="winning_condition"></p>
<p>即当碰撞到板栗仔时，主角的身体类型应该是 NORMAL 状态（初始状态为 SMALL）。在 <em>collisionV</em> 函数中可以找到修改主角 bodyType 属性的调用：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/change_body_type.png" alt="change_body_type"></p>
<p>不过需要主角吃到蘑菇才能被调用。在 <code>GameMap.lua</code> 中，可以找到 <em>isMarioEatMushroom</em> 的定义，其紧挨着的上一个函数是 <em>showNewMushroom</em>，看名字应该是用于生成蘑菇的。查找一下 <em>showNewMushroom</em> 的引用，可以发现它在 <em>breakBrick</em> 中被调用：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/check_trigger.png" alt="check_trigger"></p>
<p>上图中框起来的部分就是触发输入校验的逻辑，它将所有普通方块上的字符拼接成长度为 32 的字符串，存放在变量 <strong>slot5</strong> 中。这里反编译结果存在一些偏差，应该是下面这样才对：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">slot5 = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> slot9 = <span class="number">0</span>, <span class="number">31</span> <span class="keyword">do</span></span><br><span class="line">    slot5 = slot5 .. slot0.labelList[<span class="string">&quot;input&quot;</span> .. <span class="built_in">tostring</span>(slot9)]:getString()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>不过我们大致能猜到它的意思，拼接好后传递给 <code>Util.lua</code> 文件的 <em>create</em> 函数，得到一个 Util 模块实例 <strong>slot6</strong>。接着调用 <em>OoO</em> 函数和 <em>oOo</em> 函数，如果后者返回 true，则显示蘑菇。</p>
<p>所以问题简化成了如何令 <em>Util.oOo</em> 返回 true，这要求我们着重分析 <code>Util.lua</code> 文件。从现在开始，这道题就变成一道常规逆向题，还是给了源码的那种，稍微还原一下符号就能发现它是一个小型虚拟机。这里需要注意，除了 <em>create</em> 函数外，其他函数的第一个参数（slot0）都相当于 self，你可以简单理解为类静态函数和类成员函数的区别。</p>
<p>这里就不过多地去分析虚拟机的实现了，下面将 <code>Util.lua</code> 的源码奉上：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> Util=class(<span class="string">&quot;Util&quot;</span>,<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> cc.Node:<span class="built_in">create</span>()</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">Util.slot = &#123;&#123;&#125;, &#123;&#125;, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Util:ctor</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Util.create</span><span class="params">(input)</span></span></span><br><span class="line">    <span class="keyword">local</span> util=Util.new()</span><br><span class="line">    <span class="keyword">local</span> target=&#123; <span class="number">94</span>, <span class="number">106</span>, <span class="number">91</span>, <span class="number">110</span>, <span class="number">86</span>, <span class="number">100</span>, <span class="number">82</span>, <span class="number">20</span>, <span class="number">32</span>, <span class="number">20</span>, <span class="number">80</span>, <span class="number">21</span>, <span class="number">83</span>, <span class="number">107</span>, <span class="number">88</span>, <span class="number">98</span>, <span class="number">81</span>, <span class="number">19</span>, <span class="number">79</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">117</span>, <span class="number">68</span>, <span class="number">120</span>, <span class="number">61</span>, <span class="number">13</span>, <span class="number">75</span>, <span class="number">115</span>, <span class="number">48</span>, <span class="number">8</span>, <span class="number">76</span>, <span class="number">123</span> &#125;</span><br><span class="line">    util.slot[<span class="number">1</span>]=&#123; <span class="number">65</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">191</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">1</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">1</span>, <span class="number">50</span>, <span class="number">192</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">2</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">2</span>, <span class="number">50</span>, <span class="number">193</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">3</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">3</span>, <span class="number">50</span>, <span class="number">194</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">4</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">4</span>, <span class="number">50</span>, <span class="number">195</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">5</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">5</span>, <span class="number">50</span>, <span class="number">196</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">6</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">6</span>, <span class="number">50</span>, <span class="number">197</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">7</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">7</span>, <span class="number">50</span>, <span class="number">198</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">8</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">8</span>, <span class="number">50</span>, <span class="number">199</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">9</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">9</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">10</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">201</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">11</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">11</span>, <span class="number">50</span>, <span class="number">202</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">12</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">12</span>, <span class="number">50</span>, <span class="number">203</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">13</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">13</span>, <span class="number">50</span>, <span class="number">204</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">14</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">14</span>, <span class="number">50</span>, <span class="number">205</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">15</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">15</span>, <span class="number">50</span>, <span class="number">206</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">16</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">16</span>, <span class="number">50</span>, <span class="number">207</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">17</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">17</span>, <span class="number">50</span>, <span class="number">208</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">18</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">18</span>, <span class="number">50</span>, <span class="number">209</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">19</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">19</span>, <span class="number">50</span>, <span class="number">210</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">20</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">20</span>, <span class="number">50</span>, <span class="number">211</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">21</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">21</span>, <span class="number">50</span>, <span class="number">212</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">22</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">22</span>, <span class="number">50</span>, <span class="number">213</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">23</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">23</span>, <span class="number">50</span>, <span class="number">214</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">24</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">24</span>, <span class="number">50</span>, <span class="number">215</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">25</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">25</span>, <span class="number">50</span>, <span class="number">216</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">26</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">26</span>, <span class="number">50</span>, <span class="number">217</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">27</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">27</span>, <span class="number">50</span>, <span class="number">218</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">28</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">28</span>, <span class="number">50</span>, <span class="number">219</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">29</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">29</span>, <span class="number">50</span>, <span class="number">220</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">30</span>, <span class="number">50</span>, <span class="number">221</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">31</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">31</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span> &#125;</span><br><span class="line">    <span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">256</span> <span class="keyword">do</span></span><br><span class="line">        util.slot[<span class="number">2</span>][i]=<span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">for</span> i=<span class="number">33</span>,<span class="number">65</span> <span class="keyword">do</span></span><br><span class="line">        util.slot[<span class="number">2</span>][i]=<span class="built_in">string</span>.<span class="built_in">byte</span>(<span class="built_in">input</span>, i<span class="number">-32</span>)</span><br><span class="line">        util.slot[<span class="number">2</span>][i+<span class="number">96</span>]=target[i<span class="number">-32</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    util.slot[<span class="number">3</span>] = <span class="number">0</span></span><br><span class="line">    util.slot[<span class="number">4</span>] = <span class="number">0</span></span><br><span class="line">    util.slot[<span class="number">5</span>] = <span class="number">1</span></span><br><span class="line">    util.slot[<span class="number">6</span>] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> util</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Util:OoO</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        opcode=<span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]]</span><br><span class="line">        <span class="keyword">if</span> opcode==<span class="number">0x11</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> operand = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">local</span> inputi = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="number">33</span>+operand]</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="number">33</span>+operand] = <span class="built_in">self</span>:lil(inputi + <span class="number">1</span>, <span class="number">0xFF</span>)</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">5</span>] = <span class="built_in">self</span>.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">elseif</span> opcode==<span class="number">0x21</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> operand = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">local</span> regi = <span class="built_in">self</span>.slot[operand<span class="number">-7</span>]</span><br><span class="line">            <span class="built_in">self</span>.slot[operand<span class="number">-7</span>] = <span class="built_in">self</span>:lil(regi + <span class="number">1</span>, <span class="number">0xFF</span>)</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">5</span>] = <span class="built_in">self</span>.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elseif</span> opcode==<span class="number">0x41</span> <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">6</span>] = <span class="built_in">self</span>.slot[<span class="number">6</span>] + <span class="number">1</span></span><br><span class="line">            <span class="keyword">local</span> operand = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">local</span> regi = <span class="built_in">self</span>.slot[<span class="number">6</span>]</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">2</span>][regi] = operand</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">5</span>] = <span class="built_in">self</span>.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elseif</span> opcode==<span class="number">0x12</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> operand = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">local</span> inputi = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="number">33</span>+operand]</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="number">33</span>+operand] = <span class="built_in">self</span>:lil(inputi - <span class="number">1</span>, <span class="number">0xFF</span>)</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">5</span>] = <span class="built_in">self</span>.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elseif</span> opcode==<span class="number">0x23</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> operand1 = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">local</span> operand2 = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">2</span>]</span><br><span class="line">            <span class="keyword">local</span> regi = <span class="built_in">self</span>.slot[operand1<span class="number">-7</span>]</span><br><span class="line"></span><br><span class="line">            <span class="built_in">self</span>.slot[operand1<span class="number">-7</span>] = <span class="built_in">self</span>:ili(regi,operand2)</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">5</span>] = <span class="built_in">self</span>.slot[<span class="number">5</span>] + <span class="number">3</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elseif</span> opcode==<span class="number">0x32</span> <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">6</span>] = <span class="built_in">self</span>.slot[<span class="number">6</span>] + <span class="number">1</span></span><br><span class="line">            <span class="keyword">local</span> operand = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">local</span> regi = <span class="built_in">self</span>.slot[<span class="number">6</span>]</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">2</span>][regi] = <span class="built_in">self</span>.slot[<span class="number">2</span>][<span class="number">33</span>+operand]</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">5</span>] = <span class="built_in">self</span>.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elseif</span> opcode==<span class="number">0x24</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> operand1 = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">local</span> operand2 = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">2</span>]</span><br><span class="line">            <span class="keyword">local</span> reg1 = <span class="built_in">self</span>.slot[operand1<span class="number">-7</span>]</span><br><span class="line">            <span class="keyword">local</span> reg2 = <span class="built_in">self</span>.slot[operand2<span class="number">-7</span>]</span><br><span class="line"></span><br><span class="line">            <span class="built_in">self</span>.slot[operand1<span class="number">-7</span>] = <span class="built_in">self</span>:ili(reg1,reg2)</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">5</span>] = <span class="built_in">self</span>.slot[<span class="number">5</span>] + <span class="number">3</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elseif</span> opcode==<span class="number">0x31</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> operand = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">local</span> regi = <span class="built_in">self</span>.slot[<span class="number">6</span>]</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">2</span>][<span class="number">224</span>+operand] = <span class="built_in">self</span>.slot[<span class="number">2</span>][regi]</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">6</span>] = <span class="built_in">self</span>.slot[<span class="number">6</span>] - <span class="number">1</span></span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">5</span>] = <span class="built_in">self</span>.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elseif</span> opcode==<span class="number">0x22</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> operand = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">local</span> regi = <span class="built_in">self</span>.slot[operand<span class="number">-7</span>]</span><br><span class="line">            <span class="built_in">self</span>.slot[operand<span class="number">-7</span>] = <span class="built_in">self</span>:lil(regi - <span class="number">1</span>, <span class="number">0xFF</span>)</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">5</span>] = <span class="built_in">self</span>.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elseif</span> opcode==<span class="number">0x42</span> <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">6</span>] = <span class="built_in">self</span>.slot[<span class="number">6</span>] + <span class="number">1</span></span><br><span class="line">            <span class="keyword">local</span> operand = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">local</span> regi = <span class="built_in">self</span>.slot[<span class="number">6</span>]</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">2</span>][regi] = <span class="built_in">self</span>.slot[operand<span class="number">-7</span>]</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">5</span>] = <span class="built_in">self</span>.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elseif</span> opcode==<span class="number">0x25</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> operand = <span class="built_in">self</span>.slot[<span class="number">1</span>][<span class="built_in">self</span>.slot[<span class="number">5</span>]+<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">local</span> regi = <span class="built_in">self</span>.slot[<span class="number">6</span>]</span><br><span class="line">            <span class="built_in">self</span>.slot[operand<span class="number">-7</span>] = <span class="built_in">self</span>.slot[<span class="number">2</span>][regi]</span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">6</span>] = <span class="built_in">self</span>.slot[<span class="number">6</span>] - <span class="number">1</span></span><br><span class="line">            <span class="built_in">self</span>.slot[<span class="number">5</span>] = <span class="built_in">self</span>.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elseif</span> opcode==<span class="number">0x90</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Util:oOo</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">32</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">self</span>.slot[<span class="number">2</span>][i+<span class="number">128</span>] ~= <span class="built_in">self</span>.slot[<span class="number">2</span>][<span class="number">223</span>+i] <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Util:ili</span><span class="params">(num1,num2)</span></span></span><br><span class="line">    <span class="keyword">local</span> tmp1 = num1</span><br><span class="line">    <span class="keyword">local</span> tmp2 = num2</span><br><span class="line">    <span class="keyword">local</span> str = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">repeat</span></span><br><span class="line">        <span class="keyword">local</span> s1 = tmp1 % <span class="number">2</span></span><br><span class="line">        <span class="keyword">local</span> s2 = tmp2 % <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> s1 == s2 <span class="keyword">then</span></span><br><span class="line">            str = <span class="string">&quot;0&quot;</span>..str</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            str = <span class="string">&quot;1&quot;</span>..str</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        tmp1 = <span class="built_in">math</span>.<span class="built_in">modf</span>(tmp1/<span class="number">2</span>)</span><br><span class="line">        tmp2 = <span class="built_in">math</span>.<span class="built_in">modf</span>(tmp2/<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">until</span>(tmp1 == <span class="number">0</span> <span class="keyword">and</span> tmp2 == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">tonumber</span>(str,<span class="number">2</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Util:lil</span><span class="params">(num1,num2)</span></span></span><br><span class="line">    <span class="keyword">local</span> tmp1 = num1</span><br><span class="line">    <span class="keyword">local</span> tmp2 = num2</span><br><span class="line">    <span class="keyword">local</span> str = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">repeat</span></span><br><span class="line">        <span class="keyword">local</span> s1 = tmp1 % <span class="number">2</span></span><br><span class="line">        <span class="keyword">local</span> s2 = tmp2 % <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> s1 == s2 <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> s1 == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">                str = <span class="string">&quot;1&quot;</span>..str</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                str = <span class="string">&quot;0&quot;</span>..str</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            str = <span class="string">&quot;0&quot;</span>..str</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        tmp1 = <span class="built_in">math</span>.<span class="built_in">modf</span>(tmp1/<span class="number">2</span>)</span><br><span class="line">        tmp2 = <span class="built_in">math</span>.<span class="built_in">modf</span>(tmp2/<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">until</span>(tmp1 == <span class="number">0</span> <span class="keyword">and</span> tmp2 == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">tonumber</span>(str,<span class="number">2</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Util</span><br></pre></td></tr></table></figure>

<p>其中 <em>ili</em> 是异或运算（^），<em>lil</em> 是按位与（&amp;），<em>OoO</em> 是 <em>RunVM</em> 函数，<em>oOo</em> 是 <em>Check</em> 函数。</p>
<h2 id="最终解题"><a href="#最终解题" class="headerlink" title="最终解题"></a>最终解题</h2><p>分析好每种 opcode 的功能及模拟的内存和寄存器后，使用 python 模拟虚拟机执行并输出伪代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">inst = [<span class="number">65</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">191</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">1</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">1</span>, <span class="number">50</span>, <span class="number">192</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">2</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">2</span>, <span class="number">50</span>, <span class="number">193</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">3</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">3</span>, <span class="number">50</span>, <span class="number">194</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">4</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">4</span>, <span class="number">50</span>, <span class="number">195</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">5</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">5</span>, <span class="number">50</span>, <span class="number">196</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">6</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">6</span>, <span class="number">50</span>, <span class="number">197</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">7</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">7</span>, <span class="number">50</span>, <span class="number">198</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">8</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">8</span>, <span class="number">50</span>, <span class="number">199</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">9</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">9</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">10</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">201</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">11</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">11</span>, <span class="number">50</span>, <span class="number">202</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">12</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">12</span>, <span class="number">50</span>, <span class="number">203</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">13</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">13</span>, <span class="number">50</span>, <span class="number">204</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">14</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">14</span>, <span class="number">50</span>, <span class="number">205</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">15</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">15</span>, <span class="number">50</span>, <span class="number">206</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">16</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">16</span>, <span class="number">50</span>, <span class="number">207</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">17</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">17</span>, <span class="number">50</span>, <span class="number">208</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">18</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">18</span>, <span class="number">50</span>, <span class="number">209</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">19</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">19</span>, <span class="number">50</span>, <span class="number">210</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">20</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">20</span>, <span class="number">50</span>, <span class="number">211</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">21</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">21</span>, <span class="number">50</span>, <span class="number">212</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">22</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">22</span>, <span class="number">50</span>, <span class="number">213</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">23</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">23</span>, <span class="number">50</span>, <span class="number">214</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">24</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">24</span>, <span class="number">50</span>, <span class="number">215</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">25</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">25</span>, <span class="number">50</span>, <span class="number">216</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">26</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">26</span>, <span class="number">50</span>, <span class="number">217</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">27</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">27</span>, <span class="number">50</span>, <span class="number">218</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">28</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">28</span>, <span class="number">50</span>, <span class="number">219</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">29</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">29</span>, <span class="number">50</span>, <span class="number">220</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">30</span>, <span class="number">50</span>, <span class="number">221</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">31</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">31</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>]</span><br><span class="line">vm_ip = <span class="number">0</span></span><br><span class="line">temp_reg = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> vm_ip &lt; <span class="built_in">len</span>(inst):</span><br><span class="line"></span><br><span class="line">	opcode = inst[vm_ip]</span><br><span class="line">	operand1 = inst[vm_ip + <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> opcode == <span class="number">0x11</span>:</span><br><span class="line">		code = <span class="string">f&quot;(byte) input[<span class="subst">&#123;operand1&#125;</span>]++&quot;</span></span><br><span class="line">		vm_ip += <span class="number">2</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">elif</span> opcode == <span class="number">0x12</span>:</span><br><span class="line">		code = <span class="string">f&quot;(byte) input[<span class="subst">&#123;operand1&#125;</span>]--&quot;</span></span><br><span class="line">		vm_ip += <span class="number">2</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">elif</span> opcode == <span class="number">0x21</span>:</span><br><span class="line">		code = <span class="string">f&quot;reg<span class="subst">&#123;operand1 - <span class="number">8</span>&#125;</span>++&quot;</span></span><br><span class="line">		vm_ip += <span class="number">2</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">elif</span> opcode == <span class="number">0x22</span>:</span><br><span class="line">		code = <span class="string">f&quot;reg<span class="subst">&#123;operand1 - <span class="number">8</span>&#125;</span>--&quot;</span></span><br><span class="line">		vm_ip += <span class="number">2</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">elif</span> opcode == <span class="number">0x23</span>:</span><br><span class="line">		operand2 = inst[vm_ip + <span class="number">2</span>]</span><br><span class="line">		code = <span class="string">f&quot;reg<span class="subst">&#123;operand1 - <span class="number">8</span>&#125;</span> ^= <span class="subst">&#123;operand2&#125;</span>&quot;</span></span><br><span class="line">		vm_ip += <span class="number">3</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">elif</span> opcode == <span class="number">0x24</span>:</span><br><span class="line">		operand2 = inst[vm_ip + <span class="number">2</span>]</span><br><span class="line">		code = <span class="string">f&quot;reg<span class="subst">&#123;operand1 - <span class="number">8</span>&#125;</span> ^= reg<span class="subst">&#123;operand2 - <span class="number">8</span>&#125;</span>&quot;</span></span><br><span class="line">		vm_ip += <span class="number">3</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">elif</span> opcode == <span class="number">0x25</span>:</span><br><span class="line">		code = <span class="string">f&quot;reg<span class="subst">&#123;operand1 - <span class="number">8</span>&#125;</span> = memory[<span class="subst">&#123;temp_reg&#125;</span>]&quot;</span></span><br><span class="line">		temp_reg -= <span class="number">1</span></span><br><span class="line">		vm_ip += <span class="number">2</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">elif</span> opcode == <span class="number">0x31</span>:</span><br><span class="line">		code = <span class="string">f&quot;input[<span class="subst">&#123;operand1&#125;</span>] = (byte) memory[<span class="subst">&#123;temp_reg&#125;</span>]&quot;</span></span><br><span class="line">		temp_reg -= <span class="number">1</span></span><br><span class="line">		vm_ip += <span class="number">2</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">elif</span> opcode == <span class="number">0x32</span>:</span><br><span class="line">		temp_reg += <span class="number">1</span></span><br><span class="line">		code = <span class="string">f&quot;memory[<span class="subst">&#123;temp_reg&#125;</span>] = (byte) input[<span class="subst">&#123;operand1&#125;</span>]&quot;</span></span><br><span class="line">		vm_ip += <span class="number">2</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">elif</span> opcode == <span class="number">0x41</span>:</span><br><span class="line">		temp_reg += <span class="number">1</span></span><br><span class="line">		code = <span class="string">f&quot;memory[<span class="subst">&#123;temp_reg&#125;</span>] = <span class="subst">&#123;operand1&#125;</span>&quot;</span></span><br><span class="line">		vm_ip += <span class="number">2</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">elif</span> opcode == <span class="number">0x42</span>:</span><br><span class="line">		temp_reg += <span class="number">1</span></span><br><span class="line">		code = <span class="string">f&quot;memory[<span class="subst">&#123;temp_reg&#125;</span>] = reg<span class="subst">&#123;operand1 - <span class="number">8</span>&#125;</span>&quot;</span></span><br><span class="line">		vm_ip += <span class="number">2</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">print</span>(code)</span><br></pre></td></tr></table></figure>

<p>将输出翻译为高级语言：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">buf = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">ord</span>, <span class="string">&quot;?&quot;</span> * <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">buf[<span class="number">0</span>] = (buf[<span class="number">0</span>] ^ <span class="number">30</span>) - <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">32</span>):</span><br><span class="line">	buf[i] ^= buf[i - <span class="number">1</span>]</span><br><span class="line">	<span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span> <span class="keyword">or</span> i == <span class="number">31</span>:</span><br><span class="line">		buf[i] -= <span class="number">1</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		buf[i] += <span class="number">1</span></span><br><span class="line">	buf[i] &amp;= <span class="number">0xFF</span></span><br></pre></td></tr></table></figure>

<p>故有解题脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cipher = [ <span class="number">94</span>, <span class="number">106</span>, <span class="number">91</span>, <span class="number">110</span>, <span class="number">86</span>, <span class="number">100</span>, <span class="number">82</span>, <span class="number">20</span>, <span class="number">32</span>, <span class="number">20</span>, <span class="number">80</span>, <span class="number">21</span>, <span class="number">83</span>, <span class="number">107</span>, <span class="number">88</span>, <span class="number">98</span>, <span class="number">81</span>, <span class="number">19</span>, <span class="number">79</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">117</span>, <span class="number">68</span>, <span class="number">120</span>, <span class="number">61</span>, <span class="number">13</span>, <span class="number">75</span>, <span class="number">115</span>, <span class="number">48</span>, <span class="number">8</span>, <span class="number">76</span>, <span class="number">123</span> ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">31</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">	<span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span> <span class="keyword">or</span> i == <span class="number">31</span>:</span><br><span class="line">		cipher[i] += <span class="number">1</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		cipher[i] -= <span class="number">1</span></span><br><span class="line">	cipher[i] &amp;= <span class="number">0xFF</span></span><br><span class="line">	cipher[i] ^= cipher[i - <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">cipher[<span class="number">0</span>] = (cipher[<span class="number">0</span>] + <span class="number">1</span>) ^ <span class="number">30</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">chr</span>, cipher))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<p>在游戏里去顶砖块（上面一排是前 16 个字符，下面一排是后 16 个字符），最后再顶问号块，可以得到蘑菇：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/show_mushroom.jpg" alt="show_mushroom"></p>
<p>吃了蘑菇去碰板栗仔，墙就会消失，触碰旗帜通关成功：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20230402/win_game.jpg" alt="win_game"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">in1t</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://in1t.top/2023/04/02/7th-XCTF-Final-Super-Flagio/">https://in1t.top/2023/04/02/7th-XCTF-Final-Super-Flagio/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://in1t.top" target="_blank">in1t's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%80%86%E5%90%91/">逆向</a><a class="post-meta__tags" href="/tags/Writeup/">Writeup</a></div><div class="post_share"><div class="social-share" data-image="/img/cover/xctf2022.png" data-sites="wechat,qq,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/12/12/RCTF-2022-RE-wp/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/rctf2022.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">RCTF 2022 RE wp</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/02/03/buuoj-逆向刷题之旅（三）/" title="buuoj 逆向刷题之旅（三）"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/buuojre3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-03</div><div class="title">buuoj 逆向刷题之旅（三）</div></div></a></div><div><a href="/2022/06/14/justCTF-2022-AMXX/" title="justCTF 2022 - AMXX"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/justctf2022.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-06-14</div><div class="title">justCTF 2022 - AMXX</div></div></a></div><div><a href="/2020/11/28/buuoj-逆向刷题之旅（二）/" title="buuoj 逆向刷题之旅（二）"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/buuojre2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-28</div><div class="title">buuoj 逆向刷题之旅（二）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%A7%88"><span class="toc-number">1.</span> <span class="toc-text">概览</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BA%E9%A2%98%E8%A7%86%E8%A7%92"><span class="toc-number">2.</span> <span class="toc-text">出题视角</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%A3%80%E6%B5%8B"><span class="toc-number">2.1.</span> <span class="toc-text">环境检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lua-%E8%84%9A%E6%9C%AC%E5%8A%A0%E5%AF%86"><span class="toc-number">2.2.</span> <span class="toc-text">lua 脚本加密</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E7%BC%96%E8%AF%91"><span class="toc-number">2.2.1.</span> <span class="toc-text">脚本编译</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E5%8A%A0%E5%AF%86"><span class="toc-number">2.2.2.</span> <span class="toc-text">内容加密</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8D%E7%A7%B0%E6%B7%B7%E6%B7%86"><span class="toc-number">2.2.3.</span> <span class="toc-text">名称混淆</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E5%A4%84%E7%90%86"><span class="toc-number">2.3.</span> <span class="toc-text">其他处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%98%8E%E6%96%87-luac64-%E6%96%87%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">获取明文 luac64 文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%86%E5%88%AB%E4%B9%B1%E5%BA%8F-opcode"><span class="toc-number">4.</span> <span class="toc-text">识别乱序 opcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E7%BC%96%E8%AF%91-luac64-%E6%96%87%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">反编译 luac64 文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">代码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E8%A7%A3%E9%A2%98"><span class="toc-number">7.</span> <span class="toc-text">最终解题</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/img/cover/xctf2022.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By in1t</div><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-orange?style=flat&logo=bitdefender" title="主题采用butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Source-Github-brightgreen?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a><a style="margin-inline:5px" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);</script><div class="js-pjax"></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="/js/modify.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="💐,🌸,💮,🏵,🌹,🥀,🌺,🌻,🌼,🌷,🌱,🌲,🌳,🌴,🌵,🌾,🌿,☘,🍀,🍁,🍂,🍃,🍇,🍈,🍉,🍊,🍋,🍌,🍍,🍎,🍏,🍐,🍑,🍒,🍓,🥝,🍅,🥥,🥑,🍆,🥔,🥕,🌽,🌶,🥒,🥬,🥦,🧄,🧅,🍄,🥜,🌰,🍞,🥐,🥖,🥨,🥯,🥞,🧇,🧀,🍖,🍗,🥩,🥓,🍔,🍟,🍕,🌭,🥪,🌮,🌯,🥙,🧆,🥚,🍳,🥘,🍲,🥣,🥗,🍿,🧈,🧂,🥫,🍱,🍘,🍙,🍚,🍛,🍜,🍠,🍢,🍣,🍤,🍥,🥮,🍡,🥟,🥠,🥡,🦪,🍨,🍩,🍪,🎂,🍰,🧁,🥧,🍫,🍬,🍭,🍮,🍯,🍼,🥛,☕,🍵,🍶,🍾,🍷,🍹,🍻,🥂,🥃,🥤,🧃,🧉,🧊,🥢,🍽,🥄" data-fontsize="20px" data-random="false" async="async"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":20,"vOffset":-65},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>