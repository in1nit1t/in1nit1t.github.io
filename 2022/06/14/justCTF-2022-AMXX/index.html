<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>justCTF 2022 - AMXX | in1t's blog</title><meta name="keywords" content="逆向,Writeup"><meta name="author" content="in1t@r3kapig"><meta name="copyright" content="in1t@r3kapig"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Last weekend, I played justCTF 2022 with my team. We got 6th place. It took me a whole day to solve the &quot;AMXX&quot; challenge during this 37h game. Tired though I was, I really enjoyed this challenge. To s">
<meta property="og:type" content="article">
<meta property="og:title" content="justCTF 2022 - AMXX">
<meta property="og:url" content="https://in1t.top/2022/06/14/justCTF-2022-AMXX/index.html">
<meta property="og:site_name" content="in1t&#39;s blog">
<meta property="og:description" content="Last weekend, I played justCTF 2022 with my team. We got 6th place. It took me a whole day to solve the &quot;AMXX&quot; challenge during this 37h game. Tired though I was, I really enjoyed this challenge. To s">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://in1t.top/img/cover/justctf2022.png">
<meta property="article:published_time" content="2022-06-14T12:26:26.000Z">
<meta property="article:modified_time" content="2022-06-15T16:28:31.961Z">
<meta property="article:author" content="in1t@r3kapig">
<meta property="article:tag" content="逆向">
<meta property="article:tag" content="Writeup">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://in1t.top/img/cover/justctf2022.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://in1t.top/2022/06/14/justCTF-2022-AMXX/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'justCTF 2022 - AMXX',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-06-16 00:28:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fas fa-play-circle"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cover/justctf2022.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">in1t's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fas fa-play-circle"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">justCTF 2022 - AMXX</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-06-14T12:26:26.000Z" title="发表于 2022-06-14 20:26:26">2022-06-14</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-06-15T16:28:31.961Z" title="更新于 2022-06-16 00:28:31">2022-06-16</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>18分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>Last weekend, I played <a target="_blank" rel="noopener" href="https://ctftime.org/event/1631">justCTF 2022</a> with my team. We got 6th place. It took me a whole day to solve the “AMXX” challenge during this 37h game. Tired though I was, I really enjoyed this challenge. To solve it, I bought cs1.6 for 37 RMB, and learned how to develop mods. Thanks to the game organizer :D</p>
<p>Here is  the challenge information:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/1.png" alt="challenge_info"></p>
<p>You can get the challenge attachment <a href="/attachment/justctf_amxx/task.zip">here</a>.</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>After decompressing the <code>task</code> archive, we can see <code>amxmodx</code> folder in <code>addons</code> directory, which means that we need to focus on Half-Life plugins (programs written in SourcePawn) in this challenge. Meanwhile, we can also find <code>csstats.amxx</code> in <code>amxmodx/data</code> directory, which leads to <strong>cs1.6 mods reverse engineering</strong>. However, I haven’t used cs1.6 mods before, I don’t even have the game itself on my PC. So I bought one on steam XD</p>
<p>The AMX Mod X installer can be downloaded from <a target="_blank" rel="noopener" href="https://www.amxmodx.org/downloads.php">here</a>, and I installed v1.8.2 at the very beginning. But when I replaced the three folders in <code>amxmodx</code> directory to <code>cstrike</code> and called console in the game (press ‘`’), I got this:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/2.png" alt="error_message"></p>
<p>Maybe the plugins are using a newer AMX Mod X version? I then downloaded <strong>1.9-dev</strong> on the <a target="_blank" rel="noopener" href="https://www.amxmodx.org/downloads-new.php">official website</a>. After reinstalling, it worked without error message:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/3.png" alt="mods_works"></p>
<p>Through the <code>amxx plugins</code> command, we can see the loaded plugins:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/4.png" alt="loaded_plugins"></p>
<p>The three modules circled by the red frame above are developed by the challenge author, and I will analyze them later.</p>
<p>Through the <code>amxx cmds</code> command, we can list the cmds registered by plugins. Here we can see three commands that can be triggered by <code>say</code> (to say in the game, you should press ‘Y’):</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/5.png" alt="registered_cmds"></p>
<p>For example, we can get a menu on the left side of the screen by saying <code>/menu</code> in the game.</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/6.png" alt="menu"></p>
<p>This means we can register and login as plugin users. However, when I chose to register and entered my password, the game crashed. Oops, it seems we have to work on those plugins.</p>
<h2 id="Method-Selection"><a href="#Method-Selection" class="headerlink" title="Method Selection"></a>Method Selection</h2><p>Before starting to reverse amxx, we should take a look at the given diff file <code>0001-Set-Core-Mode.patch</code>. The author modified the AMX Mod X source code in <a target="_blank" rel="noopener" href="https://github.com/alliedmodders/amxmodx">Github</a> and disabled the JIT/ASM32 technology. We can find the evidence on line 61-64:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/7.png" alt="diff"></p>
<p>He also removed the <code>amx_Exec</code> function that supports JIT/ASM32 (line 132-1154). So let’s see how the <strong>remaining</strong> amx_Exec function in <a target="_blank" rel="noopener" href="https://github.com/alliedmodders/amxmodx/blob/master/amxmodx/amx.cpp#L2662">amx.cpp</a> runs amxx files. </p>
<p>At line 2784, the compiler will determine whether the JIT or ASM32 compilation flag is defined, which is obviously not. So the part after line 2822 will be compiled into the program. It looks like a typical virtual machine:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/8.png" alt="amx_Exec"></p>
<p>Therefore, the amxx file compiled by the modified AMX Mod X should be similar to <code>pyc</code> file, it needs to be executed by an interpreter. And usually, there are existing disassembly/decompilation tools to deal with such programs.</p>
<p>After some searching on Github, I found a project called <a target="_blank" rel="noopener" href="https://github.com/peace-maker/lysis-java">lysis-java</a>. It even provides an online <a target="_blank" rel="noopener" href="https://headlinedev.xyz/lysis/">decompilation website</a>. The decompiled result after uploading <code>amxmodx/plugins/db.amxx</code> is surprisingly good, except for a few errors:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/9.png" alt="decompiled_res"></p>
<p>So I decided to clone this project and managed to fix errors so that I could get to the analysis stage with the completely readable code.</p>
<h2 id="Tool-Fixup"><a href="#Tool-Fixup" class="headerlink" title="Tool Fixup"></a>Tool Fixup</h2><p>Let’s fix the first error: <code>Can&#39;t print expression: Heap</code>.</p>
<p>I opened the project on IDEA, searched for the error string and went to <code>lysis.builder.SourceBuilder:652</code> in <code>buildExpression</code> function:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/10.png" alt="SourceBuilder"></p>
<p>It looks like the project author forgot to consider the construction of the <strong>Heap</strong> expression. Since this error often occurs after <code>fmt</code> function, I added a case here to return “fmt_result” string:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/11.png" alt="SourceBuilder_modified"></p>
<p>After using Gradle to build, I got <code>lysis-java.jar</code> in <code>build/libs</code> folder. Run <code>java -jar lysis-java.jar db.amxx</code> in cmd, it works (at least <code>get</code> function is successfully decompiled):</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/12.png" alt="decompiled_new_res"></p>
<p>But as we can see, another error occurred while parsing the next function. Now we can find a slightly higher-level function through stack trace to modify.</p>
<p>Here I chose <code>readAll</code>. This function traverses all machine codes through the <code>while</code> loop, parses them into virtual machine instructions through <code>readInstruction</code>, and finally adds them to an instruction list:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/13.png" alt="readAll"></p>
<p>Obviously, the second error occurred in the process of parsing a certain instructions. Consider discarding unparseable instructions through <code>try...catch</code>, so that the code changes can be minimal and it would not cause too much impact on the decompilation results:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/14.png" alt="readAll_modified"></p>
<p>Run the project again, this time <code>db.amxx</code> was successfully decompiled, no error was reported. Then I tried to decompile <code>accounts.amxx</code> and <code>encoder.amxx</code>, they all turned out fine.</p>
<h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p>First come to <code>accounts.amxx</code>. Those commands we see in the game are registered in <code>plugin_init</code> function below (AMX Mod X API can be found <a target="_blank" rel="noopener" href="https://www.amxmodx.org/api/">here</a>):</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// accounts.amxx</span><br><span class="line">public plugin_init()</span><br><span class="line">&#123;</span><br><span class="line">    register_plugin(&quot;Account system&quot;, &quot;21.37&quot;, &quot;RiviT&quot;);</span><br><span class="line">    register_clcmd(&quot;say /menu&quot;, &quot;cmd_menu&quot;);</span><br><span class="line">    ...</span><br><span class="line">    register_clcmd(&quot;passwd&quot;, &quot;handle_password_input&quot;);</span><br><span class="line">    g_nvault = nvault_open(&quot;accounts&quot;);</span><br><span class="line">    create_menu();</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As shown in the code, it opens <code>amxmodx/data/vault/accounts.vault</code> and whenever we input the password, <code>handle_password_input</code> function will be called:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// accounts.amxx</span><br><span class="line">public handle_password_input(id)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    get_user_name(id, name, 32);</span><br><span class="line">    new password_len = read_argv(1, password, 191);</span><br><span class="line">    new encoded_len = encode_password(id, password, password_len, encoded, 511);</span><br><span class="line">    words_to_str(encoded, encoded_len, bytes_str, 511);</span><br><span class="line">    switch (player_state[id])</span><br><span class="line">    &#123;</span><br><span class="line">        case 1:  // register</span><br><span class="line">        &#123;</span><br><span class="line">            ...  // common check</span><br><span class="line">            nvault_set(g_nvault, name, bytes_str);</span><br><span class="line">            client_print(id, 3, &quot;Register OK&quot;);</span><br><span class="line">            player_state[id] = 3;</span><br><span class="line">        &#125;</span><br><span class="line">        case 2:  // login</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This function will encrypt the entered password with username and store it to <code>accounts.vault</code>. According to the challenge description, we need to recover the password of <code>Pr0g4m3r</code> in it:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/15.png" alt="vault_content"></p>
<p>So we should analyze <code>encode_password</code> function to figure out how it encrypts user’s password. It is defined as a native function in <code>encoder.amxx</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// encoder.amxx</span><br><span class="line">public encode_password(id, password[], len, output[], out_len)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    new local_copy[256];</span><br><span class="line">    copy(local_copy, len, password);</span><br><span class="line">    new new_len = len;</span><br><span class="line">    new_len = encode1(id, local_copy, new_len);</span><br><span class="line">    new_len = encode2(local_copy, new_len);</span><br><span class="line">    new_len = encode3(local_copy, new_len);</span><br><span class="line">    copy(output, out_len, local_copy);</span><br><span class="line">    return new_len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It mainly encrypts the plaintext through three different encryption functions in turn, and all the encoding functions are defined in this module. But interestingly, they’re all <strong>fake</strong>. We can notice that <code>plugin_init</code> of <code>encoder.amxx</code> starts a task called <code>prepare_plugin</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// encoder.amxx</span><br><span class="line">public plugin_init()</span><br><span class="line">&#123;</span><br><span class="line">    register_plugin(&quot;Super-encryptor 4001&quot;, &quot;0.01 pre-alpha&quot;, &quot;RiviT&quot;);</span><br><span class="line">    register_cvar(&quot;encoder_random_value&quot;, &quot;1337&quot;);</span><br><span class="line">    read_regions();</span><br><span class="line">    set_task(1073741824, &quot;prepare_plugin&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public prepare_plugin()</span><br><span class="line">&#123;</span><br><span class="line">    parts = TrieCreate();  // create dictionary</span><br><span class="line">    ...</span><br><span class="line">    new i;</span><br><span class="line">    while (i &lt; 256 &amp;&amp; TrieGetSize(parts) != 256)</span><br><span class="line">    &#123;</span><br><span class="line">        formatex(buf, 31, &quot;%08x&quot;, i);</span><br><span class="line">        hash_string(buf, 3, hash, 64);</span><br><span class="line">        new i;</span><br><span class="line">        while (i &lt; 64)</span><br><span class="line">        &#123;</span><br><span class="line">            formatex(hexbuf, 2, &quot;%c%c&quot;, hash[i], hash[i + 1]);</span><br><span class="line">            if (!TrieGetCell(parts, hexbuf, v))</span><br><span class="line">            &#123;</span><br><span class="line">                TrieSetCell(parts, hexbuf, order, 1);</span><br><span class="line">                order++;</span><br><span class="line">            &#125;</span><br><span class="line">            i += 2;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    new i;</span><br><span class="line">    while (i &lt; 3)</span><br><span class="line">    &#123;</span><br><span class="line">        db_get(code_keys[i]);  // code_keys = [&quot;stage1&quot;, &quot;stage2&quot;, &quot;stage3&quot;]</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>prepare_plugin</code> function first initializes a dictionary with 256 key-value pairs, then performs <strong>SMC</strong> through <code>db_get</code> (a native function named <code>get</code> in <code>db.amxx</code>) to modify the machine code of encode1/2/3. When <code>get</code> finishes SELECT request, <code>get_handle</code> will be called:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// db.amxx</span><br><span class="line">public get(key[])</span><br><span class="line">&#123;</span><br><span class="line">    param_convert(1);</span><br><span class="line">    fmt(&quot;SELECT * FROM `hex_data` WHERE `name`=&#x27;%s&#x27;;&quot;, key);</span><br><span class="line">    SQL_ThreadQuery(g_sql_tuple, &quot;get_handle&quot;, fmt_result, 2792);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public get_handle(failstate, Handle:query, error[])</span><br><span class="line">&#123;</span><br><span class="line">    if (failstate)</span><br><span class="line">    &#123;</span><br><span class="line">        log_amx(&quot;get_handle: failstate: %d error: %s&quot;, failstate, error);</span><br><span class="line">    &#125;</span><br><span class="line">    if (SQL_NumResults(query))</span><br><span class="line">    &#123;</span><br><span class="line">        new name[64];</span><br><span class="line">        new func_base;</span><br><span class="line">        SQL_ReadResult(query, SQL_FieldNameToNum(query, &quot;data&quot;), data, 2048);</span><br><span class="line">        SQL_ReadResult(query, SQL_FieldNameToNum(query, &quot;name&quot;), name, 64);</span><br><span class="line">        func_base = SQL_ReadResult(query, SQL_FieldNameToNum(query, &quot;func_base&quot;));</span><br><span class="line">        new new_len = unhex(data, strlen(data));</span><br><span class="line">        ExecuteForward(db_forward, 0, PrepareArray(name, 64), PrepareArray(data, 2048), new_len, func_base);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public plugin_init()</span><br><span class="line">&#123;</span><br><span class="line">    register_plugin(&quot;DB&quot;, &quot;13.37&quot;, &quot;RiviT&quot;, 1948, 1952);</span><br><span class="line">    db_forward = CreateMultiForward(&quot;db_results_ready&quot;, 3, 4, 4, 0, 0);</span><br><span class="line">    ...</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This function will execute a <code>Forward</code> initialized in <code>plugin_init</code>, which would result in a call to <code>db_results_ready</code> defined in <code>encoder.amxx</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">// encoder.amxx</span><br><span class="line">public db_results_ready(key[], data[], len, func_base)</span><br><span class="line">&#123;</span><br><span class="line">    log_amx(&quot;%s&quot;, key);</span><br><span class="line">    new dest;</span><br><span class="line">    new var1 = code_keys;</span><br><span class="line">    if (equal(key, var1[0][var1]))</span><br><span class="line">    &#123;</span><br><span class="line">        dest = 2404;      // encode1 function base</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        if (equal(key, code_keys[1]))</span><br><span class="line">        &#123;</span><br><span class="line">            dest = 3256;  // encode2 function base</span><br><span class="line">        &#125;</span><br><span class="line">        if (equal(key, code_keys[2]))</span><br><span class="line">        &#123;</span><br><span class="line">            dest = 3652;  // encode3 function base</span><br><span class="line">        &#125;</span><br><span class="line">        set_fail_state(&quot;invalid code key&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    apply_patch(dest, data, len, func_base);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public apply_patch(address, data[], data_len, func_base)</span><br><span class="line">&#123;</span><br><span class="line">    fix_relocation_opcodes(address, data, data_len, func_base);</span><br><span class="line">    address = address + COD - DAT;</span><br><span class="line">    new i;</span><br><span class="line">    while (i &lt; data_len)</span><br><span class="line">    &#123;</span><br><span class="line">        write_mem(address, data[i]);</span><br><span class="line">        address += 4;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public fix_relocation_opcodes(base_func_addr, data[], data_len, old_func_base)</span><br><span class="line">&#123;</span><br><span class="line">    new cip;</span><br><span class="line">    while (cip &lt; data_len)</span><br><span class="line">    &#123;</span><br><span class="line">        new op = data[cip];</span><br><span class="line">        cip++;</span><br><span class="line">        switch (op)</span><br><span class="line">        &#123;</span><br><span class="line">            // branch instruction opcode</span><br><span class="line">            case 49, 51, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 129:</span><br><span class="line">            &#123;</span><br><span class="line">                new v = data[cip] - old_func_base + base_func_addr + amx_base;</span><br><span class="line">                data[cip] = v;</span><br><span class="line">                cip++;</span><br><span class="line">            &#125;</span><br><span class="line">            default:</span><br><span class="line">            &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The three main functions above will use the data from database to modify encryption functions. So we should focus on the <code>amxmodx/data/sqlite3/jctf.sq3</code> instead of decompiled bogus functions:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/16.png" alt="db_content"></p>
<p>Now we are going to modify the lysis-java project again, so that we can replace the machine code to be parsed.</p>
<h2 id="Tool-Modification"><a href="#Tool-Modification" class="headerlink" title="Tool Modification"></a>Tool Modification</h2><p>If you follow the control flow of the project from <code>lysis.Lysis.main</code>, you can quickly find that it parses and reads the amxx file in the <strong>constructor</strong> of <code>lysis.amxmodx.AMXModXFile</code> class. And you’ll find it handling <code>.CODE</code> segment on line 195-203:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/17.png" alt="AMXModXFile"></p>
<p>It calculates the code length and slices it to build a <code>Code</code> object. And in the following <code>for</code> loop we can get information about each function (name, base, etc.). So why not just modify the code bytes here?</p>
<p>Before that, we must implement the <code>fix_relocation_opcodes</code> function in Java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lysis.BitConverter;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fix_relocation_opcodes</span><span class="params">(<span class="keyword">int</span> base_func_addr, <span class="keyword">byte</span>[] data, <span class="keyword">int</span> old_func_base)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cip = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (cip &lt; data.length) &#123;</span><br><span class="line">        <span class="keyword">byte</span> op = data[cip];</span><br><span class="line">        cip += <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">switch</span> (op) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">49</span>: <span class="keyword">case</span> <span class="number">51</span>: <span class="keyword">case</span> <span class="number">53</span>: <span class="keyword">case</span> <span class="number">54</span>: <span class="keyword">case</span> <span class="number">55</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">56</span>: <span class="keyword">case</span> <span class="number">57</span>: <span class="keyword">case</span> <span class="number">58</span>: <span class="keyword">case</span> <span class="number">59</span>: <span class="keyword">case</span> <span class="number">60</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">61</span>: <span class="keyword">case</span> <span class="number">62</span>: <span class="keyword">case</span> <span class="number">63</span>: <span class="keyword">case</span> <span class="number">64</span>: <span class="keyword">case</span> (<span class="keyword">byte</span>)<span class="number">129</span>: &#123;</span><br><span class="line">                <span class="keyword">int</span> v = (<span class="keyword">int</span>) (BitConverter.ToUInt32(data, cip) - old_func_base + base_func_addr);</span><br><span class="line">                data[cip] = (<span class="keyword">byte</span>) (v &amp; <span class="number">0xFF</span>);</span><br><span class="line">                data[cip+<span class="number">1</span>] = (<span class="keyword">byte</span>) ((v &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                data[cip+<span class="number">2</span>] = (<span class="keyword">byte</span>) ((v &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                data[cip+<span class="number">3</span>] = (<span class="keyword">byte</span>) ((v &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                cip += <span class="number">4</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>:&#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And then, we can do things like this (take <code>encode1</code> as an example):</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/18.png" alt="encode1"></p>
<p>Both the <code>new_encode1</code>(data) and 2440 (func_base) are obtained from <code>stage1</code> entry in the database. 2404 (base_func_addr) is obtained from <code>encoder.amxx!db_results_ready</code>. Then make the same changes to encode 2 &amp; 3:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/19.png" alt="encode23"></p>
<p>Build &amp; Run towards <code>encoder.amxx</code>, it stuck after decompiling <code>encode1</code>…</p>
<p>After some debugging work, I found the problem in <code>lysis.Lysis.DumpMethod</code>. It tries to analyze the heap usage on line 117:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/20.png" alt="heap_analyze"></p>
<p>The previous modification may have caused the loop exit condition inside to be unsatisfied, resulting in an infinite loop. So I just deleted this line, and it works :D</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/21.png" alt="complete_res"></p>
<h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>After beautifying the code, we finally got the correct encryption function:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public encode1(id, password[], password_len)</span><br><span class="line">&#123;</span><br><span class="line">    new username[32];</span><br><span class="line">    new username_len = get_user_name(id, username, 32);</span><br><span class="line">    new i = 0;</span><br><span class="line">    new j = 0;</span><br><span class="line">    while (i &lt; password_len)</span><br><span class="line">    &#123;</span><br><span class="line">        new var5 = password[i];</span><br><span class="line">        password[i] = username[j] ^ var5;</span><br><span class="line">        j++;</span><br><span class="line">        j %= username_len;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    new k = 0;</span><br><span class="line">    while (k + 1 &lt; password_len)</span><br><span class="line">    &#123;</span><br><span class="line">        password[k] ^= password[k + 1];</span><br><span class="line">        password[k + 1] ^= password[k];</span><br><span class="line">        password[k] ^= password[k + 1];</span><br><span class="line">        k += 2;</span><br><span class="line">    &#125;</span><br><span class="line">    return password_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public encode2(password[], password_len)</span><br><span class="line">&#123;</span><br><span class="line">    new var1 = 0;</span><br><span class="line">    new var2 = 0;</span><br><span class="line">    while (var2 &lt; password_len)</span><br><span class="line">    &#123;</span><br><span class="line">        TrieGetCell(parts, fmt(&quot;%02x&quot;, password[var2]), var1);</span><br><span class="line">        password[var2] = var1;</span><br><span class="line">        var2++;</span><br><span class="line">    &#125;</span><br><span class="line">    return password_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public encode3(password[], password_len)</span><br><span class="line">&#123;</span><br><span class="line">    new random_value = get_cvar_num(&quot;encoder_random_value&quot;);</span><br><span class="line">    new i = 0;</span><br><span class="line">    while (i &lt; password_len)</span><br><span class="line">    &#123;</span><br><span class="line">        random_value = password[i] * 57005 + random_value;</span><br><span class="line">        random_value += 1;</span><br><span class="line">        random_value %= 4096;</span><br><span class="line">        password[i] = random_value;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    return password_len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We can get the cvar <code>encoder_random_value</code> (used in <code>encode3</code>) by typing <code>amxx cvars</code> in the game console:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/22.png" alt="get_cvar"></p>
<p>And we can generate <code>parts</code> (used in <code>encode2</code>) by ourselves:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"></span><br><span class="line">parts = <span class="built_in">dict</span>()</span><br><span class="line">i, order = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="number">256</span> <span class="keyword">and</span> <span class="built_in">len</span>(parts) != <span class="number">256</span>:</span><br><span class="line">    buf = <span class="string">b&quot;%08x&quot;</span> % i</span><br><span class="line">    hash_str = sha256(buf).hexdigest()</span><br><span class="line"></span><br><span class="line">    j = <span class="number">0</span> </span><br><span class="line">    <span class="keyword">while</span> j &lt; <span class="number">64</span>:</span><br><span class="line">        <span class="keyword">if</span> hash_str[j:j+<span class="number">2</span>] <span class="keyword">not</span> <span class="keyword">in</span> parts:</span><br><span class="line">            parts[hash_str[j:j+<span class="number">2</span>]] = order</span><br><span class="line">            order += <span class="number">1</span></span><br><span class="line">        j += <span class="number">2</span></span><br><span class="line">    i += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>The last step is to determine how the encrypted password is stored in <code>accounts.vault</code>. Looking back at <code>accounts.amxx!handle_password_input</code>, we can find that the <code>words_to_str</code> function is also called after encryption:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// accounts.amxx</span><br><span class="line">new COD = 37;</span><br><span class="line"></span><br><span class="line">words_to_str(encoded[], encoded_len, bytes[], bytes_len)</span><br><span class="line">&#123;</span><br><span class="line">    new i;</span><br><span class="line">    while (i &lt; encoded_len)</span><br><span class="line">    &#123;</span><br><span class="line">        fmt(COD, encoded[i]);</span><br><span class="line">        add(bytes, bytes_len, fmt_result);  // strcat</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Obviously, <code>COD</code> should be a format string, but the decompilation result is wrong here. However, we can still guess the content of this format string through <code>encode3</code> and ciphertext. Take Rivit’s password ciphertext as an example: <code>0f5401c00a740b8d0dc10407081d0c8700ee</code>.</p>
<p>Because the ciphertext contains hex characters, starts with ‘0’, and contains many zeros, the format string should look like <code>%0?x</code>. In <code>encode3</code>, we can see the expression <code>random_value %= 4096</code>, which means every element in the list should be less than 0x1000 (4096). So the format string may be <code>%03x</code> or <code>%04x</code>, and ciphertext starts with ‘0’, so it can only be <code>%04x</code>.</p>
<p>Through the solving script below, we eventually get the flag:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode1</span>(<span class="params">username, password</span>):</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(password) - <span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">        password[k], password[k + <span class="number">1</span>] = password[k + <span class="number">1</span>], password[k]</span><br><span class="line"></span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(password)):</span><br><span class="line">        password[i] ^= username[idx]</span><br><span class="line">        idx = (idx + <span class="number">1</span>) % <span class="built_in">len</span>(username)</span><br><span class="line">    <span class="keyword">return</span> password</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode2</span>(<span class="params">password</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(password)):</span><br><span class="line">        password[i] = rev_parts[<span class="string">&quot;%02x&quot;</span> % password[i]]</span><br><span class="line">    <span class="keyword">return</span> password</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode3</span>(<span class="params">password, password_len</span>):</span></span><br><span class="line">    random_value = <span class="number">0x301a</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(password_len):</span><br><span class="line">        tmp = password[i]</span><br><span class="line">        password[i] = (password[i] - <span class="number">1</span> - random_value) * invert(<span class="number">57005</span>, <span class="number">4096</span>) % <span class="number">4096</span></span><br><span class="line">        random_value = tmp</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>, password))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">order = <span class="number">0</span></span><br><span class="line">parts = <span class="built_in">dict</span>()</span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="number">256</span> <span class="keyword">and</span> <span class="built_in">len</span>(parts) != <span class="number">256</span>:</span><br><span class="line">    buf = <span class="string">b&quot;%08x&quot;</span> % i</span><br><span class="line">    hash_str = sha256(buf).hexdigest()</span><br><span class="line"></span><br><span class="line">    j = <span class="number">0</span> </span><br><span class="line">    <span class="keyword">while</span> j &lt; <span class="number">64</span>:</span><br><span class="line">        <span class="keyword">if</span> hash_str[j:j+<span class="number">2</span>] <span class="keyword">not</span> <span class="keyword">in</span> parts:</span><br><span class="line">            parts[hash_str[j:j+<span class="number">2</span>]] = order</span><br><span class="line">            order += <span class="number">1</span></span><br><span class="line">        j += <span class="number">2</span></span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">rev_parts = &#123;<span class="string">&quot;%02x&quot;</span> % value: <span class="built_in">int</span>(key, <span class="number">16</span>) <span class="keyword">for</span> key, value <span class="keyword">in</span> parts.items()&#125;</span><br><span class="line"></span><br><span class="line">username = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">ord</span>, <span class="string">&quot;Pr0g4m3r&quot;</span>))</span><br><span class="line">cstr = <span class="string">&quot;0ec80d920582039e07950164007f02940e290e97038d08670cd108630bce02de0566079a02f4012c08ac04950aa60f0d0c81&quot;</span></span><br><span class="line">cipher = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(cstr), <span class="number">4</span>):</span><br><span class="line">    cipher.append(<span class="built_in">int</span>(cstr[i:i+<span class="number">4</span>], <span class="number">16</span>))</span><br><span class="line"></span><br><span class="line">plain = decode1(username, decode2(decode3(cipher, <span class="built_in">len</span>(cipher))))</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">chr</span>, plain))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># justCTF&#123;4lm057_d34d_g4m3&#125;</span></span><br></pre></td></tr></table></figure>

<p>We can also get other users’ passwords:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Joe                joejoejoejoe</span><br><span class="line">Fragnatic          passw0rd</span><br><span class="line">Campers Death      hotdog87</span><br><span class="line">Wujek              plgurom!</span><br><span class="line">shw                topplayer</span><br><span class="line">Headshot Deluxe    winteriscoming</span><br><span class="line">fex                123123123</span><br><span class="line">L33t               headshot</span><br><span class="line">Rivit              admin1337</span><br><span class="line">Botman             q123123q</span><br><span class="line">rumcajs            zaq1@WSX</span><br><span class="line">Dredd              awp420awp</span><br></pre></td></tr></table></figure>

<p>I also wrote a runnable mod under 1.9-dev. It has the exact same cryptographic logic as <code>encoder.amxx</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;amxmodx&gt;</span><br><span class="line">#include &lt;celltrie&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">new Trie:parts;</span><br><span class="line"></span><br><span class="line">public set_parts()</span><br><span class="line">&#123;</span><br><span class="line">    new buf[32];</span><br><span class="line">    new hash[65];</span><br><span class="line">    new hexbuf[3];</span><br><span class="line">    new order = 0;</span><br><span class="line">    new i = 0;</span><br><span class="line">    new v;</span><br><span class="line"></span><br><span class="line">    parts = TrieCreate();</span><br><span class="line">    while (i &lt; 256 &amp;&amp; TrieGetSize(parts) != 256)</span><br><span class="line">    &#123;</span><br><span class="line">        formatex(buf, 31, &quot;%08x&quot;, i);</span><br><span class="line">        hash_string(buf, 3, hash, 64);</span><br><span class="line">        new j = 0;</span><br><span class="line">        while (j &lt; 64)</span><br><span class="line">        &#123;</span><br><span class="line">            formatex(hexbuf, 2, &quot;%c%c&quot;, hash[j], hash[j + 1]);</span><br><span class="line">            if (!TrieGetCell(parts, hexbuf, v))</span><br><span class="line">            &#123;</span><br><span class="line">                TrieSetCell(parts, hexbuf, order, 1);</span><br><span class="line">                order++;</span><br><span class="line">            &#125;</span><br><span class="line">            j += 2;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public plugin_init()</span><br><span class="line">&#123;</span><br><span class="line">    register_plugin(&quot;sim_encoder&quot;, &quot;1.0&quot;, &quot;in1t&quot;);</span><br><span class="line">    register_clcmd(&quot;say /reg&quot;, &quot;reg_func&quot;);</span><br><span class="line">    register_clcmd(&quot;passwd&quot;, &quot;handle_password_input&quot;);</span><br><span class="line">    set_parts();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public encode1(id, password[], password_len)</span><br><span class="line">&#123;</span><br><span class="line">    new username[32];</span><br><span class="line">    new username_len = get_user_name(id, username, 32);</span><br><span class="line"></span><br><span class="line">    new i = 0;</span><br><span class="line">    new j = 0;</span><br><span class="line">    while (i &lt; password_len)</span><br><span class="line">    &#123;</span><br><span class="line">        new var5 = password[i];</span><br><span class="line">        password[i] = username[j] ^ var5;</span><br><span class="line">        j++;</span><br><span class="line">        j %= username_len;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    new k = 0;</span><br><span class="line">    while (k + 1 &lt; password_len)</span><br><span class="line">    &#123;</span><br><span class="line">        password[k] ^= password[k + 1];</span><br><span class="line">        password[k + 1] ^= password[k];</span><br><span class="line">        password[k] ^= password[k + 1];</span><br><span class="line">        k += 2;</span><br><span class="line">    &#125;</span><br><span class="line">    return password_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public encode2(password[], password_len)</span><br><span class="line">&#123;</span><br><span class="line">    new var1;</span><br><span class="line">    new var2 = 0;</span><br><span class="line">    while (var2 &lt; password_len)</span><br><span class="line">    &#123;</span><br><span class="line">        TrieGetCell(parts, fmt(&quot;%02x&quot;, password[var2]), var1);</span><br><span class="line">        password[var2] = var1;</span><br><span class="line">        var2++;</span><br><span class="line">    &#125;</span><br><span class="line">    return password_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public encode3(password[], password_len)</span><br><span class="line">&#123;</span><br><span class="line">    new random_value = 0x301a;</span><br><span class="line"></span><br><span class="line">    new i = 0;</span><br><span class="line">    while (i &lt; password_len)</span><br><span class="line">    &#123;</span><br><span class="line">        random_value = password[i] * 57005 + random_value;</span><br><span class="line">        random_value += 1;</span><br><span class="line">        random_value %= 4096;</span><br><span class="line">        password[i] = random_value;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    return password_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public encode_password(id, password[], len, output[], out_len)</span><br><span class="line">&#123;</span><br><span class="line">    new bytes_str[512];</span><br><span class="line">    new local_copy[256];</span><br><span class="line">    new new_len = len;</span><br><span class="line"></span><br><span class="line">    copy(local_copy, 255, password);</span><br><span class="line">    new_len = encode1(id, local_copy, new_len);</span><br><span class="line">    new_len = encode2(local_copy, new_len);</span><br><span class="line">    new_len = encode3(local_copy, new_len);</span><br><span class="line"></span><br><span class="line">    new j;</span><br><span class="line">    while (j &lt; new_len)</span><br><span class="line">    &#123;</span><br><span class="line">        add(bytes_str, 511, fmt(&quot;%04x&quot;, local_copy[j]), 4);</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line">    log_amx(bytes_str);    // output ciphertext to game console</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public handle_password_input(id)</span><br><span class="line">&#123;</span><br><span class="line">    new encoded[512];</span><br><span class="line">    new password[192];</span><br><span class="line"></span><br><span class="line">    new password_len = read_argv(1, password, 191);</span><br><span class="line">    encode_password(id, password, password_len, encoded, 511);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public reg_func(id)</span><br><span class="line">&#123;</span><br><span class="line">    client_cmd(id, &quot;messagemode passwd&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Later-Story"><a href="#Later-Story" class="headerlink" title="Later Story"></a>Later Story</h2><p>I’m so excited that the challenge author - <code>Rivit</code> - praised my Writeup:</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/23.png" alt="challenge_author_reply"></p>
<p>What’s more interesting is that the author of <code>lysis-java</code> is also playing this CTF game. There’s no wonder why their team got the first blood of <code>AMXX</code> so fast lol</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/article/20220614/24.png" alt="lysis_java_repo_with_discord_post"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">in1t@r3kapig</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://in1t.top/2022/06/14/justCTF-2022-AMXX/">https://in1t.top/2022/06/14/justCTF-2022-AMXX/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://in1t.top" target="_blank">in1t's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%80%86%E5%90%91/">逆向</a><a class="post-meta__tags" href="/tags/Writeup/">Writeup</a></div><div class="post_share"><div class="social-share" data-image="/img/cover/justctf2022.png" data-sites="wechat,qq,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/01/04/CVE-2021-1732%E5%AE%8C%E5%85%A8%E6%94%BB%E7%95%A5/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/cve-2021-1732.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">CVE-2021-1732完全攻略</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/02/03/buuoj-逆向刷题之旅（三）/" title="buuoj 逆向刷题之旅（三）"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/buuojre3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-03</div><div class="title">buuoj 逆向刷题之旅（三）</div></div></a></div><div><a href="/2020/11/28/buuoj-逆向刷题之旅（二）/" title="buuoj 逆向刷题之旅（二）"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/buuojre2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-28</div><div class="title">buuoj 逆向刷题之旅（二）</div></div></a></div><div><a href="/2020/11/10/buuoj-逆向刷题之旅（一）/" title="buuoj 逆向刷题之旅（一）"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/buuojre1.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-10</div><div class="title">buuoj 逆向刷题之旅（一）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Method-Selection"><span class="toc-number">2.</span> <span class="toc-text">Method Selection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tool-Fixup"><span class="toc-number">3.</span> <span class="toc-text">Tool Fixup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analysis"><span class="toc-number">4.</span> <span class="toc-text">Analysis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Tool-Modification"><span class="toc-number">5.</span> <span class="toc-text">Tool Modification</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Solve"><span class="toc-number">6.</span> <span class="toc-text">Solve</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Later-Story"><span class="toc-number">7.</span> <span class="toc-text">Later Story</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/img/cover/justctf2022.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By in1t@r3kapig</div><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-orange?style=flat&logo=bitdefender" title="主题采用butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Source-Github-brightgreen?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a><a style="margin-inline:5px" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);</script><div class="js-pjax"></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="/js/modify.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="💐,🌸,💮,🏵,🌹,🥀,🌺,🌻,🌼,🌷,🌱,🌲,🌳,🌴,🌵,🌾,🌿,☘,🍀,🍁,🍂,🍃,🍇,🍈,🍉,🍊,🍋,🍌,🍍,🍎,🍏,🍐,🍑,🍒,🍓,🥝,🍅,🥥,🥑,🍆,🥔,🥕,🌽,🌶,🥒,🥬,🥦,🧄,🧅,🍄,🥜,🌰,🍞,🥐,🥖,🥨,🥯,🥞,🧇,🧀,🍖,🍗,🥩,🥓,🍔,🍟,🍕,🌭,🥪,🌮,🌯,🥙,🧆,🥚,🍳,🥘,🍲,🥣,🥗,🍿,🧈,🧂,🥫,🍱,🍘,🍙,🍚,🍛,🍜,🍠,🍢,🍣,🍤,🍥,🥮,🍡,🥟,🥠,🥡,🦪,🍨,🍩,🍪,🎂,🍰,🧁,🥧,🍫,🍬,🍭,🍮,🍯,🍼,🥛,☕,🍵,🍶,🍾,🍷,🍹,🍻,🥂,🥃,🥤,🧃,🧉,🧊,🥢,🍽,🥄" data-fontsize="20px" data-random="false" async="async"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":20,"vOffset":-65},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>