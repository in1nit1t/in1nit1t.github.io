<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Linux内核源码阅读--kernel（一） | in1t's blog</title><meta name="keywords" content="操作系统,Linux0.11"><meta name="author" content="in1t@r3kapig"><meta name="copyright" content="in1t@r3kapig"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="上一篇文章说到 main.c 完成了所有的初始化并打开了登录 shell，现在就来具体分析每个初始化函数的实现细节">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux内核源码阅读--kernel（一）">
<meta property="og:url" content="https://in1t.top/2020/03/27/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-kernel%EF%BC%88%E4%B8%80%EF%BC%89/index.html">
<meta property="og:site_name" content="in1t&#39;s blog">
<meta property="og:description" content="上一篇文章说到 main.c 完成了所有的初始化并打开了登录 shell，现在就来具体分析每个初始化函数的实现细节">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://in1t.top/img/cover/kernel1.jpg">
<meta property="article:published_time" content="2020-03-27T09:17:44.000Z">
<meta property="article:modified_time" content="2021-07-07T08:21:32.587Z">
<meta property="article:author" content="in1t@r3kapig">
<meta property="article:tag" content="操作系统">
<meta property="article:tag" content="Linux0.11">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://in1t.top/img/cover/kernel1.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://in1t.top/2020/03/27/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-kernel%EF%BC%88%E4%B8%80%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Linux内核源码阅读--kernel（一）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-07 16:21:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fas fa-play-circle"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cover/kernel1.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">in1t's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fas fa-play-circle"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Linux内核源码阅读--kernel（一）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-03-27T09:17:44.000Z" title="发表于 2020-03-27 17:17:44">2020-03-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-07T08:21:32.587Z" title="更新于 2021-07-07 16:21:32">2021-07-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>20分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>上一篇文章说到 main.c 完成了所有的初始化并打开了登录 shell，现在就来具体分析每个初始化函数的实现细节。先整个 trap_init (main.c Line 128) 函数看看，该函数主要涉及 kernel 目录下的这些文件：</p>
<ul>
<li>asm.s</li>
<li>trap.c</li>
<li>system_call.s</li>
</ul>
<p>首先，trap_init 是定义在 trap.c 第 181 行的，该函数设置了各硬件异常的处理中断向量，set_trap_gate 与 set_system_gate 的区别在于前者设置的特权级为 0，后者为 3。因此由 set_system_gate 设置的 3，4，5 号陷阱门可以由任何程序调用。这两个函数的第一个参数是中断号，第二个参数是中断<strong>预处理</strong>程序的地址。trap_init 中涉及的中断处理程序除了 page_fault 定义在 mm/page.s 之外，其余都定义在 kernel 目录下的 asm.s 与 system_call.s 中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// trap.c Line 181</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trap_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	set_trap_gate(<span class="number">0</span>,&amp;divide_error);		<span class="comment">// 除数为 0 时产生</span></span><br><span class="line">	set_trap_gate(<span class="number">1</span>,&amp;debug);		<span class="comment">// 程序单步跟踪调试，EFLAGS 的 T 标志为 1 时产生该中断</span></span><br><span class="line">	set_trap_gate(<span class="number">2</span>,&amp;nmi);			<span class="comment">// 由不可屏蔽中断 NMI 产生</span></span><br><span class="line">	set_system_gate(<span class="number">3</span>,&amp;int3);		<span class="comment">// 断点指令 INT 3 产生，与 debug 处理相同</span></span><br><span class="line">	set_system_gate(<span class="number">4</span>,&amp;overflow);		<span class="comment">// OF 标志位引发</span></span><br><span class="line">	set_system_gate(<span class="number">5</span>,&amp;bounds);		<span class="comment">// 未通过地址边界检查引发</span></span><br><span class="line">	set_trap_gate(<span class="number">6</span>,&amp;invalid_op);		<span class="comment">// 无效指令的操作码(opcode)</span></span><br><span class="line">	set_trap_gate(<span class="number">7</span>,&amp;device_not_available);	<span class="comment">// 协处理器设备不存在</span></span><br><span class="line">	set_trap_gate(<span class="number">8</span>,&amp;double_fault);		<span class="comment">// 双中断出错</span></span><br><span class="line">	set_trap_gate(<span class="number">9</span>,&amp;coprocessor_segment_overrun);	<span class="comment">// 协处理器段超出</span></span><br><span class="line">	set_trap_gate(<span class="number">10</span>,&amp;invalid_TSS);		<span class="comment">// 无效 TSS 引发</span></span><br><span class="line">	set_trap_gate(<span class="number">11</span>,&amp;segment_not_present);	<span class="comment">// 选择子指示的段不存在</span></span><br><span class="line">	set_trap_gate(<span class="number">12</span>,&amp;stack_segment);	<span class="comment">// 堆栈段不存在或寻址超出堆栈段</span></span><br><span class="line">	set_trap_gate(<span class="number">13</span>,&amp;general_protection);	<span class="comment">// 未通过特权级保护检查引发</span></span><br><span class="line">	set_trap_gate(<span class="number">14</span>,&amp;page_fault);		<span class="comment">// 页错误</span></span><br><span class="line">	set_trap_gate(<span class="number">15</span>,&amp;reserved);		<span class="comment">// 保留</span></span><br><span class="line">	set_trap_gate(<span class="number">16</span>,&amp;coprocessor_error);	<span class="comment">// 协处理器发出 error 信号引发</span></span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">17</span>;i&lt;<span class="number">48</span>;i++)</span><br><span class="line">		set_trap_gate(i,&amp;reserved);	<span class="comment">// 17 ~ 47 均先设置为保留</span></span><br><span class="line">	set_trap_gate(<span class="number">45</span>,&amp;irq13);		<span class="comment">// 协处理器中断</span></span><br><span class="line">	outb_p(inb_p(<span class="number">0x21</span>)&amp;<span class="number">0xfb</span>,<span class="number">0x21</span>);		<span class="comment">// 允许 8259A 主片的 IRQ2 中断请求</span></span><br><span class="line">	outb(inb_p(<span class="number">0xA1</span>)&amp;<span class="number">0xdf</span>,<span class="number">0xA1</span>);		<span class="comment">// 允许 8259A 从片的 IRQ13 中断请求</span></span><br><span class="line">	set_trap_gate(<span class="number">39</span>,&amp;parallel_interrupt);	<span class="comment">// 设置并行口 1 的中断向量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>set_trap_gate 与 set_system_gate 定义在 include/asm/system.h 中，它们都调用了 _set_gate 用于将中断描述符填入对应的 IDT 表项中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/asm/system.h Line 22</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _set_gate(gate_addr,type,dpl,addr) \</span></span><br><span class="line"><span class="meta">__asm__ (<span class="meta-string">&quot;movw %%dx,%%ax\n\t&quot;</span> \		<span class="comment">// ax = dx = 中断处理程序地址低 16 位</span></span></span><br><span class="line">	<span class="string">&quot;movw %0,%%dx\n\t&quot;</span> \		<span class="comment">// dx = 描述符高 4 字节的低 16 位</span></span><br><span class="line">	<span class="string">&quot;movl %%eax,%1\n\t&quot;</span> \		<span class="comment">// 此时 eax 为描述符低 4 字节，放入 IDT 表项低 4 字节</span></span><br><span class="line">	<span class="string">&quot;movl %%edx,%2&quot;</span> \		<span class="comment">// edx 为描述符高 4 字节，放入 IDT 表项高 4 字节</span></span><br><span class="line">	: \</span><br><span class="line">	: <span class="string">&quot;i&quot;</span> ((<span class="keyword">short</span>) (<span class="number">0x8000</span>+(dpl&lt;&lt;<span class="number">13</span>)+(type&lt;&lt;<span class="number">8</span>))), \	<span class="comment">// 对应 %0，P 位为 1，DPL 与 TYPE 移到相应位</span></span><br><span class="line">	<span class="string">&quot;o&quot;</span> (*((<span class="keyword">char</span> *) (gate_addr))), \		<span class="comment">// 限定符 o 表示内存单元，%1 指的就是这个内存单元</span></span><br><span class="line">	<span class="string">&quot;o&quot;</span> (*(<span class="number">4</span>+(<span class="keyword">char</span> *) (gate_addr))), \		<span class="comment">// 这是 %2 对应的内存单元</span></span><br><span class="line">	<span class="string">&quot;d&quot;</span> ((<span class="keyword">char</span> *) (addr)),<span class="string">&quot;a&quot;</span> (<span class="number">0x00080000</span>))		<span class="comment">// edx = (char *)addr，eax = 0x00080000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Line 36</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_trap_gate(n,addr) \		<span class="comment">// &amp;idt[n] 表示 IDT 第 n 项描述符的地址，15 表示陷阱门</span></span></span><br><span class="line">	_set_gate(&amp;idt[n],<span class="number">15</span>,<span class="number">0</span>,addr)	<span class="comment">// 0 表示特权级为 0，addr 为中断处理程序的地址</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> set_system_gate(n,addr) \</span></span><br><span class="line"><span class="meta">	_set_gate(&amp;idt[n],15,3,addr)	<span class="comment">// 这里特权级为 3</span></span></span><br></pre></td></tr></table></figure>

<p>以上是填写 IDT 中断描述符的过程，现在来看这些中断服务程序是怎么实现的，先看 asm.s。因为有的中断过程会产生错误号，故不产生错误号与产生错误号的中断过程预处理方式有一些区别，如图所示（上为高地址）：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="../img/a1.png" alt="有无错误号的栈"><br>以没有错误号为例，int 指令会将 ss esp eflags cs eip 依次压入栈中，然后预处理程序压入各寄存器保存现场，同时将真正的中断服务程序的地址赋给 eax，再将 0 压入栈中来占位，最后压入一个指向中断返回地址的指针</p>
<br>

<h2 id="asm-s"><a href="#asm-s" class="headerlink" title="asm.s"></a>asm.s</h2><p>以下为 asm.s 中无错误号的中断预处理程序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">/* Line 14 */</span><br><span class="line">.globl divide_error,debug,nmi,int3,overflow,bounds,invalid_op</span><br><span class="line">.globl double_fault,coprocessor_segment_overrun</span><br><span class="line">.globl invalid_TSS,segment_not_present,stack_segment</span><br><span class="line">.globl general_protection,coprocessor_error,irq13,reserved		/* 首先定义了这些全局标识符 */</span><br><span class="line"></span><br><span class="line">divide_error:			/* 0 号中断 */</span><br><span class="line">	pushl $do_divide_error	/* 将实际处理 0 号中断的程序压栈 */</span><br><span class="line">no_error_code:			/* 没有错误码的处理，这里以 divide_error 为例 */</span><br><span class="line">	xchgl %eax,(%esp)	/* xchg 交换两个操作数内容，即 eax = &amp;do_divide_error，eax 交换入栈 */</span><br><span class="line">	pushl %ebx</span><br><span class="line">	pushl %ecx</span><br><span class="line">	pushl %edx</span><br><span class="line">	pushl %edi</span><br><span class="line">	pushl %esi</span><br><span class="line">	pushl %ebp</span><br><span class="line">	push %ds</span><br><span class="line">	push %es</span><br><span class="line">	push %fs		/* 保存现场 */</span><br><span class="line">	pushl $0		/* 错误码用 0 填充 */</span><br><span class="line">	lea 44(%esp),%edx	/* esp + 44 指向返回地址 */</span><br><span class="line">	pushl %edx		/* 将该指针压入栈中 */</span><br><span class="line">	movl $0x10,%edx		/* 加载内核数据段选择符至 ds，es，fs */</span><br><span class="line">	mov %dx,%ds</span><br><span class="line">	mov %dx,%es</span><br><span class="line">	mov %dx,%fs</span><br><span class="line">	call *%eax		/* 调用 do_divide_error */</span><br><span class="line">	addl $8,%esp		/* 栈平衡 */</span><br><span class="line">	pop %fs</span><br><span class="line">	pop %es</span><br><span class="line">	pop %ds</span><br><span class="line">	popl %ebp</span><br><span class="line">	popl %esi</span><br><span class="line">	popl %edi</span><br><span class="line">	popl %edx</span><br><span class="line">	popl %ecx</span><br><span class="line">	popl %ebx</span><br><span class="line">	popl %eax		/* 还原现场 */</span><br><span class="line">	iret			/* 中断返回 */</span><br><span class="line"></span><br><span class="line">debug:				/* 1 号中断，处理方式与 3 号中断相同 */</span><br><span class="line">	pushl $do_int3	/* 同样先压处理函数 */</span><br><span class="line">	jmp no_error_code	/* 再跳到 no_error_code，以下同理 */</span><br><span class="line"></span><br><span class="line">nmi:				/* 2 号中断 */</span><br><span class="line">	pushl $do_nmi</span><br><span class="line">	jmp no_error_code</span><br><span class="line"></span><br><span class="line">int3:				/* 3 号中断  */</span><br><span class="line">	pushl $do_int3</span><br><span class="line">	jmp no_error_code</span><br><span class="line"></span><br><span class="line">overflow:			/* 4 号中断  */</span><br><span class="line">	pushl $do_overflow</span><br><span class="line">	jmp no_error_code</span><br><span class="line"></span><br><span class="line">bounds:				/* 5 号中断  */</span><br><span class="line">	pushl $do_bounds</span><br><span class="line">	jmp no_error_code</span><br><span class="line"></span><br><span class="line">invalid_op:			/* 6 号中断  */</span><br><span class="line">	pushl $do_invalid_op</span><br><span class="line">	jmp no_error_code</span><br><span class="line"></span><br><span class="line">coprocessor_segment_overrun:	/* 9 号中断  */</span><br><span class="line">	pushl $do_coprocessor_segment_overrun</span><br><span class="line">	jmp no_error_code</span><br><span class="line"></span><br><span class="line">reserved:			/* 15 号中断，同时也是其它保留中断的入口  */</span><br><span class="line">	pushl $do_reserved</span><br><span class="line">	jmp no_error_code</span><br></pre></td></tr></table></figure>

<p>然后是关于数学协处理器的硬件中断处理，coprocessor_error 定义在 system_call.s 中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/* Line 85 */</span><br><span class="line">irq13:				/* 45 号中断 */</span><br><span class="line">	pushl %eax		/* 保存 eax */</span><br><span class="line">	xorb %al,%al</span><br><span class="line">	outb %al,$0xF0</span><br><span class="line">	movb $0x20,%al</span><br><span class="line">	outb %al,$0x20		/* 向 8259A 主片发送中断结束（EOI）信号 */</span><br><span class="line">	jmp 1f</span><br><span class="line">1:	jmp 1f</span><br><span class="line">1:	outb %al,$0xA0		/* 向 8259A 从片发送中断结束信号 */</span><br><span class="line">	popl %eax		/* 还原 eax 的值 */</span><br><span class="line">	jmp coprocessor_error	/* 在 system_call.s 中 */</span><br></pre></td></tr></table></figure>

<p>asm.s 最后部分是对于有错误号中断的处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">double_fault:			/* 8 号中断 */</span><br><span class="line">	pushl $do_double_fault</span><br><span class="line">error_code:</span><br><span class="line">	xchgl %eax,4(%esp)	/* eax = 错误号，eax 原值入栈 */</span><br><span class="line">	xchgl %ebx,(%esp)	/* ebx = 处理函数地址，ebx 原值入栈 */</span><br><span class="line">	pushl %ecx</span><br><span class="line">	pushl %edx</span><br><span class="line">	pushl %edi</span><br><span class="line">	pushl %esi</span><br><span class="line">	pushl %ebp</span><br><span class="line">	push %ds</span><br><span class="line">	push %es</span><br><span class="line">	push %fs		/* 保存现场 */</span><br><span class="line">	pushl %eax		/* 错误号 */</span><br><span class="line">	lea 44(%esp),%eax	/* esp + 44 指向中断返回地址 */</span><br><span class="line">	pushl %eax		/* 入栈 */</span><br><span class="line">	movl $0x10,%eax		/* ds，es，fs 指向内核数据段 */</span><br><span class="line">	mov %ax,%ds</span><br><span class="line">	mov %ax,%es</span><br><span class="line">	mov %ax,%fs</span><br><span class="line">	call *%ebx		/* 调用中断处理函数 */</span><br><span class="line">	addl $8,%esp		/* 栈平衡 */</span><br><span class="line">	pop %fs</span><br><span class="line">	pop %es</span><br><span class="line">	pop %ds</span><br><span class="line">	popl %ebp</span><br><span class="line">	popl %esi</span><br><span class="line">	popl %edi</span><br><span class="line">	popl %edx</span><br><span class="line">	popl %ecx</span><br><span class="line">	popl %ebx</span><br><span class="line">	popl %eax		/* 恢复现场*/</span><br><span class="line">	iret			/* 中断返回 */</span><br><span class="line"></span><br><span class="line">invalid_TSS:			/* 10 号中断 */</span><br><span class="line">	pushl $do_invalid_TSS</span><br><span class="line">	jmp error_code</span><br><span class="line"></span><br><span class="line">segment_not_present:	/* 11 号中断 */</span><br><span class="line">	pushl $do_segment_not_present</span><br><span class="line">	jmp error_code</span><br><span class="line"></span><br><span class="line">stack_segment:			/* 12 号中断 */</span><br><span class="line">	pushl $do_stack_segment</span><br><span class="line">	jmp error_code</span><br><span class="line"></span><br><span class="line">general_protection:		/* 13 号中断 */</span><br><span class="line">	pushl $do_general_protection</span><br><span class="line">	jmp error_code</span><br></pre></td></tr></table></figure>

<br>

<h2 id="system-call-s"><a href="#system-call-s" class="headerlink" title="system_call.s"></a>system_call.s</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/* Line 33 */</span><br><span class="line">SIG_CHLD	= 17		/* SIG_CHLD 信号 */</span><br><span class="line"></span><br><span class="line">EAX		= 0x00		/* 栈中各保存寄存器相对 esp 的偏移 */</span><br><span class="line">EBX		= 0x04</span><br><span class="line">ECX		= 0x08</span><br><span class="line">EDX		= 0x0C</span><br><span class="line">FS		= 0x10</span><br><span class="line">ES		= 0x14</span><br><span class="line">DS		= 0x18</span><br><span class="line">EIP		= 0x1C</span><br><span class="line">CS		= 0x20</span><br><span class="line">EFLAGS		= 0x24</span><br><span class="line">OLDESP		= 0x28</span><br><span class="line">OLDSS		= 0x2C</span><br><span class="line"></span><br><span class="line">/* task_stuct 结构体各字段在结构体中的偏移值 */</span><br><span class="line">state	= 0			/* 进程状态码 */</span><br><span class="line">counter	= 4			/* 时间片 */</span><br><span class="line">priority = 8			/* 运行优先数 */</span><br><span class="line">signal	= 12			/* 信号位图 */</span><br><span class="line">sigaction = 16			/* sigaction 结构体长度为 16 字节 */</span><br><span class="line">blocked = (33*16)		/* 受阻塞信号位图的偏移量 */</span><br><span class="line"></span><br><span class="line">/* sigaction 结构体各字段在结构体中的偏移值 */</span><br><span class="line">sa_handler = 0			/* 信号处理过程的句柄 */</span><br><span class="line">sa_mask = 4			/* 信号屏蔽码 */</span><br><span class="line">sa_flags = 8			/* 信号集 */</span><br><span class="line">sa_restorer = 12		/* 恢复函数指针 */</span><br><span class="line"></span><br><span class="line">nr_system_calls = 86	/* 系统调用总数 */</span><br></pre></td></tr></table></figure>

<p>nr_system_calls 表示提供的系统调用总数。Linux 系统对外仅提供 int 0x80 指令来调用系统中断服务程序，eax 中为中断号，该中断号不能超出 85（nr_system_calls 从 1 计数），ebx，ecx，edx 用于传递参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">/* Line 67 */</span><br><span class="line">.globl system_call,sys_fork,timer_interrupt,sys_execve</span><br><span class="line">.globl hd_interrupt,floppy_interrupt,parallel_interrupt</span><br><span class="line">.globl device_not_available, coprocessor_error			/* 定义全局描述符 */</span><br><span class="line"></span><br><span class="line">.align 4</span><br><span class="line">bad_sys_call:			/* 处理中断号超出系统调用总数的中断请求 */</span><br><span class="line">	movl $-1,%eax		/* eax 赋值 -1，直接中断返回 */</span><br><span class="line">	iret</span><br><span class="line">.align 4</span><br><span class="line">reschedule:			/* 重新执行调度程序 */</span><br><span class="line">	pushl $ret_from_sys_call	/* 调度程序返回时来到 ret_from_sys_call 执行 */</span><br><span class="line">	jmp schedule		/* 定义在 kernel/sched.c */</span><br><span class="line">.align 4</span><br><span class="line">system_call:			/* int 0x80 对应的中断处理程序 */</span><br><span class="line">	cmpl $nr_system_calls-1,%eax	/* 判断是否超出系统调用总数 */</span><br><span class="line">	ja bad_sys_call		/* 超出了跳到 bad_sys_call */</span><br><span class="line">	push %ds</span><br><span class="line">	push %es</span><br><span class="line">	push %fs</span><br><span class="line">	pushl %edx</span><br><span class="line">	pushl %ecx</span><br><span class="line">	pushl %ebx		/* edx，ecx，ebx 压参作为系统调用的参数 */</span><br><span class="line">	movl $0x10,%edx		/* ds，es 指向内核数据段 */</span><br><span class="line">	mov %dx,%ds</span><br><span class="line">	mov %dx,%es</span><br><span class="line">	movl $0x17,%edx		/* fs 指向局部数据段 */</span><br><span class="line">	mov %dx,%fs</span><br><span class="line">	call sys_call_table(,%eax,4)	/* 调用 sys_call_table[4 * eax] */</span><br><span class="line">	pushl %eax		/* 系统调用返回值入栈 */</span><br><span class="line">	movl current,%eax	/* eax = 当前任务结构体指针 */</span><br><span class="line">	cmpl $0,state(%eax)	/* 判断当前任务是否在就绪状态 */</span><br><span class="line">	jne reschedule		/* 不在的话执行调度程序 */</span><br><span class="line">	cmpl $0,counter(%eax)	/* 判断当前任务时间片是否用完 */</span><br><span class="line">	je reschedule		/* 用完也执行调度程序 */</span><br><span class="line">ret_from_sys_call:		/* 否则从中断返回继续执行调度选出的当前任务 */</span><br><span class="line">	movl current,%eax	/* 取当前任务的结构体指针 */</span><br><span class="line">	cmpl task,%eax		/* 与 task[0] 的地址进行比较，判断是否为进程 0 */</span><br><span class="line">	je 3f			/* 如果是进程 0，就不需要进行信号处理，直接返回 */</span><br><span class="line">	cmpw $0x0f,CS(%esp)	/* 判断原调用程序的代码段选择子是否为 0x0f(RPL=3，LDT，代码段) */</span><br><span class="line">	jne 3f			/* 来确定是否为用户任务，如果是某个中断服务程序则直接返回 */</span><br><span class="line">	cmpw $0x17,OLDSS(%esp)	/* 如果原调用程序的堆栈选择符不在用户(局部)段中，也直接返回 */</span><br><span class="line">	jne 3f</span><br><span class="line">	movl signal(%eax),%ebx	/* ebx = 当前任务信号位图 */</span><br><span class="line">	movl blocked(%eax),%ecx	/* ecx = 阻塞(屏蔽)信号位图 */</span><br><span class="line">	notl %ecx		/* 按位取反得到允许的信号位图 */</span><br><span class="line">	andl %ebx,%ecx		/* 与当前任务信号位图按位与，得到本次中断处理后的信号位图 */</span><br><span class="line">	bsfl %ecx,%ecx		/* 从 0 位开始扫描位图，遇到有 1 的位将其偏移(0-31 位)保存在 ecx 中 */</span><br><span class="line">	je 3f			/* 如果没有信号则直接返回 */</span><br><span class="line">	btrl %ecx,%ebx		/* 将 ebx 第 ecx 位复位（ebx 为原当前任务信号位图） */</span><br><span class="line">	movl %ebx,signal(%eax)	/* 重新设置当前任务位图 */</span><br><span class="line">	incl %ecx		/* 将信号值范围调整为 1 ~ 32 */</span><br><span class="line">	pushl %ecx		/* 压栈作为 do_signal 的参数 */</span><br><span class="line">	call do_signal</span><br><span class="line">	popl %eax</span><br><span class="line">3:	popl %eax</span><br><span class="line">	popl %ebx</span><br><span class="line">	popl %ecx</span><br><span class="line">	popl %edx</span><br><span class="line">	pop %fs</span><br><span class="line">	pop %es</span><br><span class="line">	pop %ds			/* 恢复现场 */</span><br><span class="line">	iret			/* 中断返回 */</span><br></pre></td></tr></table></figure>

<p>sys_call_table 数组定义在 linux/sys.h 中，每个元素对应其中断服务程序的入口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// linux/sys.h Line 93</span></span><br><span class="line">fn_ptr sys_call_table[] = &#123; sys_setup, sys_exit, sys_fork, sys_read,</span><br><span class="line">sys_write, sys_open, sys_close, sys_waitpid, sys_creat, sys_link,</span><br><span class="line">sys_unlink, sys_execve, sys_chdir, sys_time, sys_mknod, sys_chmod,</span><br><span class="line">sys_chown, sys_break, sys_stat, sys_lseek, sys_getpid, sys_mount,</span><br><span class="line">sys_umount, sys_setuid, sys_getuid, sys_stime, sys_ptrace, sys_alarm,</span><br><span class="line">sys_fstat, sys_pause, sys_utime, sys_stty, sys_gtty, sys_access,</span><br><span class="line">sys_nice, sys_ftime, sys_sync, sys_kill, sys_rename, sys_mkdir,</span><br><span class="line">sys_rmdir, sys_dup, sys_pipe, sys_times, sys_prof, sys_brk, sys_setgid,</span><br><span class="line">sys_getgid, sys_signal, sys_geteuid, sys_getegid, sys_acct, sys_phys,</span><br><span class="line">sys_lock, sys_ioctl, sys_fcntl, sys_mpx, sys_setpgid, sys_ulimit,</span><br><span class="line">sys_uname, sys_umask, sys_chroot, sys_ustat, sys_dup2, sys_getppid,</span><br><span class="line">sys_getpgrp, sys_setsid, sys_sigaction, sys_sgetmask, sys_ssetmask,</span><br><span class="line">sys_setreuid,sys_setregid, sys_sigsuspend, sys_sigpending, sys_sethostname,</span><br><span class="line">sys_setrlimit, sys_getrlimit, sys_getrusage, sys_gettimeofday, </span><br><span class="line">sys_settimeofday, sys_getgroups, sys_setgroups, sys_select, sys_symlink,</span><br><span class="line">sys_lstat, sys_readlink, sys_uselib &#125;;</span><br></pre></td></tr></table></figure>

<p>然后是 system_call.s 的剩余部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">/* Line 130 */</span><br><span class="line">.align 4</span><br><span class="line">coprocessor_error:		/* 45号中断，从 asm.s 跳过来执行 */</span><br><span class="line">	push %ds</span><br><span class="line">	push %es</span><br><span class="line">	push %fs</span><br><span class="line">	pushl %edx</span><br><span class="line">	pushl %ecx</span><br><span class="line">	pushl %ebx</span><br><span class="line">	pushl %eax		/* 保存现场 */</span><br><span class="line">	movl $0x10,%eax		/* ds，es 指向内核数据段 */</span><br><span class="line">	mov %ax,%ds</span><br><span class="line">	mov %ax,%es</span><br><span class="line">	movl $0x17,%eax		/* fs 指向局部数据段 */</span><br><span class="line">	mov %ax,%fs</span><br><span class="line">	pushl $ret_from_sys_call	/* 作为 math_error 的返回地址 */</span><br><span class="line">	jmp math_error		/* 定义在 kernel/math/error.c 中 */</span><br><span class="line"></span><br><span class="line">.align 2</span><br><span class="line">/* 7 号中断，触发该中断的情况有两种，一是当 CR0 中 的 EM 位置位，CPU 执行了一个协处理器指令，</span><br><span class="line"> * 该中断用于模拟导致异常的指令；二是 CR0 的 MP 与 TS 置位，CPU 遇到一个协处理器指令或 WAIT，</span><br><span class="line"> * 该中断用于更新协处理器状态</span><br><span class="line"> */</span><br><span class="line">device_not_available:</span><br><span class="line">	push %ds</span><br><span class="line">	push %es</span><br><span class="line">	push %fs</span><br><span class="line">	pushl %edx</span><br><span class="line">	pushl %ecx</span><br><span class="line">	pushl %ebx</span><br><span class="line">	pushl %eax		/* 保存现场 */</span><br><span class="line">	movl $0x10,%eax		/* ds，es 指向内核数据段 */</span><br><span class="line">	mov %ax,%ds</span><br><span class="line">	mov %ax,%es</span><br><span class="line">	movl $0x17,%eax		/* fs 指向局部数据段 */</span><br><span class="line">	mov %ax,%fs</span><br><span class="line">	pushl $ret_from_sys_call	/* 作为中断服务程序的返回地址 */</span><br><span class="line">	clts			/* TS 位复位 */</span><br><span class="line">	movl %cr0,%eax		/* 取 CR0内容 */</span><br><span class="line">	testl $0x4,%eax		/* 测试 EM 是否置位 */</span><br><span class="line">	je math_state_restore	/* 没有置位则恢复协处理器状态 */</span><br><span class="line">	pushl %ebp</span><br><span class="line">	pushl %esi</span><br><span class="line">	pushl %edi</span><br><span class="line">	call math_emulate	/* 否则执行数学仿真模拟程序 math_emulate */</span><br><span class="line">	popl %edi</span><br><span class="line">	popl %esi</span><br><span class="line">	popl %ebp</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">.align 4</span><br><span class="line">/* int 0x20 时钟中断，频率为 100Hz（include/linux/sched.h），即每 10 ms 触发一次 */</span><br><span class="line">timer_interrupt:</span><br><span class="line">	push %ds</span><br><span class="line">	push %es</span><br><span class="line">	push %fs</span><br><span class="line">	pushl %edx</span><br><span class="line">	pushl %ecx</span><br><span class="line">	pushl %ebx</span><br><span class="line">	pushl %eax		/* 保存现场 */</span><br><span class="line">	movl $0x10,%eax		/* ds，es 指向内核数据段 */</span><br><span class="line">	mov %ax,%ds</span><br><span class="line">	mov %ax,%es</span><br><span class="line">	movl $0x17,%eax		/* fs 指向局部数据段 */</span><br><span class="line">	mov %ax,%fs</span><br><span class="line">	incl jiffies		/* jiffies 自增 1 */ </span><br><span class="line">	movb $0x20,%al</span><br><span class="line">	outb %al,$0x20		/* 给 8259A 主片发送 EOI，结束本次中断 */</span><br><span class="line">	movl CS(%esp),%eax	/* 取保存的代码段选择子 */</span><br><span class="line">	andl $3,%eax		/* 将 CPL 保留下来 */</span><br><span class="line">	pushl %eax		/* 为调用 do_timer 压参 */</span><br><span class="line">	call do_timer		/* 定义在 kernel/sched.c 中，完成任务切换、计时等工作 */</span><br><span class="line">	addl $4,%esp		/* 栈平衡 */</span><br><span class="line">	jmp ret_from_sys_call	/* 跳去设置信号并返回 */</span><br><span class="line"></span><br><span class="line">.align 4</span><br><span class="line">sys_execve:			/* sys_execve 系统调用 */</span><br><span class="line">	lea EIP(%esp),%eax	/* 取保存的用户程序返回地址指针 */</span><br><span class="line">	pushl %eax		/* 压参 */</span><br><span class="line">	call do_execve</span><br><span class="line">	addl $4,%esp		/* 栈平衡 */</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">.align 4</span><br><span class="line">sys_fork:			/* sys_fork 系统调用，创建子进程 */</span><br><span class="line">	call find_empty_process	/* 为新进程寻找空闲的 pid 及空闲的任务号 */</span><br><span class="line">	testl %eax,%eax		/* 判断返回结果是否为负数 */</span><br><span class="line">	js 1f			/* 若为负数直接返回 */</span><br><span class="line">	push %gs		/* 否则压参，并调用 copy_process() */</span><br><span class="line">	pushl %esi</span><br><span class="line">	pushl %edi</span><br><span class="line">	pushl %ebp</span><br><span class="line">	pushl %eax</span><br><span class="line">	call copy_process</span><br><span class="line">	addl $20,%esp</span><br><span class="line">1:	ret</span><br><span class="line"></span><br><span class="line">hd_interrupt:			/* int 0x2E 硬盘中断 */</span><br><span class="line">	pushl %eax</span><br><span class="line">	pushl %ecx</span><br><span class="line">	pushl %edx</span><br><span class="line">	push %ds</span><br><span class="line">	push %es</span><br><span class="line">	push %fs		/* 保存现场 */</span><br><span class="line">	movl $0x10,%eax		/* ds，es 指向内核数据段 */</span><br><span class="line">	mov %ax,%ds</span><br><span class="line">	mov %ax,%es</span><br><span class="line">	movl $0x17,%eax		/* fs 指向局部数据段 */</span><br><span class="line">	mov %ax,%fs</span><br><span class="line">	movb $0x20,%al</span><br><span class="line">	outb %al,$0xA0		/* 向 8259A 主片发送 EOI */</span><br><span class="line">	jmp 1f			/* 起到延时作用 */</span><br><span class="line">1:	jmp 1f</span><br><span class="line">1:	xorl %edx,%edx		/* 清空 edx */</span><br><span class="line">	xchgl do_hd,%edx	/* 交换二者的值使得 do_hd 函数指针变为 NULL，而 edx = do_hd */</span><br><span class="line">	testl %edx,%edx		/* 测试该函数指针是否为空 */</span><br><span class="line">	jne 1f			/* 不为空就跳到 1f 处调用 do_hd */</span><br><span class="line">	movl $unexpected_hd_interrupt,%edx	/* 否则将 edx 指向 unexpected_hd_interrupt */</span><br><span class="line">1:	outb %al,$0x20		/* 向 8259A 主片发送 EOI */</span><br><span class="line">	call *%edx		/* 调用 edx 指向的函数 */</span><br><span class="line">	pop %fs</span><br><span class="line">	pop %es</span><br><span class="line">	pop %ds</span><br><span class="line">	popl %edx</span><br><span class="line">	popl %ecx</span><br><span class="line">	popl %eax		/* 恢复现场 */</span><br><span class="line">	iret			/* 中断返回 */</span><br><span class="line"></span><br><span class="line">floppy_interrupt:		/* int 0x26 软驱中断，处理方法与硬盘中断类似 */</span><br><span class="line">	pushl %eax</span><br><span class="line">	pushl %ecx</span><br><span class="line">	pushl %edx</span><br><span class="line">	push %ds</span><br><span class="line">	push %es</span><br><span class="line">	push %fs		/* 保存现场 */</span><br><span class="line">	movl $0x10,%eax		/* ds，es 指向内核数据段 */</span><br><span class="line">	mov %ax,%ds</span><br><span class="line">	mov %ax,%es</span><br><span class="line">	movl $0x17,%eax		/* fs 指向局部数据段 */</span><br><span class="line">	mov %ax,%fs</span><br><span class="line">	movb $0x20,%al</span><br><span class="line">	outb %al,$0x20		/* 向 8259A 主片发送 EOI */</span><br><span class="line">	xorl %eax,%eax</span><br><span class="line">	xchgl do_floppy,%eax</span><br><span class="line">	testl %eax,%eax</span><br><span class="line">	jne 1f</span><br><span class="line">	movl $unexpected_floppy_interrupt,%eax</span><br><span class="line">1:	call *%eax</span><br><span class="line">	pop %fs</span><br><span class="line">	pop %es</span><br><span class="line">	pop %ds</span><br><span class="line">	popl %edx</span><br><span class="line">	popl %ecx</span><br><span class="line">	popl %eax		/* 恢复现场 */</span><br><span class="line">	iret			/* 中断返回 */</span><br><span class="line"></span><br><span class="line">parallel_interrupt:		/* int 0x27 并行口中断 */</span><br><span class="line">	pushl %eax		/* 没有管这个中断，单纯发送一个 EOI */</span><br><span class="line">	movb $0x20,%al</span><br><span class="line">	outb %al,$0x20</span><br><span class="line">	popl %eax</span><br><span class="line">	iret</span><br></pre></td></tr></table></figure>

<br>

<h2 id="traps-c"><a href="#traps-c" class="headerlink" title="traps.c"></a>traps.c</h2><p>首先包含了一些头文件，定义了一些函数原型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Line 13</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span>		<span class="comment">// 包含一些头文件</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/head.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/system.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/segment.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Line 39</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_exit</span><span class="params">(<span class="keyword">long</span> code)</span></span>;		<span class="comment">//定义一些函数原型</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">page_exception</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">divide_error</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debug</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">nmi</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">int3</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">overflow</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bounds</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invalid_op</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">device_not_available</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">double_fault</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">coprocessor_segment_overrun</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invalid_TSS</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">segment_not_present</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">stack_segment</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">general_protection</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">page_fault</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">coprocessor_error</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reserved</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parallel_interrupt</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">irq13</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<p>接着定义了三个宏，分别用于从段指定位置中读取 1 个字节、读取 4  个字节和取 fs 段寄存器的值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Line 22</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> get_seg_byte(seg,addr) (&#123; \</span></span><br><span class="line"><span class="meta">register char __res; \</span></span><br><span class="line"><span class="meta">__asm__(<span class="meta-string">&quot;push %%fs;mov %%ax,%%fs;movb %%fs:%2,%%al;pop %%fs&quot;</span> \</span></span><br><span class="line"><span class="meta">	:<span class="meta-string">&quot;=a&quot;</span> (__res):<span class="meta-string">&quot;0&quot;</span> (seg),<span class="meta-string">&quot;m&quot;</span> (*(addr))); \</span></span><br><span class="line"><span class="meta">__res;&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> get_seg_long(seg,addr) (&#123; \</span></span><br><span class="line"><span class="meta">register unsigned long __res; \</span></span><br><span class="line"><span class="meta">__asm__(<span class="meta-string">&quot;push %%fs;mov %%ax,%%fs;movl %%fs:%2,%%eax;pop %%fs&quot;</span> \</span></span><br><span class="line"><span class="meta">	:<span class="meta-string">&quot;=a&quot;</span> (__res):<span class="meta-string">&quot;0&quot;</span> (seg),<span class="meta-string">&quot;m&quot;</span> (*(addr))); \</span></span><br><span class="line"><span class="meta">__res;&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _fs() (&#123; \</span></span><br><span class="line"><span class="meta">register unsigned short __res; \</span></span><br><span class="line"><span class="meta">__asm__(<span class="meta-string">&quot;mov %%fs,%%ax&quot;</span>:<span class="meta-string">&quot;=a&quot;</span> (__res):); \</span></span><br><span class="line"><span class="meta">__res;&#125;)</span></span><br></pre></td></tr></table></figure>

<p>然后定义一个 die 函数，用于输出中断/异常的信息，其三个参数分别为错误名称的字符串指针，出错而被中断的程序在栈中信息的指针（第一张图中的 esp0）及错误码。printk 定义在 kernel/printk.c 中，内核态下不能使用 printf，因其会改变 fs 的值，所以新定义了一个 printk 先将 fs 的值保存。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">char</span> * str,<span class="keyword">long</span> esp_ptr,<span class="keyword">long</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">long</span> * esp = (<span class="keyword">long</span> *) esp_ptr;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	printk(<span class="string">&quot;%s: %04x\n\r&quot;</span>,str,nr&amp;<span class="number">0xffff</span>);		<span class="comment">// 打印错误名及错误码低 2 字节</span></span><br><span class="line">	printk(<span class="string">&quot;EIP:\t%04x:%p\nEFLAGS:\t%p\nESP:\t%04x:%p\n&quot;</span>,</span><br><span class="line">		esp[<span class="number">1</span>],esp[<span class="number">0</span>],esp[<span class="number">2</span>],esp[<span class="number">4</span>],esp[<span class="number">3</span>]);	<span class="comment">// 打印用户任务的 CS:EIP EFLAGS SS:ESP</span></span><br><span class="line">	printk(<span class="string">&quot;fs: %04x\n&quot;</span>,_fs());		<span class="comment">// 打印 fs 的值，下一行打印段基址及段限长</span></span><br><span class="line">	printk(<span class="string">&quot;base: %p, limit: %p\n&quot;</span>,get_base(current-&gt;ldt[<span class="number">1</span>]),get_limit(<span class="number">0x17</span>));</span><br><span class="line">	<span class="keyword">if</span> (esp[<span class="number">4</span>] == <span class="number">0x17</span>) &#123;			<span class="comment">// 如果 ss 指向用户栈，则打印用户栈中 16 个字节的数据</span></span><br><span class="line">		printk(<span class="string">&quot;Stack: &quot;</span>);</span><br><span class="line">		<span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)</span><br><span class="line">			printk(<span class="string">&quot;%p &quot;</span>,get_seg_long(<span class="number">0x17</span>,i+(<span class="keyword">long</span> *)esp[<span class="number">3</span>]));</span><br><span class="line">		printk(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	str(i);				<span class="comment">// 取当前任务号存放在 i 中(include/linux/sched.h)</span></span><br><span class="line">	printk(<span class="string">&quot;Pid: %d, process nr: %d\n\r&quot;</span>,current-&gt;pid,<span class="number">0xffff</span> &amp; i);	<span class="comment">// 输出进程号及任务号</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)		<span class="comment">// 输出 CS:EIP 处 10 字节的内容</span></span><br><span class="line">		printk(<span class="string">&quot;%02x &quot;</span>,<span class="number">0xff</span> &amp; get_seg_byte(esp[<span class="number">1</span>],(i+(<span class="keyword">char</span> *)esp[<span class="number">0</span>])));</span><br><span class="line">	printk(<span class="string">&quot;\n\r&quot;</span>);</span><br><span class="line">	do_exit(<span class="number">11</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>紧接着定义 asm.s 中调用的那些 do 开头的中断处理程序，这些处理程序都通过 die 来输出信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Line 87</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_double_fault</span><span class="params">(<span class="keyword">long</span> esp, <span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;double fault&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_general_protection</span><span class="params">(<span class="keyword">long</span> esp, <span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;general protection&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_divide_error</span><span class="params">(<span class="keyword">long</span> esp, <span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;divide error&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Line 119</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_nmi</span><span class="params">(<span class="keyword">long</span> esp, <span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;nmi&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_debug</span><span class="params">(<span class="keyword">long</span> esp, <span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;debug&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_overflow</span><span class="params">(<span class="keyword">long</span> esp, <span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;overflow&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_bounds</span><span class="params">(<span class="keyword">long</span> esp, <span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;bounds&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_invalid_op</span><span class="params">(<span class="keyword">long</span> esp, <span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;invalid operand&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_device_not_available</span><span class="params">(<span class="keyword">long</span> esp, <span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;device not available&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_coprocessor_segment_overrun</span><span class="params">(<span class="keyword">long</span> esp, <span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;coprocessor segment overrun&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_invalid_TSS</span><span class="params">(<span class="keyword">long</span> esp,<span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;invalid TSS&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_segment_not_present</span><span class="params">(<span class="keyword">long</span> esp,<span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;segment not present&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_stack_segment</span><span class="params">(<span class="keyword">long</span> esp,<span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;stack segment&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_coprocessor_error</span><span class="params">(<span class="keyword">long</span> esp, <span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (last_task_used_math != current)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	die(<span class="string">&quot;coprocessor error&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_reserved</span><span class="params">(<span class="keyword">long</span> esp, <span class="keyword">long</span> error_code)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	die(<span class="string">&quot;reserved (15,17-47) error&quot;</span>,esp,error_code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中有一个例外，那就是 int 3 的处理程序，它的参数是进入中断后压入栈中的寄存器值，作用是输出寄存器值等信息方便调试</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_int3</span><span class="params">(<span class="keyword">long</span> * esp, <span class="keyword">long</span> error_code,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">long</span> fs,<span class="keyword">long</span> es,<span class="keyword">long</span> ds,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">long</span> ebp,<span class="keyword">long</span> esi,<span class="keyword">long</span> edi,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">long</span> edx,<span class="keyword">long</span> ecx,<span class="keyword">long</span> ebx,<span class="keyword">long</span> eax)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> tr;</span><br><span class="line"></span><br><span class="line">	__asm__(<span class="string">&quot;str %%ax&quot;</span>:<span class="string">&quot;=a&quot;</span> (tr):<span class="string">&quot;0&quot;</span> (<span class="number">0</span>));		<span class="comment">// tr = ax = 任务寄存器 TR 的值</span></span><br><span class="line">	printk(<span class="string">&quot;eax\t\tebx\t\tecx\t\tedx\n\r%8x\t%8x\t%8x\t%8x\n\r&quot;</span>,</span><br><span class="line">		eax,ebx,ecx,edx);</span><br><span class="line">	printk(<span class="string">&quot;esi\t\tedi\t\tebp\t\tesp\n\r%8x\t%8x\t%8x\t%8x\n\r&quot;</span>,</span><br><span class="line">		esi,edi,ebp,(<span class="keyword">long</span>) esp);</span><br><span class="line">	printk(<span class="string">&quot;\n\rds\tes\tfs\ttr\n\r%4x\t%4x\t%4x\t%4x\n\r&quot;</span>,</span><br><span class="line">		ds,es,fs,tr);</span><br><span class="line">	printk(<span class="string">&quot;EIP: %8x   CS: %4x  EFLAGS: %8x\n\r&quot;</span>,esp[<span class="number">0</span>],esp[<span class="number">1</span>],esp[<span class="number">2</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">in1t@r3kapig</a></span></div><div class="post-cover__authorid"><span class="post-copyright-meta">封面画师: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.pixiv.net/users/648285">648285</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://in1t.top/2020/03/27/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-kernel%EF%BC%88%E4%B8%80%EF%BC%89/">https://in1t.top/2020/03/27/Linux内核源码阅读-kernel（一）/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://in1t.top" target="_blank">in1t's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><a class="post-meta__tags" href="/tags/Linux0-11/">Linux0.11</a></div><div class="post_share"><div class="social-share" data-image="/img/cover/kernel1.jpg" data-sites="wechat,qq,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/03/30/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-kernel%EF%BC%88%E4%BA%8C%EF%BC%89/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/kernel2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux内核源码阅读-kernel（二）</div></div></a></div><div class="next-post pull-right"><a href="/2020/03/26/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%BB%E7%A8%8B%E5%BA%8F/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/initalmain.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Linux内核源码阅读--初始化主程序</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/04/11/Linux内核源码阅读-kernel（三）/" title="Linux内核源码阅读-kernel（三）"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/kernel3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-11</div><div class="title">Linux内核源码阅读-kernel（三）</div></div></a></div><div><a href="/2020/04/27/Linux内核源码阅读-mm/" title="Linux内核源码阅读-mm"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/mmmodule.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-27</div><div class="title">Linux内核源码阅读-mm</div></div></a></div><div><a href="/2020/04/13/Linux内核源码阅读-kernel（四）/" title="Linux内核源码阅读-kernel（四）"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/kernel4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-13</div><div class="title">Linux内核源码阅读-kernel（四）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#asm-s"><span class="toc-number">1.</span> <span class="toc-text">asm.s</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#system-call-s"><span class="toc-number">2.</span> <span class="toc-text">system_call.s</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#traps-c"><span class="toc-number">3.</span> <span class="toc-text">traps.c</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/img/cover/kernel1.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By in1t@r3kapig</div><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-orange?style=flat&logo=bitdefender" title="主题采用butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Source-Github-brightgreen?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a><a style="margin-inline:5px" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);</script><div class="js-pjax"></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="/js/modify.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="💐,🌸,💮,🏵,🌹,🥀,🌺,🌻,🌼,🌷,🌱,🌲,🌳,🌴,🌵,🌾,🌿,☘,🍀,🍁,🍂,🍃,🍇,🍈,🍉,🍊,🍋,🍌,🍍,🍎,🍏,🍐,🍑,🍒,🍓,🥝,🍅,🥥,🥑,🍆,🥔,🥕,🌽,🌶,🥒,🥬,🥦,🧄,🧅,🍄,🥜,🌰,🍞,🥐,🥖,🥨,🥯,🥞,🧇,🧀,🍖,🍗,🥩,🥓,🍔,🍟,🍕,🌭,🥪,🌮,🌯,🥙,🧆,🥚,🍳,🥘,🍲,🥣,🥗,🍿,🧈,🧂,🥫,🍱,🍘,🍙,🍚,🍛,🍜,🍠,🍢,🍣,🍤,🍥,🥮,🍡,🥟,🥠,🥡,🦪,🍨,🍩,🍪,🎂,🍰,🧁,🥧,🍫,🍬,🍭,🍮,🍯,🍼,🥛,☕,🍵,🍶,🍾,🍷,🍹,🍻,🥂,🥃,🥤,🧃,🧉,🧊,🥢,🍽,🥄" data-fontsize="20px" data-random="false" async="async"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":20,"vOffset":-65},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>