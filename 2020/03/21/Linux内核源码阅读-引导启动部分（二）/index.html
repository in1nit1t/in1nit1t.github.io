<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Linux内核源码阅读--引导启动部分（二） | in1t's blog</title><meta name="keywords" content="操作系统,Linux0.11"><meta name="author" content="in1t"><meta name="copyright" content="in1t"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="setup.s 的作用是保存一些重要参数，将 system 模块移到内存地址起始处，设置 GDTR 及 IDTR，打开 A20 地址线，编辑 8259A 芯片，CR0 寄存器 PE 位置 1，最后跳转至 head.s">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux内核源码阅读--引导启动部分（二）">
<meta property="og:url" content="http://in1nit1t.github.io/2020/03/21/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%BC%95%E5%AF%BC%E5%90%AF%E5%8A%A8%E9%83%A8%E5%88%86%EF%BC%88%E4%BA%8C%EF%BC%89/index.html">
<meta property="og:site_name" content="in1t&#39;s blog">
<meta property="og:description" content="setup.s 的作用是保存一些重要参数，将 system 模块移到内存地址起始处，设置 GDTR 及 IDTR，打开 A20 地址线，编辑 8259A 芯片，CR0 寄存器 PE 位置 1，最后跳转至 head.s">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://in1nit1t.github.io/img/cover/boot2.jpg">
<meta property="article:published_time" content="2020-03-21T07:57:57.000Z">
<meta property="article:modified_time" content="2021-07-07T08:20:24.028Z">
<meta property="article:author" content="in1t">
<meta property="article:tag" content="操作系统">
<meta property="article:tag" content="Linux0.11">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://in1nit1t.github.io/img/cover/boot2.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://in1nit1t.github.io/2020/03/21/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%BC%95%E5%AF%BC%E5%90%AF%E5%8A%A8%E9%83%A8%E5%88%86%EF%BC%88%E4%BA%8C%EF%BC%89/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Linux内核源码阅读--引导启动部分（二）',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-07 16:20:24'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fas fa-play-circle"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cover/boot2.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">in1t's blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/bangumis/"><i class="fa-fw fas fa-play-circle"></i><span> 番剧</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Linux内核源码阅读--引导启动部分（二）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-03-21T07:57:57.000Z" title="发表于 2020-03-21 15:57:57">2020-03-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-07T08:20:24.028Z" title="更新于 2021-07-07 16:20:24">2021-07-07</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">2.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>9分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>之前也提到，setup.s 的作用是保存一些重要参数，将 system 模块从 0x10000 移到内存地址起始处，设置全局描述符表寄存器及中断描述符表寄存器，打开 A20 地址线，编辑 8259A 芯片，CR0 寄存器 PE 位置 1，跳转至 head.s</p>
<h2 id="保存参数"><a href="#保存参数" class="headerlink" title="保存参数"></a>保存参数</h2><p>其中保存的参数有：</p>
<table>
<thead>
<tr>
<th align="center">内存地址</th>
<th align="center">长度(bytes)</th>
<th align="center">名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0x90000</td>
<td align="center">2</td>
<td align="center">光标位置</td>
<td align="left">光标列号与行号</td>
</tr>
<tr>
<td align="center">0x90002</td>
<td align="center">2</td>
<td align="center">扩展内存数</td>
<td align="left">系统从 1MB 开始的扩展内存数值(KB)</td>
</tr>
<tr>
<td align="center">0x90004</td>
<td align="center">2</td>
<td align="center">显示页面</td>
<td align="left">当前显示页面</td>
</tr>
<tr>
<td align="center">0x90006</td>
<td align="center">1</td>
<td align="center">显示模式</td>
<td align="left">当前显示模式</td>
</tr>
<tr>
<td align="center">0x90007</td>
<td align="center">1</td>
<td align="center">字符列数</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">0x90008</td>
<td align="center">2</td>
<td align="center">??</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">0x9000A</td>
<td align="center">1</td>
<td align="center">显存大小</td>
<td align="left">(0-64k; 1-128k; 2-192k; 3-256k)</td>
</tr>
<tr>
<td align="center">0x9000B</td>
<td align="center">1</td>
<td align="center">显示状态</td>
<td align="left">0-彩色, I/O端口=0x3dX; 1-单色, I/O端口=0x3bX</td>
</tr>
<tr>
<td align="center">0x9000C</td>
<td align="center">2</td>
<td align="center">特性参数</td>
<td align="left">显卡特性</td>
</tr>
<tr>
<td align="center">…</td>
<td align="center">…</td>
<td align="center">…</td>
<td align="left">…</td>
</tr>
<tr>
<td align="center">0x90080</td>
<td align="center">16</td>
<td align="center">硬盘参数表</td>
<td align="left">第一个硬盘的参数表</td>
</tr>
<tr>
<td align="center">0x90090</td>
<td align="center">16</td>
<td align="center">硬盘参数表</td>
<td align="left">第二个硬盘的参数表(如果没有，则清零)</td>
</tr>
<tr>
<td align="center">0x901FC</td>
<td align="center">2</td>
<td align="center">根设备号</td>
<td align="left">根文件系统所在的设备号(bootsect 已经设置好)</td>
</tr>
</tbody></table>
<br>

<p>下面是对实际代码的阅读：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/* Line 17 */</span><br><span class="line">INITSEG  = 0x9000	/* boosect 模块起始地址，现被用于存放内存/显卡等信息 */</span><br><span class="line">SYSSEG   = 0x1000	/* system 模块所在的段地址 */</span><br><span class="line">SETUPSEG = 0x9020	/* 当前 setup 模块段地址 */</span><br><span class="line"></span><br><span class="line">/* Line 21 */</span><br><span class="line">.globl begtext, begdata, begbss, endtext, enddata, endbss</span><br><span class="line">.text</span><br><span class="line">begtext:</span><br><span class="line">.data</span><br><span class="line">begdata:</span><br><span class="line">.bss</span><br><span class="line">begbss:</span><br><span class="line">.text</span><br><span class="line"></span><br><span class="line">/* Line 226 */</span><br><span class="line">.text</span><br><span class="line">endtext:</span><br><span class="line">.data</span><br><span class="line">enddata:</span><br><span class="line">.bss</span><br><span class="line">endbss:</span><br></pre></td></tr></table></figure>

<p>与 bootsect.s 相同，本程序实际上不分段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/* Line 30 */</span><br><span class="line">entry start</span><br><span class="line">start:</span><br><span class="line">	mov	ax,#INITSEG</span><br><span class="line">	mov	ds,ax		/* 将数据段寄存器赋值 0x9000 */</span><br><span class="line">/* 保存光标位置 */</span><br><span class="line">	mov	ah,#0x03	/* 功能号为 3，表示取光标位置 */</span><br><span class="line">	xor	bh,bh		/* 第 0 页 */</span><br><span class="line">	int	0x10		/* 返回值为 DL=列号，DH=行号 */</span><br><span class="line">	mov	[0],dx		/* 存储在 0x90000 */</span><br><span class="line">/* 保存扩展内存的大小(KB) */</span><br><span class="line">	mov	ah,#0x88</span><br><span class="line">	int	0x15</span><br><span class="line">	mov	[2],ax		/* 存储在 0x90002 */</span><br></pre></td></tr></table></figure>
<p>关于 BIOS 0x15 号中断：</p>
<p>功能号 AH = 0x88 表示取系统所含扩展内存的大小，返回值 AX = 从 0x100000 处开始的扩展内存大小，出错则将错误码保存在 AX 中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/* Line 51 */</span><br><span class="line">	mov	ah,#0x0f</span><br><span class="line">	int	0x10</span><br><span class="line">	mov	[4],bx		/* 当前显示页保存在 0x90004 */</span><br><span class="line">	mov	[6],ax		/* 显示模式与字符列数保存在 0x90006 */</span><br><span class="line">/* 检查显示方式(EGA/VGA)，并取参数 */</span><br><span class="line">	mov	ah,#0x12</span><br><span class="line">	mov	bl,#0x10	/* 取 EGA 参数 */</span><br><span class="line">	int	0x10</span><br><span class="line">	mov	[8],ax</span><br><span class="line">	mov	[10],bx		/* 显存大小及显示状态保存在 0x9000A */</span><br><span class="line">	mov	[12],cx		/* 显卡特性参数保存在 0x9000C */</span><br></pre></td></tr></table></figure>
<p>关于 BIOS 0X10 号中断：</p>
<p>功能号 AH = 0x0f 表示取显卡当前显示模式，返回值：</p>
<ul>
<li>AH = 显示窗口的字符列数（window width）</li>
<li>AL = 显示模式</li>
<li>BH = 当前显示页</li>
</ul>
<p>功能号 AH = 0x12，BL = 0x10 表示取 EGA 配置信息，返回值：</p>
<ul>
<li>BH = 显示状态（0-彩色模式, I/O端口=0x3dX; 1-单色模式, I/O端口=0x3bX）</li>
<li>BL = 安装的显存大小（0-64k; 1-128k; 2-192k; 3-256k）</li>
<li>CX = 显卡特性参数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/* Line 67 */</span><br><span class="line">/* 第一个硬盘的参数 */</span><br><span class="line">	mov	ax,#0x0000</span><br><span class="line">	mov	ds,ax			/* ds 指向中断向量表 */</span><br><span class="line">/* LDS reg,mem 意味把 mem 所指的 32 位地址指针的段地址送入 DS,偏移地址送入 reg */</span><br><span class="line">/* 第一个硬盘参数表的地址指针放在 0x41 号中断向量处 */</span><br><span class="line">	lds	si,[4*0x41]		/* 现在 ds:si 指向 hd0 的参数表 */</span><br><span class="line">	mov	ax,#INITSEG</span><br><span class="line">	mov	es,ax</span><br><span class="line">	mov	di,#0x0080</span><br><span class="line">	mov	cx,#0x10	</span><br><span class="line">	rep</span><br><span class="line">	movsb				/* 将 hd0 的参数表拷贝至 0x90080，表长为 16 个字节 */</span><br><span class="line">/* 同理，以下部分在将 hd1 的参数表拷贝至 0x90090 */</span><br><span class="line">	mov	ax,#0x0000</span><br><span class="line">	mov	ds,ax</span><br><span class="line">	lds	si,[4*0x46]		/* 第二个硬盘参数表的地址指针为 0x46 号中断向量 */</span><br><span class="line">	mov	ax,#INITSEG</span><br><span class="line">	mov	es,ax</span><br><span class="line">	mov	di,#0x0090</span><br><span class="line">	mov	cx,#0x10</span><br><span class="line">	rep</span><br><span class="line">	movsb</span><br><span class="line">/* 现在来检查是否有 hd1，没有就将 0x90090 处 16 字节清空 */</span><br><span class="line">	mov	ax,#0x01500		/* 功能号 0x15，表示取磁盘类型 */</span><br><span class="line">	mov	dl,#0x81		/* 要查询第二个硬盘 */</span><br><span class="line">	int	0x13</span><br><span class="line">	jc	no_disk1		/* 没有这个盘就跳去 no_disk1 */</span><br><span class="line">	cmp	ah,#3			/* 如果该磁盘类型为硬盘 */</span><br><span class="line">	je	is_disk1		/* 就不作处理跳到 is_disk1，否则仍将刚才读入的第二硬盘参数表清空 */</span><br><span class="line">no_disk1:				/* 将 0x90090 处 16 字节清空 */</span><br><span class="line">	mov	ax,#INITSEG</span><br><span class="line">	mov	es,ax</span><br><span class="line">	mov	di,#0x0090</span><br><span class="line">	mov	cx,#0x10</span><br><span class="line">	mov	ax,#0x00</span><br><span class="line">	rep</span><br><span class="line">	stosb</span><br><span class="line">is_disk1:</span><br><span class="line">	cli			/* 屏蔽所有外中断，准备进行 system 模块的移位 */</span><br></pre></td></tr></table></figure>

<p>至此，重要参数读完，</p>
<br>

<h2 id="移动-system-amp-设置-GDTR-IDTR"><a href="#移动-system-amp-设置-GDTR-IDTR" class="headerlink" title="移动 system &amp; 设置 GDTR/IDTR"></a>移动 system &amp; 设置 GDTR/IDTR</h2><p>接下来将 system 移到内存起始处，并设置 IDTR 与 GDTR</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">/* Line 113 */</span><br><span class="line">	mov	ax,#0x0000</span><br><span class="line">	cld			/* 将 DF 位置 0，表示后面 movsw 时,si 与 di 向高地址递增 */</span><br><span class="line">do_move:			/* 进入 move 循环 */</span><br><span class="line">	mov	es,ax		/* ax 为上次复制操作的目标段 */</span><br><span class="line">	add	ax,#0x1000	/* 加上 0x1000 */</span><br><span class="line">	cmp	ax,#0x9000	/* 判断是否等于 0x9000 */</span><br><span class="line">	jz	end_move	/* 相等表示移动完毕，跳出循环 */</span><br><span class="line">	mov	ds,ax		/* 否则将下个目标段放在 ds */</span><br><span class="line">	sub	di,di		/* 清空 di,si */</span><br><span class="line">	sub	si,si</span><br><span class="line">	mov cx,#0x8000		/* 循环拷贝 0x8000 次 */</span><br><span class="line">	rep</span><br><span class="line">	movsw			/* 每次拷贝 2 字节，所以一次拷贝 64KB */</span><br><span class="line">	jmp	do_move</span><br><span class="line"></span><br><span class="line">! then we load the segment descriptors</span><br><span class="line"></span><br><span class="line">end_move:</span><br><span class="line">	mov	ax,#SETUPSEG</span><br><span class="line">	mov	ds,ax		/* ds 指向 setup 模块 */</span><br><span class="line">	lidt	idt_48		/* 将 6 字节的 0 载入 IDTR，指向一张空的中断表 */</span><br><span class="line">	lgdt	gdt_48		/* 将 GDT 信息载入 GDTR */</span><br><span class="line"></span><br><span class="line">/* Line 205 */</span><br><span class="line">gdt:				/* 定义了 3 个全局描述符 */</span><br><span class="line">	.word	0,0,0,0		/* 第一个为空描述符 */</span><br><span class="line"></span><br><span class="line">	.word	0x07FF		/* 段界限为 8M */</span><br><span class="line">	.word	0x0000		/* 段基址为 0 */</span><br><span class="line">	.word	0x9A00		/* P=1, DPL=00, S=1, 代码段，只读，可执行 */</span><br><span class="line">	.word	0x00C0		/* G 位为 1，表示颗粒度为 4K */</span><br><span class="line"></span><br><span class="line">	.word	0x07FF		/* 段界限为 8M */</span><br><span class="line">	.word	0x0000		/* 段基址为 0 */</span><br><span class="line">	.word	0x9200		/* P=1, DPL=00, S=1, 数据段，可读可写 */</span><br><span class="line">	.word	0x00C0		/* G 位为 1，表示颗粒度为 4K */</span><br><span class="line">idt_48:</span><br><span class="line">	.word	0		/* idt 界限为 0 */</span><br><span class="line">	.word	0,0		/* idt 基址为 0 */</span><br><span class="line">gdt_48:</span><br><span class="line">	.word	0x800		/* gdt 段限长暂时定为 2KB，能放 256 个描述符 */</span><br><span class="line">	.word	512+gdt,0x9	/* gdt 基址为0x90200 + gdt */</span><br></pre></td></tr></table></figure>

<p>GDTR 与 IDTR 的结构再来回顾一下：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="../img/s1.png" alt="GDTR与IDTR"></p>
<p>描述符结构：</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="../img/s2.png" alt="描述符"></p>
<p>详细的介绍在 <a href="https://in1nit1t.github.io/2020/03/15/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/" target="_blank">保护模式</a> 这篇文章中。</p>
<br>

<h2 id="打开-A20-地址线"><a href="#打开-A20-地址线" class="headerlink" title="打开 A20 地址线"></a>打开 A20 地址线</h2><p>此时 system 已经移到内存开始，下面打开 A20 地址线，需要打开 A20 地址线的原因是实模式下 A20 地址线默认关闭，只能访问 1M 的存储空间，打开后可以访问所有 4G 空间</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/* Line 138 */</span><br><span class="line">	call	empty_8042		/* 反复测试 8042 状态寄存器，判断输入缓冲器是否为空 */</span><br><span class="line">	mov	al,#0xD1		/* 0xD1 命令码表示写数据到 8042 的 P2 端口 */</span><br><span class="line">	out	#0x64,al		/* P2 端口位 1 用于 A20 地址线的选通 */</span><br><span class="line">	call	empty_8042		/* 等待输入缓冲器为空，查看命令是否被接受 */</span><br><span class="line">	mov	al,#0xDF		/* 0xD1 命令码表示打开 A20 地址线 */</span><br><span class="line">	out	#0x60,al		/* 数据写到 0x60 口 */</span><br><span class="line">	call	empty_8042		/* 若此时输入缓冲器为空，表示 A20 已经打开 */</span><br><span class="line"></span><br><span class="line">/* Line 198 */</span><br><span class="line">empty_8042:</span><br><span class="line">	.word	0x00eb,0x00eb		/* 效果类似 nop */</span><br><span class="line">	in	al,#0x64		/* 读 AT 键盘控制器状态寄存器 */</span><br><span class="line">	test	al,#2			/* 测试位 1，判断输入缓冲器是否为空 */</span><br><span class="line">	jnz	empty_8042		/* 若非空，则跳回去循环判断 */</span><br><span class="line">	ret				/* 否则返回 */</span><br></pre></td></tr></table></figure>

<p>0xeb 是近地址跳转的操作码，可以携带一个字节的操作数，故跳转范围在 -127 ~ 127 之间，0x00eb 表示跳转到相对下一条指令偏移值为 0 的指令，相当于继续执行下一条指令，花费的 CPU 时钟周期数是 7~ 10 个，两条就可以造成 14 ~ 20 个时钟周期的延迟，一个 nop 指令只花费 3 个时钟周期数。因为 as86 中没有相应的指令助记符，所以 Linus 直接使用了机器码</p>
<br>

<h2 id="编辑-8259A-芯片"><a href="#编辑-8259A-芯片" class="headerlink" title="编辑 8259A 芯片"></a>编辑 8259A 芯片</h2><p>接下来该对 8259A 芯片重新编程，将硬件中断号设置成从 0x20 开始。PC 机使用两片 8259A，主片的操作端口是 0x20 - 0x21，从片的端口是 0xA0 - 0xA1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/* Line 154 */</span><br><span class="line">	mov	al,#0x11		</span><br><span class="line">	out	#0x20,al		/* 往主片端口发送 0x11 ICW1命令字，表示初始化命令开始 */</span><br><span class="line">	.word	0x00eb,0x00eb		/* nop */</span><br><span class="line">	out	#0xA0,al		/* 再将初始化信号发送给从片 */</span><br><span class="line">	.word	0x00eb,0x00eb</span><br><span class="line">	mov	al,#0x20</span><br><span class="line">	out	#0x21,al		/* 发送主片 ICW2 命令字，设置主片起始中断号为 0x20，要发给奇端口 */</span><br><span class="line">	.word	0x00eb,0x00eb</span><br><span class="line">	mov	al,#0x28</span><br><span class="line">	out	#0xA1,al		/* 发送从片 ICW2 命令字，设置从片起始中断号为 0x28 */</span><br><span class="line">	.word	0x00eb,0x00eb</span><br><span class="line">	mov	al,#0x04</span><br><span class="line">	out	#0x21,al		/* 发送主片 ICW3 命令字，表示主片 IR2 连接从片 INT */</span><br><span class="line">	.word	0x00eb,0x00eb</span><br><span class="line">	mov	al,#0x02</span><br><span class="line">	out	#0xA1,al		/* 发送从片 ICW3 命令字，表示从片 INT 连接主片 IR2 */</span><br><span class="line">	.word	0x00eb,0x00eb</span><br><span class="line">	mov	al,#0x01</span><br><span class="line">	out	#0x21,al		/* 发送主片 ICW4 命令字，8086 模式 */</span><br><span class="line">	.word	0x00eb,0x00eb</span><br><span class="line">	out	#0xA1,al		/* 发送从片 ICW4 命令字，8086 模式，初始化结束，芯片就绪 */</span><br><span class="line">	.word	0x00eb,0x00eb</span><br><span class="line">	mov	al,#0xFF</span><br><span class="line">	out	#0x21,al		/* 屏蔽主片所有中断请求 */</span><br><span class="line">	.word	0x00eb,0x00eb</span><br><span class="line">	out	#0xA1,al		/* 屏蔽从片所有中断请求 */</span><br></pre></td></tr></table></figure>

<br>

<h2 id="进入保护模式"><a href="#进入保护模式" class="headerlink" title="进入保护模式"></a>进入保护模式</h2><p>然后是 setup.s 最后部分，PE 置位，进入保护模式，结束连 Linus 都觉得无聊的与 BIOS、硬件等打交道的过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/* Line 191 */</span><br><span class="line">	mov	ax,#0x0001</span><br><span class="line">	lmsw	ax		/* 将 CR0 PE 位置 1 */</span><br><span class="line">	jmpi	0,8		/* 跳转至 head.s 执行  */</span><br></pre></td></tr></table></figure>

<p>lmsw 指令意为置处理器状态字，只有操作数的低 4 位被存入 CR0，该指令仅兼容 286 的 CPU，386 以上的 CPU 应该使用 “mov cr0, ax” 切换到保护模式。同时在设置 PE 位后，随后的一条指令<strong>必须是段间跳转指令</strong>，以刷新 CPU 提前从内存取出并解码的实模式指令队列</p>
<p>执行最后一条跳转指令时，已处于保护模式，操作数 8 为段选择子，16 位二进制形式为 0b0000 0000 0000 1000，最低两位为 RPL，0 表示内核级，第三位为 TI 位，0 表示从 GDT 中选择描述符，其余高位为索引，这里是 1，表示选择第 2 项。另一个操作数 0，表示段内偏移量为 0。GDT 中第二项偏移 0，指向物理地址起始位置，该处为 head 模块。还记得段选择子结构吗？</p>
<p><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="../img/s3.png" alt="选择子"></p>
<p>关于键盘控制器 8042 与 8259A 芯片的编程方法有必要时再专门记录在另一篇文章中</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">in1t</a></span></div><div class="post-cover__authorid"><span class="post-copyright-meta">封面画师: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://www.pixiv.net/users/9790122">9790122</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://in1nit1t.github.io/2020/03/21/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%BC%95%E5%AF%BC%E5%90%AF%E5%8A%A8%E9%83%A8%E5%88%86%EF%BC%88%E4%BA%8C%EF%BC%89/">http://in1nit1t.github.io/2020/03/21/Linux内核源码阅读-引导启动部分（二）/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://in1nit1t.github.io" target="_blank">in1t's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><a class="post-meta__tags" href="/tags/Linux0-11/">Linux0.11</a></div><div class="post_share"><div class="social-share" data-image="/img/cover/boot2.jpg" data-sites="wechat,qq,weibo,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/03/22/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%BC%95%E5%AF%BC%E5%90%AF%E5%8A%A8%E9%83%A8%E5%88%86%EF%BC%88%E4%B8%89%EF%BC%89/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/boot3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux内核源码阅读--引导启动部分（三）</div></div></a></div><div class="next-post pull-right"><a href="/2020/03/20/Linux%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%BC%95%E5%AF%BC%E5%90%AF%E5%8A%A8%E9%83%A8%E5%88%86%EF%BC%88%E4%B8%80%EF%BC%89/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/boot1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Linux内核源码阅读--引导启动部分（一）</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/04/11/Linux内核源码阅读-kernel（三）/" title="Linux内核源码阅读-kernel（三）"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/kernel3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-11</div><div class="title">Linux内核源码阅读-kernel（三）</div></div></a></div><div><a href="/2020/04/27/Linux内核源码阅读-mm/" title="Linux内核源码阅读-mm"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/mmmodule.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-27</div><div class="title">Linux内核源码阅读-mm</div></div></a></div><div><a href="/2020/04/13/Linux内核源码阅读-kernel（四）/" title="Linux内核源码阅读-kernel（四）"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/cover/kernel4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-13</div><div class="title">Linux内核源码阅读-kernel（四）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E5%8F%82%E6%95%B0"><span class="toc-number">1.</span> <span class="toc-text">保存参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%BB%E5%8A%A8-system-amp-%E8%AE%BE%E7%BD%AE-GDTR-IDTR"><span class="toc-number">2.</span> <span class="toc-text">移动 system &amp; 设置 GDTR&#x2F;IDTR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E5%BC%80-A20-%E5%9C%B0%E5%9D%80%E7%BA%BF"><span class="toc-number">3.</span> <span class="toc-text">打开 A20 地址线</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%BE%91-8259A-%E8%8A%AF%E7%89%87"><span class="toc-number">4.</span> <span class="toc-text">编辑 8259A 芯片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.</span> <span class="toc-text">进入保护模式</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('/img/cover/boot2.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By in1t</div><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-orange?style=flat&logo=bitdefender" title="主题采用butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Source-Github-brightgreen?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a><a style="margin-inline:5px" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);</script><div class="js-pjax"></div><script defer src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script defer src="/js/modify.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="💐,🌸,💮,🏵,🌹,🥀,🌺,🌻,🌼,🌷,🌱,🌲,🌳,🌴,🌵,🌾,🌿,☘,🍀,🍁,🍂,🍃,🍇,🍈,🍉,🍊,🍋,🍌,🍍,🍎,🍏,🍐,🍑,🍒,🍓,🥝,🍅,🥥,🥑,🍆,🥔,🥕,🌽,🌶,🥒,🥬,🥦,🧄,🧅,🍄,🥜,🌰,🍞,🥐,🥖,🥨,🥯,🥞,🧇,🧀,🍖,🍗,🥩,🥓,🍔,🍟,🍕,🌭,🥪,🌮,🌯,🥙,🧆,🥚,🍳,🥘,🍲,🥣,🥗,🍿,🧈,🧂,🥫,🍱,🍘,🍙,🍚,🍛,🍜,🍠,🍢,🍣,🍤,🍥,🥮,🍡,🥟,🥠,🥡,🦪,🍨,🍩,🍪,🎂,🍰,🧁,🥧,🍫,🍬,🍭,🍮,🍯,🍼,🥛,☕,🍵,🍶,🍾,🍷,🍹,🍻,🥂,🥃,🥤,🧃,🧉,🧊,🥢,🍽,🥄" data-fontsize="20px" data-random="false" async="async"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":20,"vOffset":-65},"mobile":{"show":false},"react":{"opacity":0.7},"log":false});</script></body></html>